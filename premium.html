<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Premium - AI-Powered Audioguides" />
    <meta property="og:description" content="Create premium audioguides with Claude AI and Speechify" />
    <title>CloudGuide Premium - Claude AI & Speechify</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #48bb78;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 35px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .panel-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 25px;
            color: #2d3748;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #f7fafc;
            transition: all 0.3s;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        textarea.form-element {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-element {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            padding-right: 45px;
        }

        /* Advanced Settings */
        .advanced-settings {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        /* Voice Selection */
        .voice-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: white;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
            color: #2d3748;
        }

        .voice-details {
            font-size: 12px;
            color: #718096;
        }

        /* Generated Content Section */
        .content-display {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        .content-display:empty::before {
            content: 'Generated content will appear here...';
            color: #a0aec0;
            font-style: italic;
            font-family: 'Nunito Sans', sans-serif;
        }

        /* Progress Indicator */
        .progress-section {
            display: none;
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.5s;
        }

        .progress-text {
            text-align: center;
            color: #718096;
            font-size: 13px;
        }

        /* Audio Player Section */
        .audio-player-section {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-top: 30px;
        }

        .audio-player-section.active {
            display: block;
        }

        .custom-audio-player {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #48bb78;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .play-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        .audio-progress {
            flex: 1;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

: 768px) {
            .nav-links {
                display: none;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .voice-selection {
                grid-template-columns: 1fr;
            }
            
            .panel {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html">AUDIO</a></li>
                        <li><a href="premium.html" style="color: #48bb78;">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-layout">
            <!-- Claude AI Content Generation -->
            <div class="panel">
                <h2 class="panel-title">üöÄ Enhanced Batch Generation</h2>

                <div class="form-group">
                    <label for="destination">Destination / Topic</label>
                    <input type="text" id="destination" class="form-element" placeholder="e.g., Hong Kong, Tokyo, Paris, New York City...">
                </div>

                <div class="form-group">
                    <label for="guideType">Guide Type</label>
                    <select id="guideType" class="form-element">
                        <option value="museum">Museum/Indoor Guide</option>
                        <option value="city">City/Outdoor Guide</option>
                        <option value="trail">Nature Trail/Hiking Guide</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="audienceType">Target Audience</label>
                    <select id="audienceType" class="form-element">
                        <option value="general">General Visitors</option>
                        <option value="experts">History Enthusiasts</option>
                        <option value="families">Families with Children</option>
                        <option value="students">Students & Educators</option>
                        <option value="vip">VIP Tours</option>
                        <option value="accessibility">Accessibility Focus</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contentStyle">Content Style</label>
                    <select id="contentStyle" class="form-element">
                        <option value="storytelling">Immersive Storytelling</option>
                        <option value="educational">Educational & Informative</option>
                        <option value="conversational">Casual & Conversational</option>
                        <option value="dramatic">Dramatic & Theatrical</option>
                        <option value="poetic">Poetic & Evocative</option>
                        <option value="humorous">Light & Humorous</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="websiteRefs">Information Sources (Optional)</label>
                    <div id="websiteRefsContainer">
                        <div class="website-ref-input">
                            <input type="url" class="form-element website-url" placeholder="https://official-tourism-site.com or https://museum-website.org">
                            <button type="button" class="btn btn-secondary add-website-btn" onclick="addWebsiteRef()">+</button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #718096; margin-top: 8px;">
                        üîç Add official websites, tourism sites, or sources with must-have information for your audioguide
                    </div>
                </div>

                <div class="form-group">
                    <label for="customPrompt">Custom Instructions (Optional)</label>
                    <textarea id="customPrompt" class="form-element" placeholder="Add specific requirements, focus areas, or special instructions..."></textarea>
                </div>

                <div class="advanced-settings">
                    <h4 style="margin-bottom: 15px; color: #4a5568; font-size: 13px;">‚öôÔ∏è BATCH SETTINGS</h4>
                    <div class="settings-grid">
                        <div class="form-group" style="margin: 0;">
                            <label for="numStops">Total Stops</label>
                            <select id="numStops" class="form-element">
                                <option value="4">4 Stops (1 batch)</option>
                                <option value="8">8 Stops (2 batches)</option>
                                <option value="12">12 Stops (3 batches)</option>
                                <option value="16">16 Stops (4 batches)</option>
                                <option value="20">20 Stops (5 batches)</option>
                                <option value="24">24 Stops (6 batches)</option>
                                <option value="28">28 Stops (7 batches)</option>
                                <option value="30">30 Stops (8 batches)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="stopLength">Words per Stop</label>
                            <select id="stopLength" class="form-element">
                                <option value="600">~600 words</option>
                                <option value="750">~750 words</option>
                                <option value="900" selected>~900 words (Optimal)</option>
                                <option value="1000">~1000 words</option>
                                <option value="1200">~1200 words</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px; margin-bottom: 0;">
                        <label for="claudeModel">Claude Model</label>
                        <select id="claudeModel" class="form-element" onchange="updateModelInfo()">
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended) üíé</option>
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Budget) üí∞</option>
                            <option value="claude-opus-4-20250805">Claude Opus 4 (Maximum Quality) ‚≠ê</option>
                        </select>
                        <div id="modelInfo" style="font-size: 12px; margin-top: 8px; padding: 10px; border-radius: 4px;">
                            <strong>Claude Sonnet 4:</strong> Best balance ‚Ä¢ Advanced reasoning ‚Ä¢ High quality ‚Ä¢ Reasonable cost
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="generateWithClaude()">
                    üöÄ Start Batch Generation
                </button>

                <div class="progress-section" id="claudeProgress">
                    <div class="progress-text">Batch generation in progress...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="claudeProgressBar"></div>
                    </div>
                    <div class="progress-text" id="claudeStatus">Initializing...</div>
                </div>

                <div class="content-display" id="generatedContent"></div>
            </div>

            <!-- Audio Generation -->
            <div class="panel">
                <h2 class="panel-title">üéôÔ∏è Premium Audio Generation</h2>

                <div class="form-group">
                    <label>Select Voice</label>
                    <div class="voice-selection">
                        <div class="voice-card selected" onclick="selectVoice(this, 'snoop')">
                            <div class="voice-name">Snoop Dogg</div>
                            <div class="voice-details">Celebrity Voice</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'gwyneth')">
                            <div class="voice-name">Gwyneth Paltrow</div>
                            <div class="voice-details">Celebrity Voice</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'david')">
                            <div class="voice-name">David Attenborough</div>
                            <div class="voice-details">Documentary</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'james')">
                            <div class="voice-name">James Earl Jones</div>
                            <div class="voice-details">Narrator</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="speechSpeed">Speech Speed</label>
                    <input type="range" id="speechSpeed" class="form-element" min="0.5" max="1.5" value="1.0" step="0.1">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #718096;">
                        <span>Slow (0.5x)</span>
                        <span id="speedValue">1.0x</span>
                        <span>Fast (1.5x)</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="voiceLanguage">Language</label>
                    <select id="voiceLanguage" class="form-element">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese</option>
                        <option value="zh-CN">Chinese</option>
                        <option value="ja-JP">Japanese</option>
                    </select>
                </div>

                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 15px; margin: 20px 0; font-size: 13px;">
                    <strong>üí° Large Audio Files:</strong><br>
                    30-stop audioguides create ~45-60 minute audio files. Generation may take several minutes.
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="generateWithSpeechify()">
                    üéµ Generate Large Audio
                </button>

                <div class="progress-section" id="speechifyProgress">
                    <div class="progress-text">Generating audio...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="speechifyProgressBar"></div>
                    </div>
                    <div class="progress-text" id="speechifyStatus">Processing...</div>
                </div>
            </div>
        </div>

        <!-- Audio Player Section -->
        <div class="audio-player-section" id="audioPlayerSection">
            <h2 class="panel-title">üéµ Premium Audio Player</h2>
            <div class="custom-audio-player">
                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂Ô∏è</button>
                    <div class="audio-progress">
                        <input type="range" id="audioProgress" class="form-element" min="0" max="100" value="0">
                        <div class="audio-time">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="downloadAudio()">üì• Download Audio</button>
                    <button class="btn btn-secondary" onclick="downloadScript()">üìÑ Download Script</button>
                    <button class="btn btn-secondary" onclick="downloadPDF()">üìÑ Download PDF</button>
                    <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Download Data</button>
                    <button class="btn btn-primary" onclick="saveToLibrary()">üíæ Save to Library</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3 style="color: #2d3748; margin-bottom: 10px;">Creating Your Audioguide</h3>
                <p style="color: #718096;" id="loadingStatus">Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Premium CloudGuide JavaScript with Batch Generation
        // Global variables
        let selectedVoice = 'snoop';
        let generatedContent = '';
        let audioUrl = null;
        let currentAudio = null;

        // Batch generation state
        let batchState = {
            isGenerating: false,
            targetStops: 0,
            completedStops: 0,
            currentBatch: 1,
            totalBatches: 0,
            allContent: [],
            destination: '',
            settings: {}
        };

        console.log('Enhanced script loaded with batch generation');

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Update speed display
            const speedSlider = document.getElementById('speechSpeed');
            if (speedSlider) {
                speedSlider.addEventListener('input', function() {
                    document.getElementById('speedValue').textContent = this.value + 'x';
                });
                console.log('Speed slider initialized');
            }
            
            // Update stop count display
            const stopSelect = document.getElementById('numStops');
            if (stopSelect) {
                stopSelect.addEventListener('change', function() {
                    updateBatchInfo();
                });
                updateBatchInfo(); // Initial update
            }
            
            console.log('Enhanced initialization complete');
        });

        // Update model information display
        function updateModelInfo() {
            const model = document.getElementById('claudeModel').value;
            const infoDiv = document.getElementById('modelInfo');
            
            if (model.includes('sonnet-4')) {
                infoDiv.innerHTML = '<strong>üíé Claude Sonnet 4:</strong> Best balance ‚Ä¢ Advanced reasoning ‚Ä¢ High quality ‚Ä¢ Reasonable cost';
                infoDiv.style.background = '#fef3c7';
                infoDiv.style.color = '#92400e';
                infoDiv.style.border = '1px solid #fbbf24';
            } else if (model.includes('3-5-sonnet')) {
                infoDiv.innerHTML = '<strong>üí∞ Claude 3.5 Sonnet:</strong> Budget option ‚Ä¢ Fast generation ‚Ä¢ Good quality ‚Ä¢ Lowest cost';
                infoDiv.style.background = '#f0fff4';
                infoDiv.style.color = '#22543d';
                infoDiv.style.border = '1px solid #c6f6d5';
            } else if (model.includes('opus-4')) {
                infoDiv.innerHTML = '<strong>‚≠ê Claude Opus 4:</strong> Maximum quality ‚Ä¢ Best reasoning ‚Ä¢ Premium features ‚Ä¢ Higher cost';
                infoDiv.style.background = '#fef2f2';
                infoDiv.style.color = '#7f1d1d';
                infoDiv.style.border = '1px solid #fecaca';
            }
        }

        // Update batch information display
        function updateBatchInfo() {
            const numStops = parseInt(document.getElementById('numStops').value);
            const batchSize = 4;
            const numBatches = Math.ceil(numStops / batchSize);
            
            // Add batch info to the interface
            let batchInfoDiv = document.getElementById('batchInfo');
            if (!batchInfoDiv) {
                batchInfoDiv = document.createElement('div');
                batchInfoDiv.id = 'batchInfo';
                batchInfoDiv.style.cssText = `
                    background: #e6fffa;
                    border: 1px solid #38b2ac;
                    border-radius: 6px;
                    padding: 15px;
                    margin-top: 15px;
                    font-size: 13px;
                    color: #234e52;
                `;
                
                const advancedSettings = document.querySelector('.advanced-settings');
                if (advancedSettings) {
                    advancedSettings.appendChild(batchInfoDiv);
                }
            }
            
            batchInfoDiv.innerHTML = `
                <strong>üìä Batch Generation Info:</strong><br>
                ‚Ä¢ Total Stops: ${numStops}<br>
                ‚Ä¢ Batches: ${numBatches} (4 stops each)<br>
                ‚Ä¢ Estimated Time: ~${numBatches} minutes<br>
                ‚Ä¢ Rate Limit Safe: ‚úÖ
            `;
        }

        // Select voice
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Enhanced generate function with batch processing
        async function generateWithClaude() {
            console.log('generateWithClaude called (enhanced version)');
            
            const destination = document.getElementById('destination').value;
            console.log('Destination:', destination);
            
            if (!destination) {
                console.log('No destination entered');
                showMessage('Please enter a destination or topic', 'error');
                return;
            }

            // Get website references
            const websiteRefs = getWebsiteReferences();
            const selectedModel = document.getElementById('claudeModel').value;
            console.log('Website references:', websiteRefs);
            console.log('Selected model:', selectedModel);

            // Get all form values
            const guideType = document.getElementById('guideType').value;
            const audience = document.getElementById('audienceType').value;
            const style = document.getElementById('contentStyle').value;
            const customPrompt = document.getElementById('customPrompt').value;
            const numStops = parseInt(document.getElementById('numStops').value);
            const stopLength = parseInt(document.getElementById('stopLength').value);

            // Initialize batch state
            batchState = {
                isGenerating: true,
                targetStops: numStops,
                completedStops: 0,
                currentBatch: 1,
                totalBatches: Math.ceil(numStops / 4),
                allContent: [],
                destination: destination,
                settings: {
                    guideType,
                    audience,
                    style,
                    customPrompt,
                    stopLength,
                    websiteRefs,
                    selectedModel
                }
            };

            console.log('Starting batch generation:', batchState);

            // Update UI for batch mode
            const generateButton = document.querySelector('[onclick*="generateWithClaude"]');
            generateButton.textContent = 'GENERATING... (BATCH MODE)';
            generateButton.disabled = true;

            // Show progress
            document.getElementById('claudeProgress').classList.add('active');
            updateProgress('claude', 5, `Starting batch generation (${batchState.totalBatches} batches)`);

            // Clear previous content
            document.getElementById('generatedContent').textContent = '';
            generatedContent = '';

            try {
                await generateNextBatch();
            } catch (error) {
                console.error('Batch generation failed:', error);
                resetBatchState();
                showMessage('Batch generation failed: ' + error.message, 'error');
            }
        }

        // Generate the next batch of stops
        async function generateNextBatch() {
            const stopsRemaining = batchState.targetStops - batchState.completedStops;
            const stopsInThisBatch = Math.min(4, stopsRemaining);
            
            console.log(`Generating batch ${batchState.currentBatch}/${batchState.totalBatches} (${stopsInThisBatch} stops)`);
            
            const progressBase = ((batchState.currentBatch - 1) / batchState.totalBatches) * 90;
            updateProgress('claude', progressBase + 10, 
                `Batch ${batchState.currentBatch}/${batchState.totalBatches} - Connecting to AI...`);

            // Create batch-specific prompt
            const batchPrompt = createBatchPrompt(stopsInThisBatch);
            
            const requestBody = {
                destination: batchState.destination,
                guideType: batchState.settings.guideType,
                audience: batchState.settings.audience,
                style: batchState.settings.style,
                customPrompt: batchPrompt,
                numStops: stopsInThisBatch,
                stopLength: batchState.settings.stopLength,
                websiteRefs: batchState.settings.websiteRefs || [],
                preferredModel: batchState.settings.selectedModel
            };
            
            console.log('Batch request:', requestBody);

            try {
                updateProgress('claude', progressBase + 25, 
                    `Batch ${batchState.currentBatch}/${batchState.totalBatches} - Generating content...`);

                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Batch API response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Batch API error:', errorData);
                    
                    if (errorData.error && errorData.error.includes('rate limit')) {
                        console.log('Rate limit in batch, waiting...');
                        await handleRateLimit();
                        return; // Will retry after rate limit
                    }
                    
                    throw new Error(errorData.error || `API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Batch API response received');
                
                // Process the batch content
                const batchContent = data.rawContent || data.content;
                batchState.allContent.push(batchContent);
                batchState.completedStops += stopsInThisBatch;
                
                updateProgress('claude', progressBase + 80, 
                    `Batch ${batchState.currentBatch}/${batchState.totalBatches} completed (${batchState.completedStops}/${batchState.targetStops} stops)`);

                // Update display with accumulated content
                const combinedContent = batchState.allContent.join('\n\n' + '='.repeat(50) + '\n\n');
                document.getElementById('generatedContent').textContent = combinedContent;
                generatedContent = combinedContent;

                showMessage(`Batch ${batchState.currentBatch} completed! (${batchState.completedStops}/${batchState.targetStops} stops)`, 'success');

                // Check if we need more batches
                if (batchState.completedStops < batchState.targetStops) {
                    batchState.currentBatch++;
                    
                    // Wait 60 seconds before next batch to respect rate limits
                    updateProgress('claude', progressBase + 85, 
                        `Waiting 60 seconds before next batch...`);
                    
                    showMessage('Waiting 60 seconds before next batch to respect rate limits...', 'info');
                    
                    // Show countdown
                    let countdown = 60;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        updateProgress('claude', progressBase + 85, 
                            `Next batch in ${countdown} seconds... (${batchState.completedStops}/${batchState.targetStops} stops)`);
                        
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            generateNextBatch(); // Continue with next batch
                        }
                    }, 1000);
                } else {
                    // All batches complete!
                    completeBatchGeneration();
                }

            } catch (error) {
                console.error('Batch generation error:', error);
                throw error;
            }
        }

        // Create batch-specific prompt
        function createBatchPrompt(stopsInBatch) {
            const startStop = batchState.completedStops + 1;
            const endStop = batchState.completedStops + stopsInBatch;
            const guideType = batchState.settings.guideType;
            
            let contextPrompt = batchState.settings.customPrompt;
            
            // Add city-specific requirements
            if (guideType === 'city') {
                contextPrompt += `\n\nCITY GUIDE REQUIREMENTS: For city guides, always include:
- INTRODUCTION: Overview of the city's character and significance
- HISTORY: Key historical periods and events that shaped the city
- LOCAL TIPS: Practical advice for visitors (transport, customs, best times to visit)
- MUST EATS: Essential local foods, dishes, and where to find them
- Cultural insights and local traditions`;
            }
            
            // Add website references to prompt
            if (batchState.settings.websiteRefs && batchState.settings.websiteRefs.length > 0) {
                contextPrompt += `\n\nIMPORTANT INFORMATION SOURCES: Please reference and include key information from these official sources: ${batchState.settings.websiteRefs.join(', ')}. Use these sources to ensure accuracy and include must-have facts, opening hours, ticket prices, and official details.`;
            }
            
            if (batchState.currentBatch > 1) {
                contextPrompt += `\n\nCONTEXT: This is batch ${batchState.currentBatch} of a ${batchState.targetStops}-stop audioguide. `;
                contextPrompt += `Previous batches covered stops 1-${batchState.completedStops}. `;
                contextPrompt += `Now generate stops ${startStop}-${endStop}, ensuring they complement and continue from the previous stops without repetition.`;
            } else {
                contextPrompt += `\n\nThis is the first batch of a ${batchState.targetStops}-stop audioguide. Generate stops ${startStop}-${endStop}.`;
                
                // For first batch of city guides, emphasize the requirements
                if (guideType === 'city') {
                    contextPrompt += ` Make sure to include introduction, history, tips, and must eats in the early stops.`;
                }
            }
            
            return contextPrompt;
        }

        // Handle rate limit with automatic retry
        async function handleRateLimit() {
            updateProgress('claude', 
                ((batchState.currentBatch - 1) / batchState.totalBatches) * 90 + 30, 
                'Rate limit reached. Waiting 60 seconds...');
            
            showMessage('Rate limit reached. Automatically retrying in 60 seconds...', 'info');
            
            let countdown = 60;
            const countdownInterval = setInterval(() => {
                countdown--;
                updateProgress('claude', 
                    ((batchState.currentBatch - 1) / batchState.totalBatches) * 90 + 30, 
                    `Rate limit - Retrying batch ${batchState.currentBatch} in ${countdown} seconds...`);
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    generateNextBatch(); // Retry current batch
                }
            }, 1000);
        }

        // Complete batch generation
        function completeBatchGeneration() {
            console.log('All batches completed!');
            
            updateProgress('claude', 100, `All ${batchState.targetStops} stops generated successfully!`);
            
            showMessage(`üéâ Complete! Generated ${batchState.targetStops} stops in ${batchState.totalBatches} batches`, 'success');
            
            // Add final summary
            const wordCount = generatedContent.split(/\s+/).length;
            const summaryContent = `
COMPLETE AUDIOGUIDE: ${batchState.destination.toUpperCase()}
===================================================
‚úÖ Generated: ${batchState.completedStops} stops
üìä Batches: ${batchState.totalBatches}
üìù Word Count: ${wordCount.toLocaleString()} words
‚è±Ô∏è Est. Duration: ~${Math.round(wordCount * 0.5 / 60)} minutes
üéØ Style: ${batchState.settings.style}
üë• Audience: ${batchState.settings.audience}
üìç Type: ${batchState.settings.guideType}
===================================================

${generatedContent}
`;
            
            document.getElementById('generatedContent').textContent = summaryContent;
            generatedContent = summaryContent;
            
            // Reset UI
            setTimeout(() => {
                document.getElementById('claudeProgress').classList.remove('active');
                resetBatchState();
            }, 3000);
        }

        // Reset batch state and UI
        function resetBatchState() {
            batchState.isGenerating = false;
            
            const generateButton = document.querySelector('[onclick*="generateWithClaude"]');
            generateButton.textContent = 'üöÄ Start Batch Generation';
            generateButton.disabled = false;
        }

        // Generate audio with Speechify (enhanced for large content)
        async function generateWithSpeechify() {
            if (!generatedContent) {
                showMessage('Please generate content first', 'error');
                return;
            }

            // Check content length
            const wordCount = generatedContent.split(/\s+/).length;
            if (wordCount > 10000) {
                const confirm = window.confirm(`This is a large audioguide (${Math.round(wordCount/1000)}k words). Audio generation may take several minutes. Continue?`);
                if (!confirm) return;
            }

            const speed = document.getElementById('speechSpeed').value;
            const language = document.getElementById('voiceLanguage').value;

            // Show progress
            document.getElementById('speechifyProgress').classList.add('active');
            updateProgress('speechify', 10, 'Preparing large audio generation...');

            try {
                updateProgress('speechify', 30, `Processing ${Math.round(wordCount/1000)}k words with Speechify...`);

                const response = await fetch('/api/speechify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: generatedContent,
                        voice: selectedVoice,
                        language: language,
                        speed: parseFloat(speed),
                        pitch: 1.0,
                        volume: 1.0
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Audio generation failed');
                }

                const data = await response.json();
                updateProgress('speechify', 90, 'Finalizing audio...');

                if (data.audioUrl) {
                    audioUrl = data.audioUrl;
                    document.getElementById('audioPlayerSection').classList.add('active');
                    
                    if (!currentAudio) {
                        currentAudio = new Audio();
                    }
                    currentAudio.src = audioUrl;
                    
                    updateProgress('speechify', 100, 'Large audio file generated successfully!');
                    showMessage(`üéµ Audio generated! (~${Math.round(wordCount * 0.5 / 60)} minutes)`, 'success');
                }

                setTimeout(() => {
                    document.getElementById('speechifyProgress').classList.remove('active');
                }, 2000);

            } catch (error) {
                console.error('Speechify API Error:', error);
                showMessage('Error: ' + error.message, 'error');
                document.getElementById('speechifyProgress').classList.remove('active');
            }
        }

        // Update progress
        function updateProgress(type, percentage, status) {
            const progressBar = document.getElementById(type + 'ProgressBar');
            const statusText = document.getElementById(type + 'Status');
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (statusText) statusText.textContent = status;
        }

        // Enhanced save to library with batch info
        function saveToLibrary() {
            if (!generatedContent) {
                showMessage('No content to save', 'error');
                return;
            }
            
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const wordCount = generatedContent.split(/\s+/).length;
            
            const newGuide = {
                id: Date.now(),
                title: document.getElementById('destination').value,
                content: generatedContent,
                type: 'premium-batch',
                createdWith: 'Premium Batch Generator',
                date: new Date().toISOString(),
                location: document.getElementById('destination').value,
                language: document.getElementById('voiceLanguage').value,
                stops: batchState.targetStops || document.getElementById('numStops').value,
                tourType: document.getElementById('guideType').value,
                wordCount: wordCount,
                estimatedDuration: Math.round(wordCount * 0.5 / 60) // rough estimate in minutes
            };
            
            audioguides.unshift(newGuide);
            localStorage.setItem('cloudguide_audioguides', JSON.stringify(audioguides));
            
            showMessage(`üíæ Saved! ${newGuide.stops} stops, ${Math.round(wordCount/1000)}k words`, 'success');
        }

        // Toggle audio playback
        function togglePlayback() {
            const playBtn = document.getElementById('playBtn');
            
            if (!currentAudio) {
                if (!audioUrl) {
                    showMessage('No audio to play', 'error');
                    return;
                }
                currentAudio = new Audio(audioUrl);
            }
            
            if (currentAudio.paused) {
                currentAudio.play();
                playBtn.textContent = '‚è∏Ô∏è';
            } else {
                currentAudio.pause();
                playBtn.textContent = '‚ñ∂Ô∏è';
            }
        }

        // Download functions
        function downloadAudio() {
            if (!audioUrl) {
                showMessage('No audio to download', 'error');
                return;
            }
            
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = `${document.getElementById('destination').value.replace(/\s+/g, '_')}_audioguide.mp3`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage('üì• Downloading audio...', 'info');
        }

        function downloadScript() {
            if (!generatedContent) {
                showMessage('No script to download', 'error');
                return;
            }
            
            const blob = new Blob([generatedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${document.getElementById('destination').value.replace(/\s+/g, '_')}_script.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const wordCount = generatedContent.split(/\s+/).length;
            showMessage(`üìÑ Script downloaded! (${Math.round(wordCount/1000)}k words)`, 'success');
        }

        function downloadPDF() {
            if (!generatedContent) {
                showMessage('No content to download as PDF', 'error');
                return;
            }
            
            // Create a formatted HTML version for PDF conversion
            const destination = document.getElementById('destination').value;
            const wordCount = generatedContent.split(/\s+/).length;
            const modelInfo = batchState.targetStops ? 
                `Generated with ${batchState.totalBatches} batches using ${batchState.settings.selectedModel || 'Claude Sonnet 4'}` :
                'Generated with Claude AI';
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${destination} - CloudGuide Premium</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; color: #333; }
                        h1 { color: #2d3748; border-bottom: 3px solid #48bb78; padding-bottom: 10px; }
                        .meta { background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        .stop { margin: 30px 0; page-break-inside: avoid; }
                        .stop-title { font-size: 18px; font-weight: bold; color: #2d3748; margin-bottom: 15px; }
                        .stop-content { text-align: justify; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>${destination.toUpperCase()} - PREMIUM AUDIOGUIDE</h1>
                    <div class="meta">
                        <strong>CloudGuide Premium</strong><br>
                        ${modelInfo}<br>
                        Word Count: ${wordCount.toLocaleString()} words<br>
                        Generated: ${new Date().toLocaleString()}<br>
                        Website: www.cloudguide.me
                    </div>
                    <div>${generatedContent.replace(/\n/g, '<br>').replace(/STOP (\d+): ([^\n]+)/g, '<div class="stop"><div class="stop-title">STOP $1: $2</div><div class="stop-content">')}</div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${destination.replace(/\s+/g, '_')}_audioguide.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('üìÑ HTML file downloaded! Open in browser and print to PDF', 'success');
        }

        function downloadJSON() {
            if (!generatedContent) {
                showMessage('No data to download', 'error');
                return;
            }
            
            const destination = document.getElementById('destination').value;
            const wordCount = generatedContent.split(/\s+/).length;
            
            // Parse content into structured data
            const stops = [];
            const lines = generatedContent.split('\n');
            let currentStop = null;
            
            for (const line of lines) {
                if (line.match(/^STOP \d+:/)) {
                    if (currentStop) {
                        stops.push(currentStop);
                    }
                    const match = line.match(/^STOP (\d+): (.+)$/);
                    currentStop = {
                        number: parseInt(match[1]),
                        title: match[2],
                        content: ''
                    };
                } else if (currentStop && line.trim()) {
                    currentStop.content += line + '\n';
                }
            }
            
            if (currentStop) {
                stops.push(currentStop);
            }
            
            const jsonData = {
                title: destination,
                type: 'premium-audioguide',
                metadata: {
                    destination: destination,
                    totalStops: stops.length,
                    wordCount: wordCount,
                    estimatedDuration: Math.round(wordCount * 0.5 / 60),
                    guideType: document.getElementById('guideType').value,
                    audience: document.getElementById('audienceType').value,
                    style: document.getElementById('contentStyle').value,
                    model: batchState.settings ? batchState.settings.selectedModel : 'claude-sonnet-4',
                    generated: new Date().toISOString(),
                    creator: 'CloudGuide Premium'
                },
                stops: stops,
                rawContent: generatedContent
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${destination.replace(/\s+/g, '_')}_audioguide.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`üíæ JSON data downloaded! (${stops.length} stops structured)`, 'success');
        }

        // Website references functions
        function addWebsiteRef() {
            const container = document.getElementById('websiteRefsContainer');
            const newInput = document.createElement('div');
            newInput.className = 'website-ref-input';
            newInput.innerHTML = `
                <input type="url" class="form-element website-url" placeholder="https://official-website.com/must-have-info">
                <button type="button" class="btn remove-website-btn" onclick="removeWebsiteRef(this)">‚àí</button>
            `;
            container.appendChild(newInput);
            updateWebsiteRefsList();
        }

        function removeWebsiteRef(button) {
            button.parentElement.remove();
            updateWebsiteRefsList();
        }

        function getWebsiteReferences() {
            const inputs = document.querySelectorAll('.website-url');
            const urls = [];
            inputs.forEach(input => {
                if (input.value.trim() && input.value.startsWith('http')) {
                    urls.push(input.value.trim());
                }
            });
            return urls;
        }

        function updateWebsiteRefsList() {
            const refs = getWebsiteReferences();
            let listDiv = document.getElementById('websiteRefsList');
            
            if (refs.length > 0) {
                if (!listDiv) {
                    listDiv = document.createElement('div');
                    listDiv.id = 'websiteRefsList';
                    listDiv.className = 'website-refs-list';
                    document.getElementById('websiteRefsContainer').appendChild(listDiv);
                }
                
                listDiv.innerHTML = `
                    <h5>üìã Information Sources (${refs.length}):</h5>
                    <ul>
                        ${refs.map(url => `<li>${url}</li>`).join('')}
                    </ul>
                `;
            } else if (listDiv) {
                listDiv.remove();
            }
        }

        // Update website refs list when URLs change
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('website-url')) {
                updateWebsiteRefsList();
            }
        });
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                font-size: 14px;
                font-weight: 500;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'error') {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#3182ce';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, type === 'info' ? 6000 : 4000);
        }

        // Make functions globally accessible
        window.generateWithClaude = generateWithClaude;
        window.generateWithSpeechify = generateWithSpeechify;
        window.selectVoice = selectVoice;
        window.togglePlayback = togglePlayback;
        window.downloadAudio = downloadAudio;
        window.downloadScript = downloadScript;
        window.downloadPDF = downloadPDF;
        window.downloadJSON = downloadJSON;
        window.saveToLibrary = saveToLibrary;
        window.addWebsiteRef = addWebsiteRef;
        window.removeWebsiteRef = removeWebsiteRef;
        window.updateModelInfo = updateModelInfo;

        console.log('Enhanced functions registered to window with batch generation support');
    </script>
</body>
</html>
