<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Premium - AI-Powered Audioguides" />
    <meta property="og:description" content="Create premium audioguides with Claude AI and Speechify" />
    <title>CloudGuide Premium - Claude AI & Speechify</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #48bb78;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 35px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .panel-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 25px;
            color: #2d3748;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #f7fafc;
            transition: all 0.3s;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        textarea.form-element {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-element {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            padding-right: 45px;
        }

        /* Advanced Settings */
        .advanced-settings {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        /* Voice Selection */
        .voice-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: white;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
            color: #2d3748;
        }

        .voice-details {
            font-size: 12px;
            color: #718096;
        }

        /* Generated Content Section */
        .content-display {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        .content-display:empty::before {
            content: 'Generated content will appear here...';
            color: #a0aec0;
            font-style: italic;
            font-family: 'Nunito Sans', sans-serif;
        }

        /* Progress Indicator */
        .progress-section {
            display: none;
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.5s;
        }

        .progress-text {
            text-align: center;
            color: #718096;
            font-size: 13px;
        }

        /* Audio Player Section */
        .audio-player-section {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-top: 30px;
        }

        .audio-player-section.active {
            display: block;
        }

        .custom-audio-player {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #48bb78;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .play-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        .audio-progress {
            flex: 1;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .voice-selection {
                grid-template-columns: 1fr;
            }
            
            .panel {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html">AUDIO</a></li>
                        <li><a href="premium.html" style="color: #48bb78;">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-layout">
            <!-- Claude AI Content Generation -->
            <div class="panel">
                <h2 class="panel-title">Content Generation</h2>

                <div class="form-group">
                    <label for="destination">Destination / Topic</label>
                    <input type="text" id="destination" class="form-element" placeholder="e.g., Louvre Museum, Ancient Rome, Yosemite National Park...">
                </div>

                <div class="form-group">
                    <label for="guideType">Guide Type</label>
                    <select id="guideType" class="form-element">
                        <option value="museum">Museum/Indoor Guide</option>
                        <option value="city">City/Outdoor Guide</option>
                        <option value="trail">Nature Trail/Hiking Guide</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="audienceType">Target Audience</label>
                    <select id="audienceType" class="form-element">
                        <option value="general">General Visitors</option>
                        <option value="experts">History Enthusiasts</option>
                        <option value="families">Families with Children</option>
                        <option value="students">Students & Educators</option>
                        <option value="vip">VIP Tours</option>
                        <option value="accessibility">Accessibility Focus</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contentStyle">Content Style</label>
                    <select id="contentStyle" class="form-element">
                        <option value="storytelling">Immersive Storytelling</option>
                        <option value="educational">Educational & Informative</option>
                        <option value="conversational">Casual & Conversational</option>
                        <option value="dramatic">Dramatic & Theatrical</option>
                        <option value="poetic">Poetic & Evocative</option>
                        <option value="humorous">Light & Humorous</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="customPrompt">Custom Instructions (Optional)</label>
                    <textarea id="customPrompt" class="form-element" placeholder="Add specific requirements, focus areas, or special instructions..."></textarea>
                </div>

                <div class="advanced-settings">
                    <h4 style="margin-bottom: 15px; color: #4a5568; font-size: 13px;">ADVANCED SETTINGS</h4>
                    <div class="settings-grid">
                        <div class="form-group" style="margin: 0;">
                            <label for="numStops">Number of Stops</label>
                            <select id="numStops" class="form-element">
                                <option value="3">3 Stops</option>
                                <option value="4" selected>4 Stops (Best for rate limit)</option>
                                <option value="5">5 Stops</option>
                                <option value="8">8 Stops</option>
                                <option value="10">10 Stops</option>
                                <option value="15">15 Stops</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="stopLength">Words per Stop</label>
                            <select id="stopLength" class="form-element">
                                <option value="500">~500 words</option>
                                <option value="750">~750 words</option>
                                <option value="900" selected>~900 words (Optimal)</option>
                                <option value="1000">~1000 words</option>
                                <option value="1200">~1200 words</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="console.log('Button clicked'); generateWithClaude()">
                    Generate Content
                </button>

                <div class="progress-section" id="claudeProgress">
                    <div class="progress-text">Generating content...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="claudeProgressBar"></div>
                    </div>
                    <div class="progress-text" id="claudeStatus">Initializing...</div>
                </div>

                <div class="content-display" id="generatedContent"></div>
            </div>

            <!-- Audio Generation -->
            <div class="panel">
                <h2 class="panel-title">Audio Generation</h2>

                <div class="form-group">
                    <label>Select Voice</label>
                    <div class="voice-selection">
                        <div class="voice-card selected" onclick="selectVoice(this, 'snoop')">
                            <div class="voice-name">Snoop Dogg</div>
                            <div class="voice-details">Celebrity Voice</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'gwyneth')">
                            <div class="voice-name">Gwyneth Paltrow</div>
                            <div class="voice-details">Celebrity Voice</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'david')">
                            <div class="voice-name">David Attenborough</div>
                            <div class="voice-details">Documentary</div>
                        </div>
                        <div class="voice-card" onclick="selectVoice(this, 'james')">
                            <div class="voice-name">James Earl Jones</div>
                            <div class="voice-details">Narrator</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="speechSpeed">Speech Speed</label>
                    <input type="range" id="speechSpeed" class="form-element" min="0.5" max="1.5" value="1.0" step="0.1">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #718096;">
                        <span>Slow (0.5x)</span>
                        <span id="speedValue">1.0x</span>
                        <span>Fast (1.5x)</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="voiceLanguage">Language</label>
                    <select id="voiceLanguage" class="form-element">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese</option>
                        <option value="zh-CN">Chinese</option>
                        <option value="ja-JP">Japanese</option>
                    </select>
                </div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="generateWithSpeechify()">
                    Generate Audio
                </button>

                <div class="progress-section" id="speechifyProgress">
                    <div class="progress-text">Generating audio...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="speechifyProgressBar"></div>
                    </div>
                    <div class="progress-text" id="speechifyStatus">Processing...</div>
                </div>
            </div>
        </div>

        <!-- Audio Player Section -->
        <div class="audio-player-section" id="audioPlayerSection">
            <h2 class="panel-title">Audio Player</h2>
            <div class="custom-audio-player">
                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" onclick="togglePlayback()">▶️</button>
                    <div class="audio-progress">
                        <input type="range" id="audioProgress" class="form-element" min="0" max="100" value="0">
                        <div class="audio-time">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="downloadAudio()">Download Audio</button>
                    <button class="btn btn-secondary" onclick="downloadScript()">Download Script</button>
                    <button class="btn btn-primary" onclick="saveToLibrary()">Save to Library</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3 style="color: #2d3748; margin-bottom: 10px;">Creating Your Audioguide</h3>
                <p style="color: #718096;" id="loadingStatus">Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedVoice = 'snoop';
        let generatedContent = '';
        let audioUrl = null;
        let currentAudio = null;

        console.log('Script loaded');

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Update speed display
            const speedSlider = document.getElementById('speechSpeed');
            if (speedSlider) {
                speedSlider.addEventListener('input', function() {
                    document.getElementById('speedValue').textContent = this.value + 'x';
                });
                console.log('Speed slider initialized');
            } else {
                console.error('Speed slider not found');
            }
            
            // Test if buttons are accessible
            const testButton = document.querySelector('[onclick*="generateWithClaude"]');
            console.log('Generate button found:', !!testButton);
        });

        // Select voice
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Generate content with Claude (with rate limit handling)
        async function generateWithClaude() {
            console.log('generateWithClaude called');
            
            const destination = document.getElementById('destination').value;
            console.log('Destination:', destination);
            
            if (!destination) {
                console.log('No destination entered');
                showMessage('Please enter a destination or topic', 'error');
                return;
            }

            const guideType = document.getElementById('guideType').value;
            const audience = document.getElementById('audienceType').value;
            const style = document.getElementById('contentStyle').value;
            const customPrompt = document.getElementById('customPrompt').value;
            const numStops = document.getElementById('numStops').value;
            const stopLength = document.getElementById('stopLength').value;

            console.log('Form values collected:', {
                destination, guideType, audience, style, numStops, stopLength
            });

            // Show progress
            console.log('Showing progress...');
            document.getElementById('claudeProgress').classList.add('active');
            updateProgress('claude', 10, 'Connecting to AI...');

            try {
                console.log('Starting API call...');
                updateProgress('claude', 30, 'Generating content...');

                // Call Claude API through backend
                const requestBody = {
                    destination: destination,
                    guideType: guideType,
                    audience: audience,
                    style: style,
                    customPrompt: customPrompt,
                    numStops: parseInt(numStops),
                    stopLength: parseInt(stopLength)
                };
                
                console.log('Request body:', requestBody);
                console.log('Fetching /api/claude...');

                const response = await fetch('/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('API response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API error:', errorData);
                    
                    // Check if it's a rate limit error
                    if (errorData.error && errorData.error.includes('rate limit')) {
                        console.log('Rate limit detected, showing retry option...');
                        updateProgress('claude', 30, 'Rate limit reached. Waiting 60 seconds...');
                        showMessage('Rate limit reached. Will retry in 60 seconds...', 'info');
                        
                        // Show countdown
                        let countdown = 60;
                        const countdownInterval = setInterval(() => {
                            countdown--;
                            updateProgress('claude', 30 + (30 - countdown/2), `Retrying in ${countdown} seconds...`);
                            
                            if (countdown <= 0) {
                                clearInterval(countdownInterval);
                                // Retry the request
                                generateWithClaude();
                            }
                        }, 1000);
                        
                        return;
                    }
                    
                    throw new Error(errorData.error || `API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('API response data:', data);
                updateProgress('claude', 90, 'Processing response...');

                generatedContent = data.rawContent || data.content;
                document.getElementById('generatedContent').textContent = data.content;

                updateProgress('claude', 100, 'Content generated successfully!');
                showMessage('Content generated successfully!', 'success');
                
                // Show quality info
                const wordCount = generatedContent.split(/\s+/).length;
                showMessage(`Generated ${numStops} stops with ~${Math.round(wordCount/numStops)} words per stop`, 'info');

                setTimeout(() => {
                    document.getElementById('claudeProgress').classList.remove('active');
                }, 2000);

            } catch (error) {
                console.error('API Error:', error);
                console.error('Error stack:', error.stack);
                showMessage('Error: ' + error.message, 'error');
                document.getElementById('claudeProgress').classList.remove('active');
            }
        }

        // Generate audio with Speechify
        async function generateWithSpeechify() {
            if (!generatedContent) {
                showMessage('Please generate content first', 'error');
                return;
            }

            const speed = document.getElementById('speechSpeed').value;
            const language = document.getElementById('voiceLanguage').value;

            // Show progress
            document.getElementById('speechifyProgress').classList.add('active');
            updateProgress('speechify', 10, 'Preparing audio generation...');

            try {
                updateProgress('speechify', 30, 'Processing with Speechify...');

                // Call Speechify API through backend
                const response = await fetch('/api/speechify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: generatedContent,
                        voice: selectedVoice,
                        language: language,
                        speed: parseFloat(speed),
                        pitch: 1.0,
                        volume: 1.0
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Audio generation failed');
                }

                const data = await response.json();
                updateProgress('speechify', 90, 'Finalizing audio...');

                // Handle response
                if (data.audioUrl) {
                    audioUrl = data.audioUrl;
                    
                    // Show audio player
                    document.getElementById('audioPlayerSection').classList.add('active');
                    
                    // Set up audio element
                    if (!currentAudio) {
                        currentAudio = new Audio();
                    }
                    currentAudio.src = audioUrl;
                    
                    updateProgress('speechify', 100, 'Audio generated successfully!');
                    showMessage('Audio generated successfully!', 'success');
                }

                setTimeout(() => {
                    document.getElementById('speechifyProgress').classList.remove('active');
                }, 2000);

            } catch (error) {
                console.error('Speechify API Error:', error);
                showMessage('Error: ' + error.message, 'error');
                document.getElementById('speechifyProgress').classList.remove('active');
            }
        }

        // Update progress
        function updateProgress(type, percentage, status) {
            const progressBar = document.getElementById(type + 'ProgressBar');
            const statusText = document.getElementById(type + 'Status');
            
            progressBar.style.width = percentage + '%';
            statusText.textContent = status;
        }

        // Toggle audio playback
        function togglePlayback() {
            const playBtn = document.getElementById('playBtn');
            
            if (!currentAudio) {
                if (!audioUrl) {
                    showMessage('No audio to play', 'error');
                    return;
                }
                currentAudio = new Audio(audioUrl);
            }
            
            if (currentAudio.paused) {
                currentAudio.play();
                playBtn.textContent = '⏸️';
            } else {
                currentAudio.pause();
                playBtn.textContent = '▶️';
            }
        }

        // Download functions
        function downloadAudio() {
            if (!audioUrl) {
                showMessage('No audio to download', 'error');
                return;
            }
            
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = 'audioguide.mp3';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage('Downloading audio...', 'info');
        }

        function downloadScript() {
            if (!generatedContent) {
                showMessage('No script to download', 'error');
                return;
            }
            
            const blob = new Blob([generatedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audioguide_script.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Script downloaded!', 'success');
        }

        function saveToLibrary() {
            if (!generatedContent) {
                showMessage('No content to save', 'error');
                return;
            }
            
            // Save to localStorage library
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const newGuide = {
                id: Date.now(),
                title: document.getElementById('destination').value,
                content: generatedContent,
                type: 'premium',
                createdWith: 'Premium',
                date: new Date().toISOString(),
                location: document.getElementById('destination').value,
                language: document.getElementById('voiceLanguage').value,
                stops: document.getElementById('numStops').value,
                tourType: document.getElementById('guideType').value
            };
            
            audioguides.unshift(newGuide);
            localStorage.setItem('cloudguide_audioguides', JSON.stringify(audioguides));
            
            showMessage('Saved to library!', 'success');
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                font-size: 14px;
            `;
            
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'error') {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#3182ce';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }
        // Make functions globally accessible
        window.generateWithClaude = generateWithClaude;
        window.generateWithSpeechify = generateWithSpeechify;
        window.selectVoice = selectVoice;
        window.togglePlayback = togglePlayback;
        window.downloadAudio = downloadAudio;
        window.downloadScript = downloadScript;
        window.saveToLibrary = saveToLibrary;
        
        console.log('Functions registered to window');
    </script>
</body>
</html>
