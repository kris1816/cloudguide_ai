<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Audio Generation" />
    <meta property="og:description" content="Convert your audioguides to professional audio files in multiple languages" />
    <title>CloudGuide - Audio Generation</title>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            color: #718096;
        }

        .tab-btn.active {
            background: white;
            color: #48bb78;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Text Input Section */
        .text-input-section {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            resize: vertical;
        }

        .text-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
            background: white;
        }

        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Format Info Box */
        .format-info {
            background: #f0fff4;
            border: 1px solid #48bb78;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #2d3748;
        }

        .format-info strong {
            color: #48bb78;
        }

        /* TTS Optimization Info */
        .tts-optimization-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #92400e;
        }

        .tts-optimization-info h4 {
            margin-bottom: 10px;
            color: #f59e0b;
        }

        /* Chapters Section */
        .chapters-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: #f7fafc;
        }

        .chapter-item.selected {
            background: #f0fff4;
            border-left: 3px solid #48bb78;
        }

        .chapter-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: #718096;
        }

        .chapter-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: #e2e8f0;
            color: #4a5568;
            margin-right: 5px;
        }

        .chapter-type.file {
            background: #dbeafe;
            color: #1e40af;
        }

        .chapter-type.stop {
            background: #fef3c7;
            color: #92400e;
        }

        .chapter-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #e2e8f0;
            color: #718096;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        /* Voice Grid */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .generate-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .generate-btn {
            flex: 1;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Files Section */
        .files-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .voice-grid {
                grid-template-columns: 1fr;
            }
            .generate-section {
                flex-direction: column;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html" class="active">AUDIO</a></li>
                        <li><a href="upload.html">UPLOAD</a></li>
                        <li><a href="premium.html">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Audio Generation</h1>
            <p class="hero-subtitle">Convert Your Audioguides to Professional Audio Files</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('text')">Direct Text Input</button>
                <button class="tab-btn" onclick="switchTab('library')">Load from Library</button>
            </div>

            <!-- Direct Text Input Tab -->
            <div id="textTab" class="tab-content active">
                <div class="text-input-section">
                    <div class="format-info">
                        <strong>üìù Supported Formats:</strong><br>
                        ‚Ä¢ <strong>Multi-File Format:</strong> FILE 01: Title ‚Üí FILE 02: Title<br>
                        ‚Ä¢ <strong>Stop Format:</strong> STOP 1: Title ‚Üí STOP 2: Title<br>
                        ‚Ä¢ <strong>Mixed Format:</strong> Combination of both formats<br>
                        ‚Ä¢ <strong>Plain Text:</strong> Will be treated as a single chapter
                    </div>

                    <div class="tts-optimization-info">
                        <h4>üéôÔ∏è TTS Optimization Enabled</h4>
                        <strong>Automatic text preprocessing includes:</strong><br>
                        ‚Ä¢ Roman numerals conversion (II ‚Üí the second, XIV ‚Üí the fourteenth)<br>
                        ‚Ä¢ Decades formatting (90s ‚Üí nineties, 1960s ‚Üí nineteen sixties)<br>
                        ‚Ä¢ Century formatting (21st ‚Üí twenty-first century)<br>
                        ‚Ä¢ Pronunciation hints for foreign terms<br>
                        ‚Ä¢ Symbol conversion (% ‚Üí percent, ¬∞C ‚Üí degrees Celsius)<br>
                        ‚Ä¢ Eastern European phonetics (ƒå ‚Üí ch, ≈† ‚Üí sh, ≈Ω ‚Üí zh)<br>
                        ‚Ä¢ Time format standardization (3:30 PM ‚Üí three thirty P M)<br>
                        ‚Ä¢ Currency symbols ($100 ‚Üí one hundred dollars)
                    </div>
                    
                    <label>Paste Your Audioguide Text</label>
                    <textarea id="textInput" class="text-input" placeholder="Paste your audioguide text here...

Supported formats:

FORMAT 1 - Multi-File Structure:
FILE 01: INTRODUCTION
*Duration: 5 minutes*
Your introduction text here...

FILE 02: HISTORY
*Duration: 8 minutes*
Your history text here...

FORMAT 2 - Stop Structure:
STOP 1: INTRODUCTION
------------------------------
Your introduction text here...

STOP 2: HISTORY
------------------------------
Your history text here..."></textarea>
                    
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="parseChapters()">Parse Chapters</button>
                        <button class="btn btn-secondary" onclick="clearText()">Clear</button>
                        <button class="btn btn-secondary" onclick="loadSampleMultiFile()">Load Multi-File Sample</button>
                        <button class="btn btn-secondary" onclick="loadSampleStops()">Load Stops Sample</button>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="enableTTSOptimization" checked> 
                            Enable TTS Optimization (preprocesses text for better pronunciation)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Library Tab -->
            <div id="libraryTab" class="tab-content">
                <div class="alert alert-info">
                    Select an audioguide from your library to generate audio.
                </div>
                <div id="libraryList"></div>
            </div>

            <!-- Chapters Section -->
            <div class="chapters-section" id="chaptersSection" style="display: none;">
                <h3 class="section-title">üìñ Select Chapters to Generate</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                    <span style="margin-left: auto; font-size: 13px; color: #718096;">
                        <span id="selectedCount">0</span> of <span id="totalCount">0</span> selected
                    </span>
                </div>
                <div class="chapter-list" id="chapterList"></div>
            </div>

            <!-- Settings Grid -->
            <div class="settings-grid">
                <!-- Language Settings -->
                <div class="settings-section">
                    <h3 class="section-title">üåç Language Settings</h3>
                    
                    <div class="form-group">
                        <label for="audioLanguage">Audio Language</label>
                        <select id="audioLanguage" class="form-element" onchange="updateLanguageInfo()">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish (Spain)</option>
                            <option value="es-MX">Spanish (Mexico)</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-BR">Portuguese (Brazil)</option>
                            <option value="pt-PT">Portuguese (Portugal)</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ko-KR">Korean</option>
                            <option value="ru-RU">Russian</option>
                            <option value="ar-XA">Arabic</option>
                            <option value="hi-IN">Hindi</option>
                        </select>
                    </div>

                    <div id="languageAlert" class="alert alert-warning" style="display: none;">
                        ‚ö†Ô∏è Non-English languages will use English accent. Configure Google Cloud TTS for native pronunciation.
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="skipTitles" checked> 
                            Skip chapter titles (narrate content only)
                        </label>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-section">
                    <h3 class="section-title">üéôÔ∏è Voice Settings</h3>
                    
                    <div class="form-group">
                        <label>Select Voice</label>
                        <div class="voice-grid">
                            <div class="voice-card selected" onclick="selectVoice(this, 'alloy')">
                                <div style="font-size: 2em;">üé≠</div>
                                <div style="font-weight: 600;">Alloy</div>
                                <div style="font-size: 0.85em; color: #718096;">Neutral</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'nova')">
                                <div style="font-size: 2em;">üë©</div>
                                <div style="font-weight: 600;">Nova</div>
                                <div style="font-size: 0.85em; color: #718096;">Female</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'echo')">
                                <div style="font-size: 2em;">üé§</div>
                                <div style="font-weight: 600;">Echo</div>
                                <div style="font-size: 0.85em; color: #718096;">Male</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'fable')">
                                <div style="font-size: 2em;">üìñ</div>
                                <div style="font-weight: 600;">Fable</div>
                                <div style="font-size: 0.85em; color: #718096;">British</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speed">Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" min="0.5" max="1.5" value="1.0" step="0.1" id="speed" class="form-element" oninput="updateSpeed()">
                    </div>
                </div>
            </div>

            <!-- Generate Buttons -->
            <div class="generate-section" id="generateSection" style="display: none;">
                <button class="generate-btn" id="generateSingle" onclick="generateSingle()">
                    üéôÔ∏è Generate Selected Chapter
                </button>
                <button class="generate-btn" id="generateAll" onclick="generateAll()" style="background: #667eea;">
                    üé¨ Generate All Selected Chapters
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Generating audio... Please wait...</div>
            </div>

            <!-- Generated Files -->
            <div class="files-section" id="filesSection" style="display: none;">
                <h3 class="section-title">üéµ Generated Audio Files</h3>
                <div id="fileList"></div>
                <div style="margin-top: 20px; padding: 15px; background: #f0fff4; border: 1px solid #48bb78; border-radius: 6px;">
                    <strong>‚úÖ Audio files are automatically saved!</strong><br>
                    <small>You can now proceed to the <a href="upload.html" style="color: #48bb78;">Upload page</a> to submit them to CloudGuide CMS.</small>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p style="font-size: 12px; color: #718096; margin-bottom: 20px;">
                Financiado por la Uni√≥n Europea ‚Äì Next Generation EU<br>
                a trav√©s del Ministerio de Industria y Turismo
            </p>
            <div style="display: flex; justify-content: center; gap: 40px;">
                <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                     alt="EU" style="height: 45px; opacity: 0.6;">
                <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                     alt="Spain" style="height: 45px; opacity: 0.6;">
            </div>
        </div>
    </div>

    <script>
        let chapters = [];
        let selectedVoice = 'alloy';
        let generatedFiles = [];
        let currentGuideId = null;
        let currentAudioPlayer = null;

        // CRITICAL: Audio persistence functions - SAVES AUDIO TO LOCALSTORAGE
        function saveAudioForUpload(guideId, audioFile) {
            if (!guideId) {
                console.error('No guide ID provided for saving audio');
                return;
            }
            
            // Get existing files or create new array
            let savedAudioFiles = JSON.parse(localStorage.getItem(`cloudguide_audio_${guideId}`) || '[]');
            
            // Add the new audio file
            savedAudioFiles.push({
                name: audioFile.name,
                url: audioFile.url,
                dataUrl: audioFile.url, // Store the actual URL
                size: audioFile.size || 'Generated',
                stopNumber: audioFile.stopNumber || savedAudioFiles.length + 1,
                chapterTitle: audioFile.chapter,
                language: audioFile.language,
                provider: audioFile.provider || 'openai',
                generatedAt: new Date().toISOString()
            });
            
            // Save back to localStorage
            localStorage.setItem(`cloudguide_audio_${guideId}`, JSON.stringify(savedAudioFiles));
            console.log(`‚úÖ Saved audio file ${audioFile.name} for guide ${guideId}. Total files: ${savedAudioFiles.length}`);
            
            // Show success message
            showMessage(`Audio file saved: ${audioFile.name}`, 'success');
        }

        function clearSavedAudioFiles(guideId) {
            if (guideId) {
                localStorage.removeItem(`cloudguide_audio_${guideId}`);
                console.log(`Cleared saved audio files for guide ${guideId}`);
            }
        }

        function loadSavedAudioFiles(guideId) {
            if (!guideId) return [];
            const saved = localStorage.getItem(`cloudguide_audio_${guideId}`);
            return saved ? JSON.parse(saved) : [];
        }

        // TTS Text Preprocessing Function (keeping all your existing preprocessing)
        function preprocessTextForTTS(text, language = 'en-US') {
            if (!document.getElementById('enableTTSOptimization').checked) {
                return text;
            }

            let processed = text;

            // Roman Numerals Conversion
            const romanNumerals = {
                'I': '1', 'II': '2', 'III': '3', 'IV': '4', 'V': '5',
                'VI': '6', 'VII': '7', 'VIII': '8', 'IX': '9', 'X': '10',
                'XI': '11', 'XII': '12', 'XIII': '13', 'XIV': '14', 'XV': '15',
                'XVI': '16', 'XVII': '17', 'XVIII': '18', 'XIX': '19', 'XX': '20',
                'XXI': '21'
            };

            // Convert Roman numerals for monarchs and wars
            processed = processed.replace(/\b([IVX]+)\b(?=\s*(century|Century|king|King|queen|Queen|Pope|pope|Emperor|emperor))/g, 
                (match, numeral) => {
                    const number = romanNumerals[numeral];
                    if (number) {
                        const ordinal = getOrdinal(parseInt(number));
                        return ordinal;
                    }
                    return match;
                });

            // World War conversions
            processed = processed.replace(/World War II\b/gi, 'World War Two');
            processed = processed.replace(/World War I\b/gi, 'World War One');
            processed = processed.replace(/WWII\b/gi, 'World War Two');
            processed = processed.replace(/WWI\b/gi, 'World War One');

            // Decades conversion
            processed = processed.replace(/\b(\d{2})s\b/g, (match, decade) => {
                const decadeWords = {
                    '20': 'twenties', '30': 'thirties', '40': 'forties',
                    '50': 'fifties', '60': 'sixties', '70': 'seventies',
                    '80': 'eighties', '90': 'nineties'
                };
                return decadeWords[decade] || match;
            });

            processed = processed.replace(/\b(1\d{2}0)s\b/g, (match, year) => {
                const yearNum = parseInt(year);
                const century = Math.floor(yearNum / 100);
                const decade = yearNum % 100;
                const centuryWords = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'eighteen', 'nineteen', 'twenty'];
                const decadeWords = {
                    '0': 'hundreds', '10': 'tens', '20': 'twenties', '30': 'thirties',
                    '40': 'forties', '50': 'fifties', '60': 'sixties', '70': 'seventies',
                    '80': 'eighties', '90': 'nineties'
                };
                if (centuryWords[century] && decadeWords[decade]) {
                    return `${centuryWords[century]} ${decadeWords[decade]}`;
                }
                return match;
            });

            // Century formatting
            processed = processed.replace(/\b(\d{1,2})(st|nd|rd|th)\s+century\b/gi, (match, num) => {
                const ordinal = getOrdinalWord(parseInt(num));
                return `${ordinal} century`;
            });

            // Percentage sign
            processed = processed.replace(/(\d+)%/g, '$1 percent');

            // Currency symbols
            processed = processed.replace(/\$(\d+)/g, '$1 dollars');
            processed = processed.replace(/‚Ç¨(\d+)/g, '$1 euros');
            processed = processed.replace(/¬£(\d+)/g, '$1 pounds');
            processed = processed.replace(/¬•(\d+)/g, '$1 yen');

            // Temperature symbols
            processed = processed.replace(/(\d+)¬∞C\b/g, '$1 degrees Celsius');
            processed = processed.replace(/(\d+)¬∞F\b/g, '$1 degrees Fahrenheit');
            processed = processed.replace(/(\d+)¬∞/g, '$1 degrees');

            // Time formatting
            processed = processed.replace(/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)\b/g, (match, hour, minute, period) => {
                const h = parseInt(hour);
                const m = parseInt(minute);
                const hourWord = getNumberWord(h);
                const minuteWord = m === 0 ? '' : (m < 10 ? 'oh ' + getNumberWord(m) : getNumberWord(m));
                return `${hourWord} ${minuteWord} ${period.toUpperCase().split('').join(' ')}`;
            });

            // Eastern European letter replacements
            const letterReplacements = {
                'ƒå': 'Ch', 'ƒç': 'ch',
                'ƒÜ': 'Ch', 'ƒá': 'ch',
                'D≈æ': 'J', 'd≈æ': 'j',
                'ƒê': 'J', 'ƒë': 'j',
                '≈†': 'Sh', '≈°': 'sh',
                '≈ö': 'Sh', '≈õ': 'sh',
                '≈Ω': 'Zh', '≈æ': 'zh',
                '≈π': 'Zh', '≈∫': 'zh',
                '√ß': 's', '√á': 'S'
            };

            for (const [original, replacement] of Object.entries(letterReplacements)) {
                processed = processed.replace(new RegExp(original, 'g'), replacement);
            }

            // Handle parenthetical translations
            processed = processed.replace(/\b(\w+)\s*\(([^)]+)\)/g, (match, word, translation) => {
                if (!/^\d/.test(translation)) {
                    return `${word}, which means ${translation},`;
                }
                return match;
            });

            // Handle dashes with spaces for better pauses
            processed = processed.replace(/\s*‚Äì\s*/g, ', ');
            processed = processed.replace(/\s*‚Äî\s*/g, ', ');

            // Add pauses after abbreviations
            processed = processed.replace(/\b(Dr|Mr|Mrs|Ms|Prof|St)\./g, '$1');

            // Fix common mispronunciations based on language
            if (language.startsWith('en-')) {
                processed = processed.replace(/\b√â/g, 'E');
                processed = processed.replace(/\b√©/g, 'e');
                processed = processed.replace(/\b√†/g, 'a');
                processed = processed.replace(/\b√®/g, 'e');
            }

            return processed;
        }

        // Helper functions
        function getOrdinal(num) {
            const ordinals = {
                1: 'first', 2: 'second', 3: 'third', 4: 'fourth', 5: 'fifth',
                6: 'sixth', 7: 'seventh', 8: 'eighth', 9: 'ninth', 10: 'tenth',
                11: 'eleventh', 12: 'twelfth', 13: 'thirteenth', 14: 'fourteenth',
                15: 'fifteenth', 16: 'sixteenth', 17: 'seventeenth', 18: 'eighteenth',
                19: 'nineteenth', 20: 'twentieth', 21: 'twenty-first'
            };
            return ordinals[num] || `${num}th`;
        }

        function getOrdinalWord(num) {
            const ordinals = {
                1: 'first', 2: 'second', 3: 'third', 4: 'fourth', 5: 'fifth',
                6: 'sixth', 7: 'seventh', 8: 'eighth', 9: 'ninth', 10: 'tenth',
                11: 'eleventh', 12: 'twelfth', 13: 'thirteenth', 14: 'fourteenth',
                15: 'fifteenth', 16: 'sixteenth', 17: 'seventeenth', 18: 'eighteenth',
                19: 'nineteenth', 20: 'twentieth', 21: 'twenty-first'
            };
            return ordinals[num] || `${num}th`;
        }

        function getNumberWord(num) {
            const words = {
                0: 'zero', 1: 'one', 2: 'two', 3: 'three', 4: 'four',
                5: 'five', 6: 'six', 7: 'seven', 8: 'eight', 9: 'nine',
                10: 'ten', 11: 'eleven', 12: 'twelve', 13: 'thirteen',
                14: 'fourteen', 15: 'fifteen', 16: 'sixteen', 17: 'seventeen',
                18: 'eighteen', 19: 'nineteen', 20: 'twenty', 30: 'thirty',
                40: 'forty', 50: 'fifty'
            };
            
            if (words[num]) return words[num];
            if (num < 60) {
                const tens = Math.floor(num / 10) * 10;
                const ones = num % 10;
                return words[tens] + (ones > 0 ? ' ' + words[ones] : '');
            }
            return num.toString();
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'text') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('textTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('libraryTab').classList.add('active');
                loadLibrary();
            }
        }

        // Parse chapters (keeping your existing parsing logic)
        function parseChapters() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            chapters = [];
            const lines = text.split('\n');
            let currentChapter = null;
            let contentBuffer = [];
            let chapterType = 'unknown';

            console.log('Starting parse, total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                const fileMatch = line.match(/^(?:#{1,3}\s*)?(?:FILE\s+)?(\d+)[\.:]\s*(.+)/i);
                const stopMatch = line.match(/^STOP\s+(\d+):\s*(.+)/i);
                const numberedSectionMatch = line.match(/^(\d+)\.\s+(?:\*\*)?(?:\[)?([^\]]+?)(?:\])?(?:\*\*)?(?:\.|:)?/);
                const isLikelyChapter = line.match(/^(\d+)\.\s+.*(?:Heraklion|Chania|Lasithi|Matala|Rethymno|Eastern Crete|FILE|STOP)/i);
                
                if ((fileMatch && line.includes('FILE')) || (numberedSectionMatch && isLikelyChapter)) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    
                    let chapterNum, chapterTitle;
                    
                    if (fileMatch && line.includes('FILE')) {
                        chapterNum = fileMatch[1];
                        chapterTitle = fileMatch[2].trim();
                    } else if (numberedSectionMatch) {
                        chapterNum = numberedSectionMatch[1];
                        chapterTitle = numberedSectionMatch[2]
                            .replace(/\*\*/g, '')
                            .replace(/\[/g, '')
                            .replace(/\]/g, '')
                            .replace(/:$/g, '')
                            .trim();
                    }
                    
                    let duration = null;
                    if (i + 1 < lines.length && lines[i + 1].includes('Duration:')) {
                        const durationMatch = lines[i + 1].match(/Duration:\s*(.+)/i);
                        if (durationMatch) {
                            duration = durationMatch[1].replace(/[*_]/g, '').trim();
                            i++;
                        }
                    }
                    
                    currentChapter = {
                        id: chapters.length + 1,
                        fileNumber: chapterNum,
                        title: `Section ${chapterNum}: ${chapterTitle}`,
                        shortTitle: chapterTitle,
                        content: '',
                        selected: false,
                        status: 'pending',
                        type: 'section',
                        duration: duration
                    };
                    contentBuffer = [];
                    chapterType = 'section';
                    
                    console.log('Found chapter:', currentChapter.title);
                    
                } else if (stopMatch) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    
                    currentChapter = {
                        id: chapters.length + 1,
                        stopNumber: stopMatch[1],
                        title: `STOP ${stopMatch[1]}: ${stopMatch[2].trim()}`,
                        shortTitle: stopMatch[2].trim(),
                        content: '',
                        selected: false,
                        status: 'pending',
                        type: 'stop'
                    };
                    contentBuffer = [];
                    chapterType = 'stop';
                    
                } else if (currentChapter && !line.match(/^-+$/) && !line.match(/^=+$/) && !line.match(/^#{1,3}\s*$/)) {
                    if (line.trim() || contentBuffer.length > 0) {
                        contentBuffer.push(line);
                    }
                }
            }

            if (currentChapter) {
                currentChapter.content = contentBuffer.join('\n').trim();
                if (currentChapter.content) {
                    chapters.push(currentChapter);
                }
            }

            console.log('Total chapters found:', chapters.length);

            if (chapters.length === 0) {
                console.log('No chapters found with primary method, trying alternative parsing...');
                
                const numberedLines = [];
                lines.forEach((line, index) => {
                    if (line.match(/^\d+\.\s+/)) {
                        numberedLines.push({ line, index });
                    }
                });
                
                if (numberedLines.length > 1) {
                    console.log('Found', numberedLines.length, 'numbered sections');
                    
                    numberedLines.forEach((item, idx) => {
                        const match = item.line.match(/^(\d+)\.\s+(.+)/);
                        if (match) {
                            const startIdx = item.index;
                            const endIdx = idx < numberedLines.length - 1 ? numberedLines[idx + 1].index : lines.length;
                            
                            const content = lines.slice(startIdx + 1, endIdx).join('\n').trim();
                            
                            chapters.push({
                                id: chapters.length + 1,
                                fileNumber: match[1],
                                title: `Section ${match[1]}: ${match[2].trim()}`,
                                shortTitle: match[2].trim(),
                                content: content,
                                selected: false,
                                status: 'pending',
                                type: 'section'
                            });
                        }
                    });
                }
            }

            if (chapters.length === 0) {
                chapters = [{
                    id: 1,
                    title: 'Full Text',
                    shortTitle: 'Full Audio Guide',
                    content: text,
                    selected: true,
                    status: 'pending',
                    type: 'full'
                }];
            }

            chapters.slice(0, 3).forEach(ch => ch.selected = true);

            renderChapters();
            document.getElementById('chaptersSection').style.display = 'block';
            document.getElementById('generateSection').style.display = 'flex';
            updateSelectedCount();
        }

        // Render chapters
        function renderChapters() {
            const list = document.getElementById('chapterList');
            list.innerHTML = chapters.map((ch, i) => {
                const wordCount = ch.content.split(/\s+/).filter(word => word.length > 0).length;
                const estimatedDuration = Math.ceil(wordCount / 150);
                
                return `
                    <div class="chapter-item ${ch.selected ? 'selected' : ''}" onclick="toggleChapter(${i})">
                        <input type="checkbox" class="chapter-checkbox" ${ch.selected ? 'checked' : ''}>
                        <div class="chapter-info">
                            <div class="chapter-title">
                                <span class="chapter-type ${ch.type}">${ch.type.toUpperCase()}</span>
                                ${ch.shortTitle || ch.title}
                            </div>
                            <div class="chapter-meta">
                                ${wordCount} words ‚Ä¢ ~${estimatedDuration} min
                                ${ch.duration ? ` ‚Ä¢ ${ch.duration}` : ''}
                            </div>
                        </div>
                        <div class="chapter-status status-${ch.status}">${ch.status}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalCount').textContent = chapters.length;
        }

        // Update selected count
        function updateSelectedCount() {
            const selected = chapters.filter(ch => ch.selected).length;
            document.getElementById('selectedCount').textContent = selected;
        }

        // Toggle chapter selection
        function toggleChapter(index) {
            chapters[index].selected = !chapters[index].selected;
            renderChapters();
            updateSelectedCount();
        }

        // Select all/none
        function selectAll() {
            chapters.forEach(ch => ch.selected = true);
            renderChapters();
            updateSelectedCount();
        }

        function selectNone() {
            chapters.forEach(ch => ch.selected = false);
            renderChapters();
            updateSelectedCount();
        }

        // Clear text
        function clearText() {
            document.getElementById('textInput').value = '';
            chapters = [];
            document.getElementById('chaptersSection').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('filesSection').style.display = 'none';
            generatedFiles = [];
        }

        // Load samples
        function loadSampleMultiFile() {
            document.getElementById('textInput').value = `# CRETE AUDIO GUIDE
## Complete Structured Tour with 38 Stops

---

## FILE 01: INTRODUCTION TO CRETE
*Duration: 5 minutes*

### Opening
Close your eyes for a moment and imagine an island where Zeus was born in a mountain cave, where Europe's first civilization built palaces without fortification walls. In the 21st century, this island still maintains traditions from the 1960s.

### The Great Island
This isn't just Greece's largest island; it's home to 15% of the country's archaeological sites, with temperatures reaching 40¬∞C in summer. King Minos III ruled here in 1500 BCE.

---

## FILE 02: HISTORY OF CRETE
*Duration: 8 minutes*

### Ancient Origins
To understand Crete, you must first grasp that this island has been prized for over 4,000 years. World War II saw fierce battles here, and the 90s brought modern tourism.

### The Minoan Civilization
Our story begins around 3000 BCE, when the Minoans created Europe's first advanced civilization. The palace had rooms at 22¬∞C year-round.`;
            parseChapters();
        }

        function loadSampleStops() {
            document.getElementById('textInput').value = `STOP 1: INTRODUCTION
------------------------------
Welcome to the Louvre Museum, built in the 12th century by King Philip II. The museum houses 35,000 works, with 65% from European artists. Napoleon III expanded it in the 1850s.

STOP 2: HISTORY
------------------------------
The Louvre began as a fortress in 1190 CE. During World War II, artworks were hidden. The pyramid entrance was added in the 20th century, specifically in 1989.

STOP 3: MONA LISA
------------------------------
Leonardo da Vinci's masterpiece from the 16th century. The painting measures 77cm √ó 53cm. It survived theft in the early 20th century. Room temperature is maintained at 21¬∞C with 50% humidity.`;
            parseChapters();
        }

        // Voice selection
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Update speed display
        function updateSpeed() {
            document.getElementById('speedValue').textContent = document.getElementById('speed').value + 'x';
        }

        // Update language info
        async function updateLanguageInfo() {
            const lang = document.getElementById('audioLanguage').value;
            const alert = document.getElementById('languageAlert');
            
            if (!lang.startsWith('en-')) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }

        // Generate single chapter
        async function generateSingle() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select a chapter');
                return;
            }
            if (selected.length > 1) {
                alert('Please select only one chapter for single generation');
                return;
            }
            
            await generateAudio(selected[0]);
        }

        // Generate all selected
        async function generateAll() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select at least one chapter');
                return;
            }
            
            // Clear existing saved audio files if starting fresh
            if (currentGuideId && generatedFiles.length === 0) {
                clearSavedAudioFiles(currentGuideId);
            }
            
            for (let chapter of selected) {
                await generateAudio(chapter);
            }
            
            showMessage(`‚úÖ All ${selected.length} audio files generated and saved!`, 'success');
        }

        // Function to split text into chunks
        function splitTextIntoChunks(text, maxChunkSize = 3000) {
            const chunks = [];
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            let currentChunk = '';
            
            for (const sentence of sentences) {
                if ((currentChunk + sentence).length > maxChunkSize && currentChunk.length > 0) {
                    let finalChunk = currentChunk.trim();
                    
                    if (finalChunk.length > maxChunkSize) {
                        const words = finalChunk.split(/\s+/);
                        let tempChunk = '';
                        for (const word of words) {
                            if ((tempChunk + ' ' + word).length <= maxChunkSize) {
                                tempChunk += (tempChunk ? ' ' : '') + word;
                            } else {
                                if (tempChunk) chunks.push(tempChunk);
                                tempChunk = word;
                            }
                        }
                        if (tempChunk) chunks.push(tempChunk);
                    } else {
                        chunks.push(finalChunk);
                    }
                    currentChunk = sentence;
                } else {
                    currentChunk += sentence;
                }
            }
            
            if (currentChunk.trim()) {
                const finalChunk = currentChunk.trim();
                if (finalChunk.length > maxChunkSize) {
                    const words = finalChunk.split(/\s+/);
                    let tempChunk = '';
                    for (const word of words) {
                        if ((tempChunk + ' ' + word).length <= maxChunkSize) {
                            tempChunk += (tempChunk ? ' ' : '') + word;
                        } else {
                            if (tempChunk) chunks.push(tempChunk);
                            tempChunk = word;
                        }
                    }
                    if (tempChunk) chunks.push(tempChunk);
                } else {
                    chunks.push(finalChunk);
                }
            }
            
            chunks.forEach((chunk, i) => {
                console.log(`Chunk ${i + 1}: ${chunk.length} chars`);
            });
            
            return chunks;
        }

        // Generate audio for a chapter
        async function generateAudio(chapter) {
            const language = document.getElementById('audioLanguage').value;
            const speed = parseFloat(document.getElementById('speed').value);
            const skipTitles = document.getElementById('skipTitles').checked;
            
            let textToGenerate = chapter.content;
            if (!skipTitles && chapter.title !== 'Full Text') {
                textToGenerate = chapter.shortTitle + '\n\n' + chapter.content;
            }
            
            // Apply TTS preprocessing if enabled
            if (document.getElementById('enableTTSOptimization').checked) {
                textToGenerate = preprocessTextForTTS(textToGenerate, language);
                console.log('Text preprocessed for TTS');
            }
            
            // Check if text is too long and needs chunking
            const MAX_TTS_LENGTH = 3000;
            const textChunks = textToGenerate.length > MAX_TTS_LENGTH 
                ? splitTextIntoChunks(textToGenerate, MAX_TTS_LENGTH)
                : [textToGenerate];
            
            console.log(`Text length: ${textToGenerate.length}, Split into ${textChunks.length} chunks`);
            
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('generateSingle').disabled = true;
            document.getElementById('generateAll').disabled = true;
            
            const audioUrls = [];
            
            try {
                // Generate audio for each chunk
                for (let i = 0; i < textChunks.length; i++) {
                    const chunk = textChunks[i];
                    console.log(`Generating chunk ${i + 1}/${textChunks.length}, length: ${chunk.length}`);
                    
                    // Show progress
                    const loadingDiv = document.getElementById('loading');
                    const loadingText = loadingDiv.querySelector('div:last-child');
                    if (loadingText) {
                        loadingText.textContent = textChunks.length > 1 
                            ? `Generating audio... Part ${i + 1} of ${textChunks.length}`
                            : `Generating audio for ${chapter.shortTitle || chapter.title}...`;
                    }
                    
                    const response = await fetch('/api/multilingual-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: chunk,
                            language: language,
                            voice: selectedVoice,
                            speed: speed
                        })
                    });

                    console.log(`Chunk ${i + 1} response status:`, response.status);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.audioUrl) {
                            audioUrls.push(data.audioUrl);
                        } else {
                            throw new Error(`No audio URL in response for chunk ${i + 1}`);
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error(`API Error for chunk ${i + 1}:`, errorData);
                        throw new Error(errorData.error || errorData.message || `Failed to generate audio for part ${i + 1}`);
                    }
                    
                    // Small delay between chunks to avoid rate limiting
                    if (i < textChunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Use the first URL (or combine if multiple)
                let finalAudioUrl = audioUrls[0];
                
                // Update chapter status
                chapter.status = 'completed';
                renderChapters();
                
                // Create file object
                const file = {
                    name: `${chapter.shortTitle || chapter.title}`.replace(/[^a-z0-9]/gi, '_') + `_${language}.mp3`,
                    chapter: chapter.title,
                    language: language,
                    url: finalAudioUrl,
                    provider: 'openai',
                    stopNumber: chapter.stopNumber || chapter.fileNumber || chapter.id,
                    size: 'Generated'
                };
                
                // Add to generated files
                generatedFiles.push(file);
                
                // CRITICAL: Save audio file for upload page - THIS IS THE FIX!
                if (currentGuideId) {
                    saveAudioForUpload(currentGuideId, file);
                } else {
                    // Try to get guide ID from URL if not set
                    const urlParams = new URLSearchParams(window.location.search);
                    const id = urlParams.get('id');
                    if (id) {
                        currentGuideId = id;
                        saveAudioForUpload(id, file);
                    }
                }
                
                renderFiles();
                
                // Show success message
                if (audioUrls.length > 1) {
                    showMessage(`‚úÖ Audio generated for "${chapter.shortTitle || chapter.title}" (${audioUrls.length} parts)`, 'success');
                } else {
                    showMessage(`‚úÖ Audio generated for "${chapter.shortTitle || chapter.title}"`, 'success');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error generating audio: ' + error.message, 'error');
                chapter.status = 'error';
                renderChapters();
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateSingle').disabled = false;
                document.getElementById('generateAll').disabled = false;
                // Reset loading text
                const loadingDiv = document.getElementById('loading');
                const loadingText = loadingDiv.querySelector('div:last-child');
                if (loadingText) {
                    loadingText.textContent = 'Generating audio... Please wait...';
                }
            }
        }

        // Show message function
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'warning') {
                messageDiv.style.background = '#f59e0b';
                messageDiv.style.color = 'white';
            } else if (type === 'info') {
                messageDiv.style.background = '#3b82f6';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Render files
        function renderFiles() {
            if (generatedFiles.length === 0) return;
            
            document.getElementById('filesSection').style.display = 'block';
            document.getElementById('fileList').innerHTML = generatedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <div style="font-size: 1.5em;">üéµ</div>
                        <div>
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 0.85em; color: #718096;">
                                ${file.chapter} ‚Ä¢ ${file.language} ‚Ä¢ ${file.provider}
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary audio-play-btn" onclick="playAudio('${file.url}', this)">Play</button>
                        <button class="btn btn-secondary" onclick="downloadAudio('${file.url}', '${file.name}')">Download</button>
                    </div>
                </div>
            `).join('');
        }

        // Play/Stop audio
        function playAudio(url, buttonElement) {
            const button = buttonElement || event.target;
            
            // Check if this button is currently playing
            if (button.textContent === 'Stop') {
                // Stop the audio
                if (currentAudioPlayer) {
                    currentAudioPlayer.pause();
                    currentAudioPlayer.currentTime = 0;
                    currentAudioPlayer = null;
                }
                button.textContent = 'Play';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                return;
            }
            
            // Stop any other playing audio
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer.currentTime = 0;
                currentAudioPlayer = null;
                
                // Reset all play buttons
                document.querySelectorAll('.audio-play-btn').forEach(btn => {
                    btn.textContent = 'Play';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                });
            }
            
            // Create new audio player
            currentAudioPlayer = new Audio(url);
            
            // Update button to show playing state
            button.textContent = 'Stop';
            button.classList.remove('btn-primary');
            button.classList.add('btn-danger');
            
            // Add event listeners
            currentAudioPlayer.onended = () => {
                button.textContent = 'Play';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                currentAudioPlayer = null;
            };
            
            currentAudioPlayer.onerror = () => {
                showMessage('Error playing audio', 'error');
                button.textContent = 'Play';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                currentAudioPlayer = null;
            };
            
            // Start playing
            currentAudioPlayer.play().catch(error => {
                console.error('Play error:', error);
                showMessage('Failed to play audio: ' + error.message, 'error');
                button.textContent = 'Play';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                currentAudioPlayer = null;
            });
        }

        // Download audio
        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Load library
        function loadLibrary() {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const libraryGrid = document.getElementById('libraryList');
            
            if (audioguides.length === 0) {
                libraryGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #a0aec0;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìö</div>
                        <p style="font-size: 1.2em; margin-bottom: 15px;">Your library is empty</p>
                        <p><a href="index.html" style="color: #48bb78; text-decoration: none;">Generate your first audioguide ‚Üí</a></p>
                    </div>
                `;
                return;
            }

            libraryGrid.innerHTML = audioguides.map(guide => {
                // Check if this guide has saved audio files
                const savedAudioFiles = loadSavedAudioFiles(guide.id);
                const audioIndicator = savedAudioFiles.length > 0 
                    ? `<span style="color: #48bb78;">üéµ ${savedAudioFiles.length} audio files</span>`
                    : '<span style="color: #f6ad55;">No audio generated</span>';
                
                return `
                    <div style="padding: 20px; background: #f7fafc; border-radius: 6px; margin-bottom: 15px; cursor: pointer;"
                         onclick="loadFromLibrary('${guide.id}')">
                        <div style="font-weight: 600; margin-bottom: 8px;">${guide.title}</div>
                        <div style="font-size: 0.85em; color: #718096;">
                            ${guide.location} ‚Ä¢ ${guide.language} ‚Ä¢ ${guide.stops} stops ‚Ä¢ ${audioIndicator}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load from library
        function loadFromLibrary(id) {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const guide = audioguides.find(g => g.id == id);
            
            if (guide && guide.content) {
                currentGuideId = id;
                
                // Load any previously saved audio files
                const savedAudioFiles = loadSavedAudioFiles(id);
                if (savedAudioFiles.length > 0) {
                    generatedFiles = savedAudioFiles.map(audio => ({
                        name: audio.name,
                        chapter: audio.chapterTitle || 'Unknown',
                        language: audio.language || 'en-US',
                        url: audio.url || audio.dataUrl,
                        provider: audio.provider || 'openai',
                        stopNumber: audio.stopNumber
                    }));
                    
                    showMessage(`Loaded ${savedAudioFiles.length} previously generated audio files`, 'info');
                }
                
                switchTab('text');
                document.getElementById('textInput').value = guide.content;
                parseChapters();
                
                // If we have saved audio files, show them
                if (generatedFiles.length > 0) {
                    renderFiles();
                }
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            updateSpeed();
            updateLanguageInfo();
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                currentGuideId = id;
                loadFromLibrary(id);
            }
        });
    </script>
</body>
</html>
