<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Audio Generation" />
    <meta property="og:description" content="Convert your audioguides to professional audio files in multiple languages" />
    <title>CloudGuide - Multi-Language Audio Generation</title>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Load Section */
        .load-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .load-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .load-btn {
            padding: 12px 25px;
            background: white;
            border: 2px solid #48bb78;
            color: #48bb78;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .load-btn:hover {
            background: #48bb78;
            color: white;
        }

        /* Chapter Section */
        .chapters-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
            margin-bottom: 30px;
            display: none;
        }

        .chapters-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chapter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: #f7fafc;
        }

        .chapter-item.selected {
            background: #f0fff4;
            border-left: 3px solid #48bb78;
        }

        .chapter-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: #718096;
        }

        .chapter-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #e2e8f0;
            color: #718096;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Two Column Layout */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Settings Section */
        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Nunito Sans', sans-serif;
            background: white;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        /* Notice Boxes */
        .notice {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .notice-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .notice-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .notice-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        /* Voice Grid */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .voice-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .voice-desc {
            font-size: 0.85em;
            color: #718096;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .generate-btn {
            flex: 1;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .batch-btn {
            flex: 1;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Progress Section */
        .progress-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .progress-percentage {
            color: #48bb78;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .chapter-progress-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .chapter-progress-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        /* Files Section */
        .files-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            display: none;
        }

        .files-section.active {
            display: block;
        }

        .file-list {
            display: grid;
            gap: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .file-meta {
            font-size: 0.85em;
            color: #718096;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Notification */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification-success {
            background: #48bb78;
            color: white;
        }

        .notification-error {
            background: #e53e3e;
            color: white;
        }

        .notification-warning {
            background: #f59e0b;
            color: white;
        }

        /* Library Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2d3748;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #718096;
            padding: 5px;
        }

        .close-modal:hover {
            color: #e53e3e;
        }

        .library-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .library-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .library-item.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        /* Footer */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        .funding-text {
            font-size: 12px;
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .funding-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }

        .funding-logo {
            height: 45px;
            opacity: 0.6;
            transition: opacity 0.3s;
            filter: grayscale(20%);
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .voice-grid {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
            .load-buttons {
                flex-direction: column;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html" class="active">AUDIO</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Multi-Language Audio Generation</h1>
            <p class="hero-subtitle">Generate Professional Audio for Each Chapter in Multiple Languages</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Load Content Section -->
            <div class="load-section">
                <h3 class="section-title">📚 Load Your Audioguide</h3>
                <div class="load-buttons">
                    <button class="load-btn" onclick="openLibraryModal()">Load from Library</button>
                    <button class="load-btn" onclick="loadSampleContent()">Use Sample Content</button>
                    <button class="load-btn" onclick="document.getElementById('textFileInput').click()">Upload Text File</button>
                    <input type="file" id="textFileInput" accept=".txt" style="display: none;" onchange="handleFileUpload(event)">
                </div>
            </div>

            <!-- Chapters Section -->
            <div class="chapters-section" id="chaptersSection">
                <h3 class="section-title">📖 Select Chapters to Generate</h3>
                <div class="chapter-controls">
                    <button class="btn-small btn-primary" onclick="selectAllChapters()">Select All</button>
                    <button class="btn-small btn-secondary" onclick="deselectAllChapters()">Deselect All</button>
                    <span style="margin-left: auto; color: #718096; font-size: 13px;">
                        <span id="selectedCount">0</span> of <span id="totalCount">0</span> selected
                    </span>
                </div>
                <div class="chapter-list" id="chapterList">
                    <!-- Chapters will be loaded here -->
                </div>
            </div>

            <!-- Settings Grid -->
            <div class="two-column">
                <!-- Language Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🌍 Language Settings</h3>
                    
                    <div class="form-group">
                        <label for="audioLanguage">Audio Language</label>
                        <select id="audioLanguage" class="form-element" onchange="updateLanguageSettings()">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish (Spain)</option>
                            <option value="es-MX">Spanish (Mexico)</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-BR">Portuguese (Brazil)</option>
                            <option value="pt-PT">Portuguese (Portugal)</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ko-KR">Korean</option>
                            <option value="ru-RU">Russian</option>
                            <option value="ar-SA">Arabic</option>
                            <option value="hi-IN">Hindi</option>
                        </select>
                    </div>

                    <div id="languageNotice" class="notice notice-warning" style="display: none;">
                        ⚠️ Non-English languages will use OpenAI with English accent. For native pronunciation, configure Google Cloud TTS in your environment variables.
                    </div>

                    <div id="googleNotice" class="notice notice-success" style="display: none;">
                        ✅ Google Cloud TTS available! Will use native voice for this language.
                    </div>

                    <div class="form-group">
                        <label>Text Processing Options</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: normal; text-transform: none;">
                                <input type="checkbox" id="skipTitles" checked style="width: 20px; height: 20px;">
                                Skip chapter titles (only narrate content)
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: normal; text-transform: none;">
                                <input type="checkbox" id="skipDashes" checked style="width: 20px; height: 20px;">
                                Remove separator lines (-----)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🎙️ Voice Settings</h3>
                    
                    <div class="form-group">
                        <label>Select Voice (OpenAI)</label>
                        <div class="voice-grid" id="voiceGrid">
                            <div class="voice-card selected" onclick="selectVoice(this, 'alloy')">
                                <div class="voice-icon">🎭</div>
                                <div class="voice-name">Alloy</div>
                                <div class="voice-desc">Neutral</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'nova')">
                                <div class="voice-icon">👩</div>
                                <div class="voice-name">Nova</div>
                                <div class="voice-desc">Female</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'echo')">
                                <div class="voice-icon">🎤</div>
                                <div class="voice-name">Echo</div>
                                <div class="voice-desc">Male</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'fable')">
                                <div class="voice-icon">📖</div>
                                <div class="voice-name">Fable</div>
                                <div class="voice-desc">British</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="model">Model Quality</label>
                        <select id="model" class="form-element">
                            <option value="tts-1">Standard (Faster)</option>
                            <option value="tts-1-hd">HD (Higher Quality)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="speed">Speaking Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" min="0.5" max="1.5" value="1.0" step="0.1" id="speed" class="form-element" oninput="updateSpeedDisplay()">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="generate-btn" id="generateSingleBtn" onclick="generateSelectedChapter()">
                    🎙️ Generate Selected Chapter
                </button>
                <button class="batch-btn" id="generateBatchBtn" onclick="generateAllChapters()">
                    🎬 Generate All Selected Chapters
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <div class="overall-progress">
                    <div class="progress-header">
                        <div class="progress-title">Overall Progress</div>
                        <div class="progress-percentage" id="overallPercentage">0%</div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="overallProgress"></div>
                    </div>
                </div>
                <div class="chapter-progress-list" id="chapterProgressList"></div>
            </div>

            <!-- Generated Files Section -->
            <div class="files-section" id="filesSection">
                <h3 class="section-title">🎵 Generated Audio Files</h3>
                <div class="file-list" id="fileList"></div>
            </div>
        </div>

        <!-- Library Modal -->
        <div id="libraryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Select Audioguide from Library</h2>
                    <button class="close-modal" onclick="closeLibraryModal()">&times;</button>
                </div>
                <div id="libraryList"></div>
                <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn-secondary btn-small" onclick="closeLibraryModal()">Cancel</button>
                    <button class="btn-primary btn-small" onclick="loadSelectedAudioguide()" id="loadSelectedBtn" disabled>Load Selected</button>
                </div>
            </div>
        </div>

        <!-- Footer Section -->
        <div class="footer-section">
            <p class="funding-text">
                Financiado por la Unión Europea – Next Generation EU<br>
                a través del Ministerio de Industria y Turismo
            </p>
            <div class="funding-logos">
                <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                     alt="EU" class="funding-logo">
                <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                     alt="Spain" class="funding-logo">
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chapters = [];
        let selectedVoice = 'alloy';
        let generatedFiles = [];
        let currentAudioguide = null;
        let selectedLibraryItem = null;
        let hasGoogleAPI = false;

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            checkApiConfiguration();
            updateSpeedDisplay();
            checkUrlParams();
        });

        // Check API configuration
        async function checkApiConfiguration() {
            try {
                // Check if Google API is configured by testing the endpoint
                const response = await fetch('/api/multilingual-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: 'test',
                        language: 'es-ES',
                        provider: 'google'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    hasGoogleAPI = data.provider === 'google';
                }
            } catch (error) {
                console.log('Multilingual TTS not configured, using OpenAI only');
            }
        }

        // Check URL parameters
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                loadAudioguideById(id);
            }
        }

        // Load sample content
        function loadSampleContent() {
            const sampleContent = `AUDIOGUIDE: SAMPLE MUSEUM
==================================================

Language: English
Tour Type: comprehensive
Total Stops: 3
AI Model: Sample
Source: Demo

==================================================

STOP 1: INTRODUCTION
------------------------------

Welcome to this remarkable destination. This audioguide will take you on a journey through history, culture, and architectural wonders that have captivated visitors for centuries. As you stand at the entrance, take a moment to appreciate the grandeur of what lies before you.

STOP 2: HISTORY
------------------------------

The history of this location spans centuries of human civilization. From its earliest foundations to the present day, this site has witnessed the rise and fall of empires, the creation of masterpieces, and the preservation of cultural heritage that continues to inspire visitors from around the world.

STOP 3: MAIN ATTRACTION
------------------------------

Before you stands one of the most magnificent examples of architectural achievement. Notice the intricate details that have been carefully preserved through centuries of careful restoration. The craftsmanship visible in every corner tells the story of skilled artisans who dedicated their lives to creating this masterpiece.

==================================================
© CloudGuide - www.cloudguide.me`;

            parseAndLoadContent(sampleContent, 'Sample Museum Tour');
            showNotification('Sample content loaded', 'success');
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseAndLoadContent(content, file.name);
                showNotification(`Loaded: ${file.name}`, 'success');
            };
            reader.readAsText(file);
        }

        // Parse audioguide content into chapters
        function parseAndLoadContent(content, title) {
            const lines = content.split('\n');
            const parsedChapters = [];
            let currentChapter = null;
            let contentBuffer = [];

            for (let line of lines) {
                // Check if this is a chapter header (STOP X: TITLE)
                if (line.match(/^STOP \d+:/)) {
                    // Save previous chapter if exists
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        currentChapter.content = currentChapter.content.replace(/^-+\n?/gm, '').trim();
                        if (currentChapter.content) {
                            parsedChapters.push(currentChapter);
                        }
                    }
                    
                    // Start new chapter
                    currentChapter = {
                        id: parsedChapters.length + 1,
                        title: line.trim(),
                        content: '',
                        selected: false,
                        status: 'pending'
                    };
                    contentBuffer = [];
                } else if (currentChapter && !line.match(/^={3,}$/)) {
                    // Add non-separator lines to content
                    if (!line.match(/^-{3,}$/)) {
                        contentBuffer.push(line);
                    }
                }
            }

            // Save last chapter
            if (currentChapter && contentBuffer.length > 0) {
                currentChapter.content = contentBuffer.join('\n').trim();
                parsedChapters.push(currentChapter);
            }

            if (parsedChapters.length > 0) {
                chapters = parsedChapters;
                currentAudioguide = { title: title, content: content };
                renderChapters();
                document.getElementById('chaptersSection').classList.add('active');
                document.getElementById('actionButtons').style.display = 'flex';
            } else {
                showNotification('No chapters found in the content. Please check the format.', 'error');
            }
        }

        // Render chapters
        function renderChapters() {
            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = chapters.map((chapter, index) => {
                const wordCount = chapter.content.split(' ').filter(w => w).length;
                const estimatedMinutes = Math.ceil(wordCount / 150);
                
                return `
                    <div class="chapter-item ${chapter.selected ? 'selected' : ''}" onclick="toggleChapter(${index})">
                        <input type="checkbox" class="chapter-checkbox" 
                               ${chapter.selected ? 'checked' : ''} 
                               onclick="event.stopPropagation(); toggleChapter(${index})">
                        <div class="chapter-info">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-meta">
                                ${wordCount} words • ~${estimatedMinutes} min audio
                            </div>
                        </div>
                        <div class="chapter-status status-${chapter.status}">${chapter.status}</div>
                    </div>
                `;
            }).join('');
            
            updateSelectionCount();
        }

        // Toggle chapter selection
        function toggleChapter(index) {
            chapters[index].selected = !chapters[index].selected;
            renderChapters();
        }

        // Select all chapters
        function selectAllChapters() {
            chapters.forEach(ch => ch.selected = true);
            renderChapters();
        }

        // Deselect all chapters
        function deselectAllChapters() {
            chapters.forEach(ch => ch.selected = false);
            renderChapters();
        }

        // Update selection count
        function updateSelectionCount() {
            const selected = chapters.filter(ch => ch.selected).length;
            document.getElementById('selectedCount').textContent = selected;
            document.getElementById('totalCount').textContent = chapters.length;
        }

        // Update language settings
        function updateLanguageSettings() {
            const language = document.getElementById('audioLanguage').value;
            const languageNotice = document.getElementById('languageNotice');
            const googleNotice = document.getElementById('googleNotice');
            
            if (!language.startsWith('en-')) {
                if (hasGoogleAPI) {
                    languageNotice.style.display = 'none';
                    googleNotice.style.display = 'block';
                } else {
                    languageNotice.style.display = 'block';
                    googleNotice.style.display = 'none';
                }
            } else {
                languageNotice.style.display = 'none';
                googleNotice.style.display = 'none';
            }
        }

        // Select voice
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Update speed display
        function updateSpeedDisplay() {
            const speed = document.getElementById('speed').value;
            document.getElementById('speedValue').textContent = speed + 'x';
        }

        // Extract content for audio
        function extractContentForAudio(chapter) {
            const skipTitles = document.getElementById('skipTitles').checked;
            const skipDashes = document.getElementById('skipDashes').checked;
            
            let content = chapter.content;
            
            if (skipDashes) {
                content = content.replace(/^-+$/gm, '').trim();
            }
            
            if (!skipTitles) {
                content = chapter.title + '\n\n' + content;
            }
            
            return content.trim();
        }

        // Generate selected chapter
        async function generateSelectedChapter() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                showNotification('Please select at least one chapter', 'warning');
                return;
            }
            if (selected.length > 1) {
                showNotification('Please select only one chapter for single generation', 'warning');
                return;
            }

            await generateAudioForChapter(selected[0]);
        }

        // Generate all selected chapters
        async function generateAllChapters() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                showNotification('Please select at least one chapter', 'warning');
                return;
            }

            // Show progress section
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('filesSection').classList.add('active');
            
            // Initialize progress
            const totalChapters = selected.length;
            let completedChapters = 0;
            
            // Clear and create progress items
            document.getElementById('chapterProgressList').innerHTML = '';
            selected.forEach(chapter => {
                const progressItem = document.createElement('div');
                progressItem.className = 'chapter-progress-item';
                progressItem.id = `progress-${chapter.id}`;
                progressItem.innerHTML = `
                    <div style="font-size: 1.5em;">⏳</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2d3748;">${chapter.title}</div>
                        <div style="font-size: 12px; color: #718096;">Waiting...</div>
                    </div>
                `;
                document.getElementById('chapterProgressList').appendChild(progressItem);
            });

            // Generate audio for each chapter
            for (let chapter of selected) {
                const progressItem = document.getElementById(`progress-${chapter.id}`);
                progressItem.querySelector('div').textContent = '⚙️';
                progressItem.querySelector('div:last-child').textContent = 'Generating audio...';
                
                try {
                    await generateAudioForChapter(chapter);
                    progressItem.querySelector('div').textContent = '✅';
                    progressItem.querySelector('div:last-child').textContent = 'Completed';
                    completedChapters++;
                } catch (error) {
                    progressItem.querySelector('div').textContent = '❌';
                    progressItem.querySelector('div:last-child').textContent = 'Failed: ' + error.message;
                }
                
                // Update overall progress
                const progress = (completedChapters / totalChapters) * 100;
                document.getElementById('overallProgress').style.width = progress + '%';
                document.getElementById('overallPercentage').textContent = Math.round(progress) + '%';
            }
            
            showNotification(`Batch completed: ${completedChapters}/${totalChapters} chapters`, 'success');
        }

        // Generate audio for a single chapter
        async function generateAudioForChapter(chapter) {
            const language = document.getElementById('audioLanguage').value;
            const model = document.getElementById('model').value;
            const speed = parseFloat(document.getElementById('speed').value);
            const textToGenerate = extractContentForAudio(chapter);
            
            // Disable buttons during generation
            document.getElementById('generateSingleBtn').disabled = true;
            document.getElementById('generateBatchBtn').disabled = true;

            try {
                // Try multilingual endpoint first, fallback to OpenAI
                let response = await fetch('/api/multilingual-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToGenerate,
                        language: language,
                        voice: selectedVoice,
                        speed: speed,
                        provider: 'auto' // Let the API decide
                    })
                });

                // Fallback to OpenAI endpoint if multilingual not available
                if (!response.ok) {
                    response = await fetch('/api/openai-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: textToGenerate,
                            voice: selectedVoice,
                            speed: speed,
                            model: model
                        })
                    });
                }

                if (response.ok) {
                    const data = await response.json();
                    if (data.audioUrl) {
                        // Add to generated files
                        const file = {
                            id: Date.now(),
                            name: `${chapter.title.replace(/[^a-z0-9]/gi, '_')}_${language}.mp3`,
                            chapter: chapter.title,
                            language: language,
                            provider: data.provider || 'openai',
                            url: data.audioUrl,
                            duration: `~${Math.ceil(textToGenerate.split(' ').length / 150)} min`
                        };
                        
                        generatedFiles.push(file);
                        renderGeneratedFiles();
                        
                        // Update chapter status
                        chapter.status = 'completed';
                        renderChapters();
                        
                        // Show warning if applicable
                        if (data.warning) {
                            showNotification(data.warning, 'warning');
                        }
                    }
                } else {
                    throw new Error('Failed to generate audio');
                }
            } catch (error) {
                console.error('Audio generation error:', error);
                throw error;
            } finally {
                document.getElementById('generateSingleBtn').disabled = false;
                document.getElementById('generateBatchBtn').disabled = false;
            }
        }

        // Render generated files
        function renderGeneratedFiles() {
            const fileList = document.getElementById('fileList');
            
            if (generatedFiles.length === 0) {
                fileList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No files generated yet</p>';
                return;
            }
            
            fileList.innerHTML = generatedFiles.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <div style="font-size: 1.5em;">🎵</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                ${file.chapter} • ${file.language} • ${file.duration} • ${file.provider}
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-small btn-primary" onclick="playAudio('${file.url}')">Play</button>
                        <button class="btn-small btn-secondary" onclick="downloadFile('${file.url}', '${file.name}')">Download</button>
                    </div>
                </div>
            `).join('');
        }

        // Library Modal Functions
        function openLibraryModal() {
            document.getElementById('libraryModal').style.display = 'block';
            loadLibraryItems();
        }

        function closeLibraryModal() {
            document.getElementById('libraryModal').style.display = 'none';
            selectedLibraryItem = null;
            document.getElementById('loadSelectedBtn').disabled = true;
        }

        function loadLibraryItems() {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const libraryList = document.getElementById('libraryList');
            
            if (audioguides.length === 0) {
                libraryList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <p>No audioguides found in library.</p>
                        <p><a href="index.html" style="color: #48bb78;">Generate some audioguides first!</a></p>
                    </div>
                `;
                return;
            }

            libraryList.innerHTML = audioguides.map((guide, index) => `
                <div class="library-item" onclick="selectLibraryItem(${index}, '${guide.id}')">
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">${guide.title}</div>
                    <div style="font-size: 12px; color: #718096; display: flex; gap: 15px;">
                        <span>📍 ${guide.location}</span>
                        <span>🗣️ ${guide.language}</span>
                        <span>🎯 ${guide.stops} stops</span>
                        <span>📅 ${new Date(guide.date).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectLibraryItem(index, id) {
            document.querySelectorAll('.library-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.library-item').classList.add('selected');
            selectedLibraryItem = index;
            document.getElementById('loadSelectedBtn').disabled = false;
        }

        function loadSelectedAudioguide() {
            if (selectedLibraryItem === null) return;
            
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const guide = audioguides[selectedLibraryItem];
            
            if (guide && guide.content) {
                parseAndLoadContent(guide.content, guide.title);
                closeLibraryModal();
                showNotification(`Loaded: ${guide.title}`, 'success');
            }
        }

        function loadAudioguideById(id) {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const guide = audioguides.find(g => g.id == id);
            
            if (guide && guide.content) {
                parseAndLoadContent(guide.content, guide.title);
                showNotification(`Loaded: ${guide.title}`, 'success');
            }
        }

        // Play audio
        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        // Download file
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('libraryModal');
            if (event.target == modal) {
                closeLibraryModal();
            }
        }
    </script>
</body>
</html>
