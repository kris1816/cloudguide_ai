<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Audio Generation" />
    <meta property="og:description" content="Convert your audioguides to professional audio files in multiple languages" />
    <title>CloudGuide - Audio Generation</title>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            color: #718096;
        }

        .tab-btn.active {
            background: white;
            color: #48bb78;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Text Input Section */
        .text-input-section {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            resize: vertical;
        }

        .text-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
            background: white;
        }

        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Chapters Section */
        .chapters-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: #f7fafc;
        }

        .chapter-item.selected {
            background: #f0fff4;
            border-left: 3px solid #48bb78;
        }

        .chapter-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: #718096;
        }

        .chapter-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #e2e8f0;
            color: #718096;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        /* Voice Grid */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .generate-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .generate-btn {
            flex: 1;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Files Section */
        .files-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .voice-grid {
                grid-template-columns: 1fr;
            }
            .generate-section {
                flex-direction: column;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html" class="active">AUDIO</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Audio Generation</h1>
            <p class="hero-subtitle">Convert Your Audioguides to Professional Audio Files</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('text')">Direct Text Input</button>
                <button class="tab-btn" onclick="switchTab('library')">Load from Library</button>
            </div>

            <!-- Direct Text Input Tab -->
            <div id="textTab" class="tab-content active">
                <div class="text-input-section">
                    <label>Paste Your Audioguide Text</label>
                    <textarea id="textInput" class="text-input" placeholder="Paste your audioguide text here...

Format example:
STOP 1: INTRODUCTION
------------------------------
Your introduction text here...

STOP 2: HISTORY
------------------------------
Your history text here...

STOP 3: MAIN ATTRACTION
------------------------------
Your attraction text here...">STOP 1: INTRODUCTION
------------------------------
Welcome to this remarkable destination. This audioguide will take you on a journey through history, culture, and architectural wonders that have captivated visitors for centuries.

STOP 2: HISTORY
------------------------------
The history of this location spans centuries of human civilization. From its earliest foundations to the present day, this site has witnessed the rise and fall of empires.

STOP 3: MAIN ATTRACTION
------------------------------
Before you stands one of the most magnificent examples of architectural achievement. Notice the intricate details that have been carefully preserved.</textarea>
                    
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="parseChapters()">Parse Chapters</button>
                        <button class="btn btn-secondary" onclick="clearText()">Clear</button>
                        <button class="btn btn-secondary" onclick="loadSample()">Load Sample</button>
                    </div>
                </div>
            </div>

            <!-- Library Tab -->
            <div id="libraryTab" class="tab-content">
                <div class="alert alert-info">
                    Select an audioguide from your library to generate audio.
                </div>
                <div id="libraryList"></div>
            </div>

            <!-- Chapters Section -->
            <div class="chapters-section" id="chaptersSection" style="display: none;">
                <h3 class="section-title">📖 Select Chapters to Generate</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                </div>
                <div class="chapter-list" id="chapterList"></div>
            </div>

            <!-- Settings Grid -->
            <div class="settings-grid">
                <!-- Language Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🌍 Language Settings</h3>
                    
                    <div class="form-group">
                        <label for="audioLanguage">Audio Language</label>
                        <select id="audioLanguage" class="form-element" onchange="updateLanguageInfo()">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish (Spain)</option>
                            <option value="es-MX">Spanish (Mexico)</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-BR">Portuguese (Brazil)</option>
                            <option value="pt-PT">Portuguese (Portugal)</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ko-KR">Korean</option>
                            <option value="ru-RU">Russian</option>
                            <option value="ar-XA">Arabic</option>
                            <option value="hi-IN">Hindi</option>
                        </select>
                    </div>

                    <div id="languageAlert" class="alert alert-warning" style="display: none;">
                        ⚠️ Non-English languages will use English accent. Configure Google Cloud TTS for native pronunciation.
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="skipTitles" checked> 
                            Skip chapter titles (narrate content only)
                        </label>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🎙️ Voice Settings</h3>
                    
                    <div class="form-group">
                        <label>Select Voice</label>
                        <div class="voice-grid">
                            <div class="voice-card selected" onclick="selectVoice(this, 'alloy')">
                                <div style="font-size: 2em;">🎭</div>
                                <div style="font-weight: 600;">Alloy</div>
                                <div style="font-size: 0.85em; color: #718096;">Neutral</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'nova')">
                                <div style="font-size: 2em;">👩</div>
                                <div style="font-weight: 600;">Nova</div>
                                <div style="font-size: 0.85em; color: #718096;">Female</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'echo')">
                                <div style="font-size: 2em;">🎤</div>
                                <div style="font-weight: 600;">Echo</div>
                                <div style="font-size: 0.85em; color: #718096;">Male</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'fable')">
                                <div style="font-size: 2em;">📖</div>
                                <div style="font-weight: 600;">Fable</div>
                                <div style="font-size: 0.85em; color: #718096;">British</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speed">Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" min="0.5" max="1.5" value="1.0" step="0.1" id="speed" class="form-element" oninput="updateSpeed()">
                    </div>
                </div>
            </div>

            <!-- Generate Buttons -->
            <div class="generate-section" id="generateSection" style="display: none;">
                <button class="generate-btn" id="generateSingle" onclick="generateSingle()">
                    🎙️ Generate Selected Chapter
                </button>
                <button class="generate-btn" id="generateAll" onclick="generateAll()" style="background: #667eea;">
                    🎬 Generate All Selected Chapters
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Generating audio... Please wait...</div>
            </div>

            <!-- Generated Files -->
            <div class="files-section" id="filesSection" style="display: none;">
                <h3 class="section-title">🎵 Generated Audio Files</h3>
                <div id="fileList"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p style="font-size: 12px; color: #718096; margin-bottom: 20px;">
                Financiado por la Unión Europea – Next Generation EU<br>
                a través del Ministerio de Industria y Turismo
            </p>
            <div style="display: flex; justify-content: center; gap: 40px;">
                <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                     alt="EU" style="height: 45px; opacity: 0.6;">
                <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                     alt="Spain" style="height: 45px; opacity: 0.6;">
            </div>
        </div>
    </div>

    <script>
        let chapters = [];
        let selectedVoice = 'alloy';
        let generatedFiles = [];

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'text') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('textTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('libraryTab').classList.add('active');
                loadLibrary();
            }
        }

        // Parse chapters from text
        function parseChapters() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            chapters = [];
            const lines = text.split('\n');
            let currentChapter = null;
            let contentBuffer = [];

            for (let line of lines) {
                if (line.match(/^STOP \d+:/i)) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    currentChapter = {
                        id: chapters.length + 1,
                        title: line.trim(),
                        content: '',
                        selected: false,
                        status: 'pending'
                    };
                    contentBuffer = [];
                } else if (currentChapter && !line.match(/^-+$/)) {
                    contentBuffer.push(line);
                }
            }

            if (currentChapter) {
                currentChapter.content = contentBuffer.join('\n').trim();
                if (currentChapter.content) {
                    chapters.push(currentChapter);
                }
            }

            if (chapters.length === 0) {
                // If no chapters found, treat entire text as one chapter
                chapters = [{
                    id: 1,
                    title: 'Full Text',
                    content: text,
                    selected: true,
                    status: 'pending'
                }];
            }

            renderChapters();
            document.getElementById('chaptersSection').style.display = 'block';
            document.getElementById('generateSection').style.display = 'flex';
        }

        // Render chapters
        function renderChapters() {
            const list = document.getElementById('chapterList');
            list.innerHTML = chapters.map((ch, i) => `
                <div class="chapter-item ${ch.selected ? 'selected' : ''}" onclick="toggleChapter(${i})">
                    <input type="checkbox" class="chapter-checkbox" ${ch.selected ? 'checked' : ''}>
                    <div class="chapter-info">
                        <div class="chapter-title">${ch.title}</div>
                        <div class="chapter-meta">${ch.content.split(' ').length} words</div>
                    </div>
                    <div class="chapter-status status-${ch.status}">${ch.status}</div>
                </div>
            `).join('');
        }

        // Toggle chapter selection
        function toggleChapter(index) {
            chapters[index].selected = !chapters[index].selected;
            renderChapters();
        }

        // Select all/none
        function selectAll() {
            chapters.forEach(ch => ch.selected = true);
            renderChapters();
        }

        function selectNone() {
            chapters.forEach(ch => ch.selected = false);
            renderChapters();
        }

        // Clear text
        function clearText() {
            document.getElementById('textInput').value = '';
            chapters = [];
            document.getElementById('chaptersSection').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
        }

        // Load sample
        function loadSample() {
            document.getElementById('textInput').value = `STOP 1: INTRODUCTION
------------------------------
Welcome to the Louvre Museum, one of the world's most visited and celebrated cultural institutions. This magnificent palace turned museum houses over 35,000 works of art spanning thousands of years of human creativity.

STOP 2: HISTORY
------------------------------
The Louvre's history begins in the 12th century as a fortress built by King Philip II. Over centuries, it transformed from a medieval fortress to a Renaissance palace, and finally to the world's largest art museum in 1793.

STOP 3: MONA LISA
------------------------------
Before you stands Leonardo da Vinci's Mona Lisa, perhaps the most famous painting in the world. Notice her enigmatic smile and the revolutionary painting techniques da Vinci employed.`;
            parseChapters();
        }

        // Select voice
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Update speed display
        function updateSpeed() {
            document.getElementById('speedValue').textContent = document.getElementById('speed').value + 'x';
        }

        // Update language info
        async function updateLanguageInfo() {
            const lang = document.getElementById('audioLanguage').value;
            const alert = document.getElementById('languageAlert');
            
            if (!lang.startsWith('en-')) {
                // Check if Google is configured by making a test call
                try {
                    const testResponse = await fetch('/api/multilingual-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: 'test',
                            language: lang,
                            voice: 'alloy',
                            speed: 1.0
                        })
                    });
                    
                    if (testResponse.ok) {
                        const testData = await testResponse.json();
                        if (testData.provider === 'google') {
                            alert.style.display = 'none';
                            showMessage('✅ Google Cloud TTS available for native ' + lang + ' pronunciation', 'success');
                        } else if (testData.warning) {
                            alert.style.display = 'block';
                        }
                    }
                } catch (e) {
                    alert.style.display = 'block';
                }
            } else {
                alert.style.display = 'none';
            }
        }

        // Generate single chapter
        async function generateSingle() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select a chapter');
                return;
            }
            if (selected.length > 1) {
                alert('Please select only one chapter for single generation');
                return;
            }
            
            await generateAudio(selected[0]);
        }

        // Generate all selected
        async function generateAll() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select at least one chapter');
                return;
            }
            
            for (let chapter of selected) {
                await generateAudio(chapter);
            }
        }

        // Generate audio for a chapter
        async function generateAudio(chapter) {
            const language = document.getElementById('audioLanguage').value;
            const speed = parseFloat(document.getElementById('speed').value);
            const skipTitles = document.getElementById('skipTitles').checked;
            
            let textToGenerate = chapter.content;
            if (!skipTitles && chapter.title !== 'Full Text') {
                textToGenerate = chapter.title + '\n\n' + chapter.content;
            }
            
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('generateSingle').disabled = true;
            document.getElementById('generateAll').disabled = true;
            
            try {
                console.log('Generating audio for language:', language);
                console.log('Text length:', textToGenerate.length);
                
                // Use multilingual endpoint
                const response = await fetch('/api/multilingual-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToGenerate,
                        language: language,
                        voice: selectedVoice,
                        speed: speed
                    })
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    // Check for audioUrl in response (not requiring 'success' field)
                    if (data.audioUrl) {
                        // Update chapter status
                        chapter.status = 'completed';
                        renderChapters();
                        
                        // Add to files
                        const file = {
                            name: `${chapter.title.replace(/[^a-z0-9]/gi, '_')}_${language}.mp3`,
                            chapter: chapter.title,
                            language: language,
                            url: data.audioUrl,
                            provider: data.provider || 'openai'
                        };
                        generatedFiles.push(file);
                        renderFiles();
                        
                        // Show success message
                        showMessage(`Audio generated successfully using ${data.provider}`, 'success');
                        
                        // Show warning if applicable
                        if (data.warning) {
                            showMessage(data.warning, 'warning');
                        }
                    } else {
                        throw new Error('No audio URL in response');
                    }
                } else {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    
                    let errorMessage = errorData.error || 'Failed to generate audio';
                    if (errorData.message) {
                        errorMessage += ': ' + errorData.message;
                    }
                    
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error generating audio: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateSingle').disabled = false;
                document.getElementById('generateAll').disabled = false;
            }
        }

        // Show message function
        function showMessage(message, type) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Set color based on type
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'warning') {
                messageDiv.style.background = '#f59e0b';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Render files
        function renderFiles() {
            if (generatedFiles.length === 0) return;
            
            document.getElementById('filesSection').style.display = 'block';
            document.getElementById('fileList').innerHTML = generatedFiles.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <div style="font-size: 1.5em;">🎵</div>
                        <div>
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 0.85em; color: #718096;">
                                ${file.chapter} • ${file.language} • ${file.provider}
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="playAudio('${file.url}')">Play</button>
                        <button class="btn btn-secondary" onclick="downloadAudio('${file.url}', '${file.name}')">Download</button>
                    </div>
                </div>
            `).join('');
        }

        // Play audio
        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        // Download audio
        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Load library
        function loadLibrary() {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const list = document.getElementById('libraryList');
            
            if (audioguides.length === 0) {
                list.innerHTML = '<p style="text-align: center; padding: 40px; color: #718096;">No audioguides in library. <a href="index.html">Generate one first</a>.</p>';
                return;
            }
            
            list.innerHTML = audioguides.map(guide => `
                <div style="padding: 20px; background: #f7fafc; border-radius: 6px; margin-bottom: 15px; cursor: pointer;"
                     onclick="loadFromLibrary('${guide.id}')">
                    <div style="font-weight: 600; margin-bottom: 8px;">${guide.title}</div>
                    <div style="font-size: 0.85em; color: #718096;">
                        ${guide.location} • ${guide.language} • ${guide.stops} stops
                    </div>
                </div>
            `).join('');
        }

        // Load from library
        function loadFromLibrary(id) {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const guide = audioguides.find(g => g.id == id);
            
            if (guide && guide.content) {
                switchTab('text');
                document.getElementById('textInput').value = guide.content;
                parseChapters();
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            updateSpeed();
            updateLanguageInfo();
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                loadFromLibrary(id);
            }
        });
    </script>
</body>
</html>
