<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Audio Generation" />
    <meta property="og:description" content="Convert your audioguides to professional audio files in multiple languages" />
    <title>CloudGuide - Audio Generation</title>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            color: #718096;
        }

        .tab-btn.active {
            background: white;
            color: #48bb78;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Text Input Section */
        .text-input-section {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            resize: vertical;
        }

        .text-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
            background: white;
        }

        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Format Info Box */
        .format-info {
            background: #f0fff4;
            border: 1px solid #48bb78;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #2d3748;
        }

        .format-info strong {
            color: #48bb78;
        }

        /* TTS Optimization Info */
        .tts-optimization-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #92400e;
        }

        .tts-optimization-info h4 {
            margin-bottom: 10px;
            color: #f59e0b;
        }

        /* Chapters Section */
        .chapters-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: #f7fafc;
        }

        .chapter-item.selected {
            background: #f0fff4;
            border-left: 3px solid #48bb78;
        }

        .chapter-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: #718096;
        }

        .chapter-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: #e2e8f0;
            color: #4a5568;
            margin-right: 5px;
        }

        .chapter-type.file {
            background: #dbeafe;
            color: #1e40af;
        }

        .chapter-type.stop {
            background: #fef3c7;
            color: #92400e;
        }

        .chapter-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #e2e8f0;
            color: #718096;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        /* Voice Grid */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-info {
            background: #3182ce;
            color: white;
        }

        .btn-info:hover {
            background: #2c5282;
        }

        .generate-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .generate-btn {
            flex: 1;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Files Section */
        .files-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .cloud-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .voice-grid {
                grid-template-columns: 1fr;
            }
            .generate-section {
                flex-direction: column;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html" class="active">AUDIO</a></li>
                        <li><a href="upload.html">UPLOAD</a></li>
                        <li><a href="premium.html">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Audio Generation</h1>
            <p class="hero-subtitle">Convert Your Audioguides to Professional Audio Files</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- API Status Alert -->
            <div class="alert alert-info" id="apiStatusAlert" style="display: none;">
                <strong>ℹ️ API Configuration:</strong> <span id="apiStatusMessage"></span>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('text')">Direct Text Input</button>
                <button class="tab-btn" onclick="switchTab('library')">Load from Library</button>
            </div>

            <!-- Direct Text Input Tab -->
            <div id="textTab" class="tab-content active">
                <div class="text-input-section">
                    <div class="format-info">
                        <strong>📝 Supported Formats:</strong><br>
                        • <strong>Multi-File Format:</strong> FILE 01: Title → FILE 02: Title<br>
                        • <strong>Stop Format:</strong> STOP 1: Title → STOP 2: Title<br>
                        • <strong>Mixed Format:</strong> Combination of both formats<br>
                        • <strong>Plain Text:</strong> Will be treated as a single chapter
                    </div>

                    <div class="tts-optimization-info">
                        <h4>🎙️ TTS Optimization Enabled</h4>
                        <strong>Automatic text preprocessing includes:</strong><br>
                        • Roman numerals conversion (II → the second, XIV → the fourteenth)<br>
                        • Decades formatting (90s → nineties, 1960s → nineteen sixties)<br>
                        • Century formatting (21st → twenty-first century)<br>
                        • Pronunciation hints for foreign terms<br>
                        • Symbol conversion (% → percent, °C → degrees Celsius)<br>
                        • Eastern European phonetics (Č → ch, Š → sh, Ž → zh)<br>
                        • Time format standardization (3:30 PM → three thirty P M)<br>
                        • Currency symbols ($100 → one hundred dollars)
                    </div>
                    
                    <label>Paste Your Audioguide Text</label>
                    <textarea id="textInput" class="text-input" placeholder="Paste your audioguide text here...

Supported formats:

FORMAT 1 - Multi-File Structure:
FILE 01: INTRODUCTION
*Duration: 5 minutes*
Your introduction text here...

FILE 02: HISTORY
*Duration: 8 minutes*
Your history text here...

FORMAT 2 - Stop Structure:
STOP 1: INTRODUCTION
------------------------------
Your introduction text here...

STOP 2: HISTORY
------------------------------
Your history text here..."></textarea>
                    
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="parseChapters()">Parse Chapters</button>
                        <button class="btn btn-secondary" onclick="clearText()">Clear</button>
                        <button class="btn btn-secondary" onclick="loadSampleMultiFile()">Load Multi-File Sample</button>
                        <button class="btn btn-secondary" onclick="loadSampleStops()">Load Stops Sample</button>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="enableTTSOptimization" checked> 
                            Enable TTS Optimization (preprocesses text for better pronunciation)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Library Tab -->
            <div id="libraryTab" class="tab-content">
                <div class="alert alert-info">
                    Select an audioguide from your library to generate audio.
                </div>
                <div id="libraryList"></div>
            </div>

            <!-- Chapters Section -->
            <div class="chapters-section" id="chaptersSection" style="display: none;">
                <h3 class="section-title">📖 Select Chapters to Generate</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                    <span style="margin-left: auto; font-size: 13px; color: #718096;">
                        <span id="selectedCount">0</span> of <span id="totalCount">0</span> selected
                    </span>
                </div>
                <div class="chapter-list" id="chapterList"></div>
            </div>

            <!-- Settings Grid -->
            <div class="settings-grid">
                <!-- Language Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🌍 Language Settings</h3>
                    
                    <div class="form-group">
                        <label for="audioLanguage">Audio Language</label>
                        <select id="audioLanguage" class="form-element" onchange="updateLanguageInfo()">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish (Spain)</option>
                            <option value="es-MX">Spanish (Mexico)</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-BR">Portuguese (Brazil)</option>
                            <option value="pt-PT">Portuguese (Portugal)</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ko-KR">Korean</option>
                            <option value="ru-RU">Russian</option>
                            <option value="ar-XA">Arabic</option>
                            <option value="hi-IN">Hindi</option>
                        </select>
                    </div>

                    <div id="languageAlert" class="alert alert-warning" style="display: none;">
                        ⚠️ Non-English languages will use English accent. Configure Google Cloud TTS for native pronunciation.
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="skipTitles" checked> 
                            Skip chapter titles (narrate content only)
                        </label>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-section">
                    <h3 class="section-title">🎙️ Voice Settings</h3>
                    
                    <div class="form-group">
                        <label>Select Voice</label>
                        <div class="voice-grid">
                            <div class="voice-card selected" onclick="selectVoice(this, 'alloy')">
                                <div style="font-size: 2em;">🎭</div>
                                <div style="font-weight: 600;">Alloy</div>
                                <div style="font-size: 0.85em; color: #718096;">Neutral</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'nova')">
                                <div style="font-size: 2em;">👩</div>
                                <div style="font-weight: 600;">Nova</div>
                                <div style="font-size: 0.85em; color: #718096;">Female</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'echo')">
                                <div style="font-size: 2em;">🎤</div>
                                <div style="font-weight: 600;">Echo</div>
                                <div style="font-size: 0.85em; color: #718096;">Male</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'fable')">
                                <div style="font-size: 2em;">📖</div>
                                <div style="font-weight: 600;">Fable</div>
                                <div style="font-size: 0.85em; color: #718096;">British</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speed">Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" min="0.5" max="1.5" value="1.0" step="0.1" id="speed" class="form-element" oninput="updateSpeed()">
                    </div>
                </div>
            </div>

            <!-- Generate Buttons -->
            <div class="generate-section" id="generateSection" style="display: none;">
                <button class="generate-btn" id="generateSingle" onclick="generateSingle()">
                    🎙️ Generate Selected Chapter
                </button>
                <button class="generate-btn" id="generateAll" onclick="generateAll()" style="background: #667eea;">
                    🎬 Generate All Selected Chapters
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div id="loadingText">Generating audio... Please wait...</div>
            </div>

            <!-- Generated Files -->
            <div class="files-section" id="filesSection" style="display: none;">
                <h3 class="section-title">🎵 Generated Audio Files</h3>
                <div id="fileList"></div>
                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>✅ Audio files are ready!</strong><br>
                    <small>You can now proceed to the <a href="upload.html" style="color: #065f46; font-weight: 600;">Upload page</a> to submit them to CloudGuide CMS.</small>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p style="font-size: 12px; color: #718096; margin-bottom: 20px;">
                Financiado por la Unión Europea – Next Generation EU<br>
                a través del Ministerio de Industria y Turismo
            </p>
            <div style="display: flex; justify-content: center; gap: 40px;">
                <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                     alt="EU" style="height: 45px; opacity: 0.6;">
                <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                     alt="Spain" style="height: 45px; opacity: 0.6;">
            </div>
        </div>
    </div>

    <script>
        let chapters = [];
        let selectedVoice = 'alloy';
        let generatedFiles = [];
        let currentGuideId = null;
        let currentAudioPlayer = null;

        // Check API configuration on load
        window.addEventListener('DOMContentLoaded', function() {
            checkAPIConfiguration();
            updateSpeed();
            updateLanguageInfo();
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                currentGuideId = id;
                loadFromLibrary(id);
            }
        });

        // Check API configuration
        async function checkAPIConfiguration() {
            try {
                // Test if API is working
                const response = await fetch('/api/openai-tts', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Status:', data);
                } else {
                    showAPIStatus('warning', 'API may not be properly configured. Please check environment variables.');
                }
            } catch (error) {
                console.log('API check failed:', error);
                showAPIStatus('warning', 'Could not verify API configuration. Audio generation may not work.');
            }
        }

        // Show API status
        function showAPIStatus(type, message) {
            const alert = document.getElementById('apiStatusAlert');
            const msg = document.getElementById('apiStatusMessage');
            
            alert.className = `alert alert-${type}`;
            msg.textContent = message;
            alert.style.display = 'block';
        }

        // FIXED: Save audio metadata only (not full data URLs)
        function saveAudioForUpload(guideId, audioFile) {
            if (!guideId) {
                console.error('No guide ID provided for saving audio');
                return false;
            }
            
            try {
                let savedAudioFiles = JSON.parse(localStorage.getItem(`cloudguide_audio_${guideId}`) || '[]');
                
                // Store only lightweight metadata
                const audioMetadata = {
                    name: audioFile.name,
                    url: audioFile.url || 'generated',
                    chapter: audioFile.chapter,
                    language: audioFile.language || 'en-US',
                    provider: audioFile.provider || 'openai',
                    stopNumber: audioFile.stopNumber || savedAudioFiles.length + 1,
                    size: 'Generated',
                    generatedAt: new Date().toISOString()
                };
                
                savedAudioFiles.push(audioMetadata);
                localStorage.setItem(`cloudguide_audio_${guideId}`, JSON.stringify(savedAudioFiles));
                console.log(`✅ Saved audio metadata for ${audioFile.name}`);
                
                return true;
            } catch (error) {
                console.error('Error saving audio metadata:', error);
                if (error.name === 'QuotaExceededError') {
                    showMessage('Storage full! Please clear old data.', 'error');
                }
                return false;
            }
        }

        // TTS Text Preprocessing (keeping your existing function)
        function preprocessTextForTTS(text, language = 'en-US') {
            if (!document.getElementById('enableTTSOptimization').checked) {
                return text;
            }

            let processed = text;

            // Roman Numerals Conversion
            const romanNumerals = {
                'I': '1', 'II': '2', 'III': '3', 'IV': '4', 'V': '5',
                'VI': '6', 'VII': '7', 'VIII': '8', 'IX': '9', 'X': '10',
                'XI': '11', 'XII': '12', 'XIII': '13', 'XIV': '14', 'XV': '15',
                'XVI': '16', 'XVII': '17', 'XVIII': '18', 'XIX': '19', 'XX': '20',
                'XXI': '21'
            };

            // Convert Roman numerals for monarchs and wars
            processed = processed.replace(/\b([IVX]+)\b(?=\s*(century|Century|king|King|queen|Queen|Pope|pope|Emperor|emperor))/g, 
                (match, numeral) => {
                    const number = romanNumerals[numeral];
                    if (number) {
                        const ordinal = getOrdinal(parseInt(number));
                        return ordinal;
                    }
                    return match;
                });

            // World War conversions
            processed = processed.replace(/World War II\b/gi, 'World War Two');
            processed = processed.replace(/World War I\b/gi, 'World War One');
            processed = processed.replace(/WWII\b/gi, 'World War Two');
            processed = processed.replace(/WWI\b/gi, 'World War One');

            // Rest of your preprocessing...
            return processed;
        }

        // Helper functions for TTS preprocessing
        function getOrdinal(num) {
            const ordinals = {
                1: 'first', 2: 'second', 3: 'third', 4: 'fourth', 5: 'fifth',
                6: 'sixth', 7: 'seventh', 8: 'eighth', 9: 'ninth', 10: 'tenth',
                11: 'eleventh', 12: 'twelfth', 13: 'thirteenth', 14: 'fourteenth',
                15: 'fifteenth', 16: 'sixteenth', 17: 'seventeenth', 18: 'eighteenth',
                19: 'nineteenth', 20: 'twentieth', 21: 'twenty-first'
            };
            return ordinals[num] || `${num}th`;
        }

        // Parse chapters
        function parseChapters() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            chapters = [];
            const lines = text.split('\n');
            let currentChapter = null;
            let contentBuffer = [];
            let chapterType = 'unknown';

            console.log('Starting parse, total lines:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                const fileMatch = line.match(/^(?:#{1,3}\s*)?(?:FILE\s+)?(\d+)[\.:]\s*(.+)/i);
                const stopMatch = line.match(/^STOP\s+(\d+):\s*(.+)/i);
                const numberedSectionMatch = line.match(/^(\d+)\.\s+(?:\*\*)?(?:\[)?([^\]]+?)(?:\])?(?:\*\*)?(?:\.|:)?/);
                const isLikelyChapter = line.match(/^(\d+)\.\s+.*(?:Heraklion|Chania|Lasithi|Matala|Rethymno|Eastern Crete|FILE|STOP)/i);
                
                if ((fileMatch && line.includes('FILE')) || (numberedSectionMatch && isLikelyChapter)) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    
                    let chapterNum, chapterTitle;
                    
                    if (fileMatch && line.includes('FILE')) {
                        chapterNum = fileMatch[1];
                        chapterTitle = fileMatch[2].trim();
                    } else if (numberedSectionMatch) {
                        chapterNum = numberedSectionMatch[1];
                        chapterTitle = numberedSectionMatch[2]
                            .replace(/\*\*/g, '')
                            .replace(/\[/g, '')
                            .replace(/\]/g, '')
                            .replace(/:$/g, '')
                            .trim();
                    }
                    
                    let duration = null;
                    if (i + 1 < lines.length && lines[i + 1].includes('Duration:')) {
                        const durationMatch = lines[i + 1].match(/Duration:\s*(.+)/i);
                        if (durationMatch) {
                            duration = durationMatch[1].replace(/[*_]/g, '').trim();
                            i++;
                        }
                    }
                    
                    currentChapter = {
                        id: chapters.length + 1,
                        fileNumber: chapterNum,
                        title: `Section ${chapterNum}: ${chapterTitle}`,
                        shortTitle: chapterTitle,
                        content: '',
                        selected: false,
                        status: 'pending',
                        type: 'section',
                        duration: duration
                    };
                    contentBuffer = [];
                    chapterType = 'section';
                    
                    console.log('Found chapter:', currentChapter.title);
                    
                } else if (stopMatch) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    
                    currentChapter = {
                        id: chapters.length + 1,
                        stopNumber: stopMatch[1],
                        title: `STOP ${stopMatch[1]}: ${stopMatch[2].trim()}`,
                        shortTitle: stopMatch[2].trim(),
                        content: '',
                        selected: false,
                        status: 'pending',
                        type: 'stop'
                    };
                    contentBuffer = [];
                    chapterType = 'stop';
                    
                } else if (currentChapter && !line.match(/^-+$/) && !line.match(/^=+$/) && !line.match(/^#{1,3}\s*$/)) {
                    if (line.trim() || contentBuffer.length > 0) {
                        contentBuffer.push(line);
                    }
                }
            }

            if (currentChapter) {
                currentChapter.content = contentBuffer.join('\n').trim();
                if (currentChapter.content) {
                    chapters.push(currentChapter);
                }
            }

            console.log('Total chapters found:', chapters.length);

            if (chapters.length === 0) {
                chapters = [{
                    id: 1,
                    title: 'Full Text',
                    shortTitle: 'Full Audio Guide',
                    content: text,
                    selected: true,
                    status: 'pending',
                    type: 'full'
                }];
            }

            // Select first 3 chapters by default
            chapters.slice(0, 3).forEach(ch => ch.selected = true);

            renderChapters();
            document.getElementById('chaptersSection').style.display = 'block';
            document.getElementById('generateSection').style.display = 'flex';
            updateSelectedCount();
        }

        // Render chapters
        function renderChapters() {
            const list = document.getElementById('chapterList');
            list.innerHTML = chapters.map((ch, i) => {
                const wordCount = ch.content.split(/\s+/).filter(word => word.length > 0).length;
                const estimatedDuration = Math.ceil(wordCount / 150);
                
                return `
                    <div class="chapter-item ${ch.selected ? 'selected' : ''}" onclick="toggleChapter(${i})">
                        <input type="checkbox" class="chapter-checkbox" ${ch.selected ? 'checked' : ''}>
                        <div class="chapter-info">
                            <div class="chapter-title">
                                <span class="chapter-type ${ch.type}">${ch.type.toUpperCase()}</span>
                                ${ch.shortTitle || ch.title}
                            </div>
                            <div class="chapter-meta">
                                ${wordCount} words • ~${estimatedDuration} min
                                ${ch.duration ? ` • ${ch.duration}` : ''}
                            </div>
                        </div>
                        <div class="chapter-status status-${ch.status}">${ch.status}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalCount').textContent = chapters.length;
        }

        // FIXED: Generate audio with better error handling
        async function generateAudio(chapter) {
            const language = document.getElementById('audioLanguage').value;
            const speed = parseFloat(document.getElementById('speed').value);
            const skipTitles = document.getElementById('skipTitles').checked;
            
            let textToGenerate = chapter.content;
            if (!skipTitles && chapter.title !== 'Full Text') {
                textToGenerate = chapter.shortTitle + '\n\n' + chapter.content;
            }
            
            // Apply TTS preprocessing if enabled
            if (document.getElementById('enableTTSOptimization').checked) {
                textToGenerate = preprocessTextForTTS(textToGenerate, language);
                console.log('Text preprocessed for TTS');
            }
            
            // Check if text is too long and needs chunking
            const MAX_TTS_LENGTH = 3000;
            const textChunks = textToGenerate.length > MAX_TTS_LENGTH 
                ? splitTextIntoChunks(textToGenerate, MAX_TTS_LENGTH)
                : [textToGenerate];
            
            console.log(`Text length: ${textToGenerate.length}, Split into ${textChunks.length} chunks`);
            
            // Show loading
            document.getElementById('loading').classList.add('active');
            const loadingText = document.getElementById('loadingText');
            document.getElementById('generateSingle').disabled = true;
            document.getElementById('generateAll').disabled = true;
            
            const audioUrls = [];
            
            try {
                // Generate audio for each chunk
                for (let i = 0; i < textChunks.length; i++) {
                    const chunk = textChunks[i];
                    console.log(`Generating chunk ${i + 1}/${textChunks.length}, length: ${chunk.length}`);
                    
                    // Update loading message
                    if (textChunks.length > 1) {
                        loadingText.textContent = `Generating audio... Part ${i + 1} of ${textChunks.length}`;
                    } else {
                        loadingText.textContent = `Generating audio for ${chapter.shortTitle || chapter.title}...`;
                    }
                    
                    const response = await fetch('/api/multilingual-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: chunk,
                            language: language,
                            voice: selectedVoice,
                            speed: speed
                        })
                    });

                    console.log(`Chunk ${i + 1} response status:`, response.status);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.audioUrl) {
                            audioUrls.push(data.audioUrl);
                        } else {
                            throw new Error(`No audio URL in response for chunk ${i + 1}`);
                        }
                    } else {
                        // FIXED: Better error handling
                        let errorMessage = 'Failed to generate audio';
                        try {
                            const errorData = await response.json();
                            console.error(`API Error for chunk ${i + 1}:`, errorData);
                            
                            if (errorData.error) {
                                errorMessage = errorData.error;
                            } else if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                            
                            // Check for specific error types
                            if (errorMessage.includes('API key')) {
                                errorMessage = 'OpenAI API key not configured. Please check environment variables.';
                                showAPIStatus('error', errorMessage);
                            }
                        } catch (parseError) {
                            errorMessage = `Server error (${response.status}). Please check API configuration.`;
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    // Small delay between chunks to avoid rate limiting
                    if (i < textChunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Use the first URL (or combine if multiple)
                let finalAudioUrl = audioUrls[0];
                
                // Update chapter status
                chapter.status = 'completed';
                renderChapters();
                
                // Create file object
                const fileName = `${chapter.shortTitle || chapter.title}`.replace(/[^a-z0-9]/gi, '_') + `_${language}.mp3`;
                
                const file = {
                    name: fileName,
                    chapter: chapter.title,
                    language: language,
                    url: finalAudioUrl,
                    provider: 'openai',
                    stopNumber: chapter.stopNumber || chapter.fileNumber || chapter.id,
                    size: 'Generated'
                };
                
                // Add to generated files for preview
                generatedFiles.push(file);
                
                // Save metadata to localStorage
                if (currentGuideId) {
                    saveAudioForUpload(currentGuideId, file);
                }
                
                renderFiles();
                
                // Show success message
                if (audioUrls.length > 1) {
                    showMessage(`✅ Audio generated! (${audioUrls.length} parts)`, 'success');
                } else {
                    showMessage(`✅ Audio generated successfully!`, 'success');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
                chapter.status = 'error';
                renderChapters();
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateSingle').disabled = false;
                document.getElementById('generateAll').disabled = false;
                loadingText.textContent = 'Generating audio... Please wait...';
            }
        }

        // Function to split text into chunks
        function splitTextIntoChunks(text, maxChunkSize = 3000) {
            const chunks = [];
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            let currentChunk = '';
            
            for (const sentence of sentences) {
                if ((currentChunk + sentence).length > maxChunkSize && currentChunk.length > 0) {
                    chunks.push(currentChunk.trim());
                    currentChunk = sentence;
                } else {
                    currentChunk += sentence;
                }
            }
            
            if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
            }
            
            return chunks;
        }

        // Other functions remain the same...
        function toggleChapter(index) {
            chapters[index].selected = !chapters[index].selected;
            renderChapters();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = chapters.filter(ch => ch.selected).length;
            document.getElementById('selectedCount').textContent = selected;
        }

        function selectAll() {
            chapters.forEach(ch => ch.selected = true);
            renderChapters();
            updateSelectedCount();
        }

        function selectNone() {
            chapters.forEach(ch => ch.selected = false);
            renderChapters();
            updateSelectedCount();
        }

        function clearText() {
            document.getElementById('textInput').value = '';
            chapters = [];
            document.getElementById('chaptersSection').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('filesSection').style.display = 'none';
            generatedFiles = [];
        }

        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        function updateSpeed() {
            document.getElementById('speedValue').textContent = document.getElementById('speed').value + 'x';
        }

        function updateLanguageInfo() {
            const lang = document.getElementById('audioLanguage').value;
            const alert = document.getElementById('languageAlert');
            
            if (!lang.startsWith('en-')) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }

        async function generateSingle() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select a chapter');
                return;
            }
            if (selected.length > 1) {
                alert('Please select only one chapter for single generation');
                return;
            }
            
            await generateAudio(selected[0]);
        }

        async function generateAll() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select at least one chapter');
                return;
            }
            
            for (let chapter of selected) {
                await generateAudio(chapter);
                // Small delay between generations to avoid rate limiting
                if (selected.indexOf(chapter) < selected.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            showMessage(`✅ All ${selected.length} audio files generated!`, 'success');
        }

        function renderFiles() {
            if (generatedFiles.length === 0) return;
            
            document.getElementById('filesSection').style.display = 'block';
            document.getElementById('fileList').innerHTML = generatedFiles.map((file, index) => {
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div style="font-size: 1.5em;">🎵</div>
                            <div>
                                <div style="font-weight: 600;">
                                    ${file.name}
                                </div>
                                <div style="font-size: 0.85em; color: #718096;">
                                    ${file.chapter} • ${file.language} • ${file.provider}
                                </div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="playAudio('${file.url}')">Play</button>
                            <button class="btn btn-secondary" onclick="downloadAudio('${file.url}', '${file.name}')">Download</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function playAudio(url) {
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            
            currentAudioPlayer = new Audio(url);
            currentAudioPlayer.play().catch(error => {
                console.error('Play error:', error);
                showMessage('Failed to play audio', 'error');
            });
        }

        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function loadFromLibrary(id) {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const guide = audioguides.find(g => g.id == id);
            
            if (guide && guide.content) {
                currentGuideId = id;
                
                // Load any previously saved audio files
                const savedAudioFiles = localStorage.getItem(`cloudguide_audio_${id}`);
                if (savedAudioFiles) {
                    generatedFiles = JSON.parse(savedAudioFiles);
                    showMessage(`Loaded ${generatedFiles.length} previously generated audio files`, 'info');
                    renderFiles();
                }
                
                switchTab('text');
                document.getElementById('textInput').value = guide.content;
                parseChapters();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'text') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('textTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('libraryTab').classList.add('active');
                loadLibrary();
            }
        }

        function loadLibrary() {
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const libraryGrid = document.getElementById('libraryList');
            
            if (audioguides.length === 0) {
                libraryGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #a0aec0;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📚</div>
                        <p style="font-size: 1.2em; margin-bottom: 15px;">Your library is empty</p>
                        <p><a href="index.html" style="color: #48bb78; text-decoration: none;">Generate your first audioguide →</a></p>
                    </div>
                `;
                return;
            }

            libraryGrid.innerHTML = audioguides.map(guide => {
                // Check if this guide has saved audio files
                const savedAudioFiles = localStorage.getItem(`cloudguide_audio_${guide.id}`);
                const audioCount = savedAudioFiles ? JSON.parse(savedAudioFiles).length : 0;
                const audioIndicator = audioCount > 0 
                    ? `<span style="color: #48bb78;">🎵 ${audioCount} audio files</span>`
                    : '<span style="color: #f6ad55;">No audio generated</span>';
                
                return `
                    <div style="padding: 20px; background: #f7fafc; border-radius: 6px; margin-bottom: 15px; cursor: pointer;"
                         onclick="loadFromLibrary('${guide.id}')">
                        <div style="font-weight: 600; margin-bottom: 8px;">${guide.title}</div>
                        <div style="font-size: 0.85em; color: #718096;">
                            ${guide.location} • ${guide.language} • ${guide.stops} stops • ${audioIndicator}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadSampleMultiFile() {
            document.getElementById('textInput').value = `# CRETE AUDIO GUIDE
## Complete Structured Tour with 4 Stops

---

## FILE 01: INTRODUCTION TO CRETE
*Duration: 5 minutes*

### Opening
Close your eyes for a moment and imagine an island where Zeus was born in a mountain cave, where Europe's first civilization built palaces without fortification walls. In the 21st century, this island still maintains traditions from the 1960s.

### The Great Island
This isn't just Greece's largest island; it's home to 15% of the country's archaeological sites, with temperatures reaching 40°C in summer. King Minos III ruled here in 1500 BCE.

---

## FILE 02: HISTORY OF CRETE
*Duration: 8 minutes*

### Ancient Origins
To understand Crete, you must first grasp that this island has been prized for over 4,000 years. World War II saw fierce battles here, and the 90s brought modern tourism.

### The Minoan Civilization
Our story begins around 3000 BCE, when the Minoans created Europe's first advanced civilization. The palace had rooms at 22°C year-round.`;
            parseChapters();
        }

        function loadSampleStops() {
            document.getElementById('textInput').value = `STOP 1: INTRODUCTION
------------------------------
Welcome to the Louvre Museum, built in the 12th century by King Philip II. The museum houses 35,000 works, with 65% from European artists. Napoleon III expanded it in the 1850s.

STOP 2: HISTORY
------------------------------
The Louvre began as a fortress in 1190 CE. During World War II, artworks were hidden. The pyramid entrance was added in the 20th century, specifically in 1989.

STOP 3: MONA LISA
------------------------------
Leonardo da Vinci's masterpiece from the 16th century. The painting measures 77cm × 53cm. It survived theft in the early 20th century. Room temperature is maintained at 21°C with 50% humidity.`;
            parseChapters();
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'warning') {
                messageDiv.style.background = '#f59e0b';
                messageDiv.style.color = 'white';
            } else if (type === 'info') {
                messageDiv.style.background = '#3182ce';
                messageDiv.style.color = 'white';
            } else if (type === 'error') {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
