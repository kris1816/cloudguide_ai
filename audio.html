<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide Audio Generation" />
    <meta property="og:description" content="Convert your audioguides to professional audio files in multiple languages" />
    <title>CloudGuide - Audio Generation</title>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            color: #718096;
        }

        .tab-btn.active {
            background: white;
            color: #48bb78;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Text Input Section */
        .text-input-section {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            resize: vertical;
        }

        .text-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
            background: white;
        }

        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Chapters Section */
        .chapters-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chapter-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }

        .chapter-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: #f7fafc;
        }

        .chapter-item.selected {
            background: #f0fff4;
            border-left: 3px solid #48bb78;
        }

        .chapter-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: #718096;
        }

        .chapter-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #e2e8f0;
            color: #718096;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            background: #f7fafc;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        /* Voice Grid */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .voice-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
        }

        .voice-card:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .voice-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .generate-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .generate-btn {
            flex: 1;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Files Section */
        .files-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* API Setup Section */
        .api-setup {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-setup h3 {
            color: #92400e;
            margin-bottom: 15px;
        }

        /* Storage Options */
        .storage-options {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .storage-option {
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .voice-grid {
                grid-template-columns: 1fr;
            }
            .generate-section {
                flex-direction: column;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html" class="active">AUDIO</a></li>
                        <li><a href="upload.html">UPLOAD</a></li>
                        <li><a href="premium.html">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Audio Generation</h1>
            <p class="hero-subtitle">Convert Your Audioguides to Professional Audio Files</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- API Status Alert -->
            <div class="alert" id="apiStatusAlert" style="display: none;">
                <span id="apiStatusMessage"></span>
            </div>

            <!-- Storage Options -->
            <div class="storage-options">
                <h4 style="margin-bottom: 10px;">üìÅ Audio Storage Options</h4>
                <div class="storage-option">
                    <label>
                        <input type="radio" name="storage" value="local" checked> 
                        <strong>Local Storage</strong> - Quick, no upload needed (limited to ~5MB per guide)
                    </label>
                </div>
                <div class="storage-option">
                    <label>
                        <input type="radio" name="storage" value="cloudinary"> 
                        <strong>Cloudinary</strong> - Unlimited storage, permanent URLs (requires setup)
                    </label>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('text')">Direct Text Input</button>
                <button class="tab-btn" onclick="switchTab('library')">Load from Library</button>
            </div>

            <!-- Direct Text Input Tab -->
            <div id="textTab" class="tab-content active">
                <div class="text-input-section">
                    <label>Paste Your Audioguide Text</label>
                    <textarea id="textInput" class="text-input" placeholder="Paste your audioguide text here...

Supported formats:

STOP 1: INTRODUCTION
------------------------------
Your introduction text here...

STOP 2: HISTORY
------------------------------
Your history text here..."></textarea>
                    
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="parseChapters()">Parse Chapters</button>
                        <button class="btn btn-secondary" onclick="clearText()">Clear</button>
                        <button class="btn btn-secondary" onclick="loadSampleStops()">Load Sample</button>
                    </div>
                </div>
            </div>

            <!-- Library Tab -->
            <div id="libraryTab" class="tab-content">
                <div class="alert alert-info">
                    Select an audioguide from your library to generate audio.
                </div>
                <div id="libraryList"></div>
            </div>

            <!-- Chapters Section -->
            <div class="chapters-section" id="chaptersSection" style="display: none;">
                <h3 class="section-title">üìñ Select Chapters to Generate</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                    <span style="margin-left: auto; font-size: 13px; color: #718096;">
                        <span id="selectedCount">0</span> of <span id="totalCount">0</span> selected
                    </span>
                </div>
                <div class="chapter-list" id="chapterList"></div>
            </div>

            <!-- Settings Grid -->
            <div class="settings-grid">
                <!-- Language Settings -->
                <div class="settings-section">
                    <h3 class="section-title">üåç Language Settings</h3>
                    
                    <div class="form-group">
                        <label for="audioLanguage">Audio Language</label>
                        <select id="audioLanguage" class="form-element" onchange="updateLanguageInfo()">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish (Spain)</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-BR">Portuguese (Brazil)</option>
                            <option value="zh-CN">Chinese (Simplified)</option>
                            <option value="ja-JP">Japanese</option>
                        </select>
                    </div>

                    <div id="languageAlert" class="alert alert-warning" style="display: none;">
                        ‚ö†Ô∏è Non-English languages will use English accent with OpenAI TTS unless Google Cloud API is configured.
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-section">
                    <h3 class="section-title">üéôÔ∏è Voice Settings</h3>
                    
                    <div class="form-group">
                        <label>Select Voice</label>
                        <div class="voice-grid">
                            <div class="voice-card selected" onclick="selectVoice(this, 'alloy')">
                                <div style="font-size: 2em;">üé≠</div>
                                <div style="font-weight: 600;">Alloy</div>
                                <div style="font-size: 0.85em; color: #718096;">Neutral</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'nova')">
                                <div style="font-size: 2em;">üë©</div>
                                <div style="font-weight: 600;">Nova</div>
                                <div style="font-size: 0.85em; color: #718096;">Female</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'echo')">
                                <div style="font-size: 2em;">üé§</div>
                                <div style="font-weight: 600;">Echo</div>
                                <div style="font-size: 0.85em; color: #718096;">Male</div>
                            </div>
                            <div class="voice-card" onclick="selectVoice(this, 'fable')">
                                <div style="font-size: 2em;">üìñ</div>
                                <div style="font-weight: 600;">Fable</div>
                                <div style="font-size: 0.85em; color: #718096;">British</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speed">Speed: <span id="speedValue">1.0x</span></label>
                        <input type="range" min="0.5" max="1.5" value="1.0" step="0.1" id="speed" class="form-element" oninput="updateSpeed()">
                    </div>
                </div>
            </div>

            <!-- Generate Buttons -->
            <div class="generate-section" id="generateSection" style="display: none;">
                <button class="generate-btn" id="generateSingle" onclick="generateSingle()">
                    üéôÔ∏è Generate Selected Chapter
                </button>
                <button class="generate-btn" id="generateAll" onclick="generateAll()" style="background: #667eea;">
                    üé¨ Generate All Selected Chapters
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div id="loadingText">Generating audio... Please wait...</div>
            </div>

            <!-- Generated Files -->
            <div class="files-section" id="filesSection" style="display: none;">
                <h3 class="section-title">üéµ Generated Audio Files</h3>
                <div id="fileList"></div>
                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>‚úÖ Audio files are ready!</strong><br>
                    <small>You can now proceed to the <a href="upload.html" style="color: #065f46; font-weight: 600;">Upload page</a> to submit them to CloudGuide CMS.</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chapters = [];
        let selectedVoice = 'alloy';
        let generatedFiles = [];
        let currentGuideId = null;
        let currentAudioPlayer = null;
        let apiConfigured = false;
        let currentGuideData = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Audio page initialized');
            checkAPIConfiguration();
            updateSpeed();
            updateLanguageInfo();
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id) {
                console.log('Loading guide from URL param:', id);
                currentGuideId = id;
                loadFromLibrary(id);
            }
            
            // Debug: Check localStorage
            console.log('Current localStorage keys:', Object.keys(localStorage));
            console.log('Audioguides in storage:', localStorage.getItem('cloudguide_audioguides'));
        });

        // Check API configuration
        async function checkAPIConfiguration() {
            try {
                // First check if the multilingual endpoint exists
                const response = await fetch('/api/multilingual-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: 'Test',
                        language: 'en-US',
                        voice: 'alloy',
                        speed: 1.0
                    })
                });
                
                console.log('API Configuration check response:', response.status);
                
                if (response.status === 500 || response.status === 501) {
                    const data = await response.json();
                    console.log('API Configuration issue:', data);
                    
                    if (data.error && data.error.includes('not configured')) {
                        showAPIStatus('warning', 'OpenAI API key may not be configured. Audio generation might not work.');
                        apiConfigured = false;
                        return;
                    }
                }
                
                if (response.ok) {
                    apiConfigured = true;
                    console.log('API is configured and working');
                }
            } catch (error) {
                console.log('API check failed:', error);
                showAPIStatus('info', 'Audio generation API status unknown. Proceeding anyway.');
            }
        }

        // Show API status
        function showAPIStatus(type, message) {
            const alert = document.getElementById('apiStatusAlert');
            const msg = document.getElementById('apiStatusMessage');
            
            const alertClass = {
                'error': 'alert-error',
                'warning': 'alert-warning',
                'info': 'alert-info',
                'success': 'alert-success'
            };
            
            alert.className = `alert ${alertClass[type] || 'alert-info'}`;
            msg.innerHTML = message;
            alert.style.display = 'block';
        }

        // Upload audio to Cloudinary
        async function uploadToCloudinary(audioData, fileName) {
            const storageType = document.querySelector('input[name="storage"]:checked').value;
            
            if (storageType === 'local') {
                // Just return the base64 data URL for local storage
                console.log('Using local storage for audio');
                return audioData;
            }
            
            try {
                console.log('Uploading to Cloudinary:', fileName);
                
                const response = await fetch('/api/upload-to-cloudinary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audioData: audioData,
                        fileName: fileName
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Cloudinary upload successful:', data.url);
                    return data.url;
                } else {
                    console.error('Cloudinary upload failed, using local storage');
                    return audioData;
                }
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                return audioData; // Fallback to base64 data URL
            }
        }

        // Generate audio with better error handling and Cloudinary upload
        async function generateAudio(chapter) {
            const language = document.getElementById('audioLanguage').value;
            const speed = parseFloat(document.getElementById('speed').value);
            
            let textToGenerate = chapter.content;
            
            // Show loading
            document.getElementById('loading').classList.add('active');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = `Generating audio for ${chapter.shortTitle || chapter.title}...`;
            document.getElementById('generateSingle').disabled = true;
            document.getElementById('generateAll').disabled = true;
            
            try {
                // Try multilingual endpoint first
                let response = await fetch('/api/multilingual-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToGenerate,
                        language: language,
                        voice: selectedVoice,
                        speed: speed
                    })
                });
                
                // If multilingual fails, try simple OpenAI endpoint as fallback
                if (!response.ok && response.status === 500) {
                    console.log('Multilingual TTS failed, trying OpenAI fallback...');
                    
                    // Only fallback for English
                    if (language.startsWith('en-')) {
                        response = await fetch('/api/openai-tts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: textToGenerate,
                                voice: selectedVoice,
                                speed: speed
                            })
                        });
                        
                        if (response.ok) {
                            showMessage('‚ö†Ô∏è Using fallback TTS API', 'warning');
                        }
                    }
                }

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.audioUrl || data.audioData) {
                        // Upload to Cloudinary if selected
                        loadingText.textContent = `Storing audio for ${chapter.shortTitle || chapter.title}...`;
                        const fileName = `${chapter.shortTitle || chapter.title}`.replace(/[^a-z0-9]/gi, '_') + `_${language}.mp3`;
                        const audioUrl = await uploadToCloudinary(data.audioUrl || data.audioData, fileName);
                        
                        // Update chapter status
                        chapter.status = 'completed';
                        renderChapters();
                        
                        // Create file object
                        const file = {
                            name: fileName,
                            chapter: chapter.title,
                            language: language,
                            url: audioUrl,
                            provider: data.provider || 'openai',
                            stopNumber: chapter.stopNumber || chapter.id,
                            size: 'Generated',
                            isCloudinary: audioUrl.includes('cloudinary.com'),
                            warning: data.warning
                        };
                        
                        // Add to generated files
                        generatedFiles.push(file);
                        
                        // Save metadata to localStorage
                        if (currentGuideId) {
                            saveAudioForUpload(currentGuideId, file);
                        }
                        
                        renderFiles();
                        
                        if (data.warning) {
                            showMessage(`‚úÖ Audio generated! ${data.warning}`, 'warning');
                        } else {
                            showMessage(`‚úÖ Audio generated successfully!`, 'success');
                        }
                    }
                } else {
                    let errorMessage = 'Failed to generate audio';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error (${response.status})`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
                chapter.status = 'error';
                renderChapters();
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateSingle').disabled = false;
                document.getElementById('generateAll').disabled = false;
            }
        }

        // Save audio metadata
        function saveAudioForUpload(guideId, audioFile) {
            if (!guideId) {
                console.error('No guide ID provided for saving audio');
                return false;
            }
            
            try {
                let savedAudioFiles = JSON.parse(localStorage.getItem(`cloudguide_audio_${guideId}`) || '[]');
                
                const audioMetadata = {
                    name: audioFile.name,
                    url: audioFile.url,
                    chapter: audioFile.chapter,
                    language: audioFile.language || 'en-US',
                    provider: audioFile.provider || 'openai',
                    stopNumber: audioFile.stopNumber || savedAudioFiles.length + 1,
                    size: 'Generated',
                    isCloudinary: audioFile.isCloudinary || false,
                    generatedAt: new Date().toISOString()
                };
                
                savedAudioFiles.push(audioMetadata);
                localStorage.setItem(`cloudguide_audio_${guideId}`, JSON.stringify(savedAudioFiles));
                console.log(`‚úÖ Saved audio metadata for guide ${guideId}:`, audioMetadata);
                
                // Also ensure the guide itself exists in library
                ensureGuideInLibrary(guideId);
                
                return true;
            } catch (error) {
                console.error('Error saving audio metadata:', error);
                if (error.name === 'QuotaExceededError') {
                    showMessage('Storage full! Consider using Cloudinary storage.', 'error');
                }
                return false;
            }
        }

        // Ensure guide exists in library
        function ensureGuideInLibrary(guideId) {
            let library = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            const exists = library.find(g => g.id == guideId);
            
            if (!exists && currentGuideData) {
                // Add the current guide to library if it doesn't exist
                const guideToSave = {
                    id: guideId,
                    title: currentGuideData.title || 'Untitled Guide',
                    location: currentGuideData.location || currentGuideData.title || 'Unknown',
                    content: currentGuideData.content || document.getElementById('textInput').value,
                    language: currentGuideData.language || 'English',
                    stops: currentGuideData.stops || chapters.length,
                    date: new Date().toISOString(),
                    type: 'generated'
                };
                
                library.unshift(guideToSave);
                localStorage.setItem('cloudguide_audioguides', JSON.stringify(library));
                console.log('Added guide to library:', guideToSave);
            }
        }

        // Parse chapters
        function parseChapters() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Please enter some text first');
                return;
            }

            // If no guide ID, create one
            if (!currentGuideId) {
                currentGuideId = Date.now().toString();
                console.log('Created new guide ID:', currentGuideId);
            }

            chapters = [];
            const lines = text.split('\n');
            let currentChapter = null;
            let contentBuffer = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                const stopMatch = line.match(/^STOP\s+(\d+):\s*(.+)/i);
                
                if (stopMatch) {
                    if (currentChapter) {
                        currentChapter.content = contentBuffer.join('\n').trim();
                        if (currentChapter.content) {
                            chapters.push(currentChapter);
                        }
                    }
                    
                    currentChapter = {
                        id: chapters.length + 1,
                        stopNumber: stopMatch[1],
                        title: `STOP ${stopMatch[1]}: ${stopMatch[2].trim()}`,
                        shortTitle: stopMatch[2].trim(),
                        content: '',
                        selected: false,
                        status: 'pending',
                        type: 'stop'
                    };
                    contentBuffer = [];
                    
                } else if (currentChapter && !line.match(/^-+$/)) {
                    if (line.trim() || contentBuffer.length > 0) {
                        contentBuffer.push(line);
                    }
                }
            }

            if (currentChapter) {
                currentChapter.content = contentBuffer.join('\n').trim();
                if (currentChapter.content) {
                    chapters.push(currentChapter);
                }
            }

            if (chapters.length === 0) {
                chapters = [{
                    id: 1,
                    title: 'Full Text',
                    shortTitle: 'Full Audio Guide',
                    content: text,
                    selected: true,
                    status: 'pending',
                    type: 'full'
                }];
            }

            // Select first 3 chapters by default
            chapters.slice(0, 3).forEach(ch => ch.selected = true);

            // Save current guide data
            currentGuideData = {
                title: 'Manual Entry',
                content: text,
                stops: chapters.length,
                language: document.getElementById('audioLanguage').value
            };

            renderChapters();
            document.getElementById('chaptersSection').style.display = 'block';
            document.getElementById('generateSection').style.display = 'flex';
            updateSelectedCount();
        }

        // Render chapters
        function renderChapters() {
            const list = document.getElementById('chapterList');
            list.innerHTML = chapters.map((ch, i) => {
                const wordCount = ch.content.split(/\s+/).filter(word => word.length > 0).length;
                const estimatedDuration = Math.ceil(wordCount / 150);
                
                return `
                    <div class="chapter-item ${ch.selected ? 'selected' : ''}" onclick="toggleChapter(${i})">
                        <input type="checkbox" class="chapter-checkbox" ${ch.selected ? 'checked' : ''}>
                        <div class="chapter-info">
                            <div class="chapter-title">${ch.shortTitle || ch.title}</div>
                            <div class="chapter-meta">
                                ${wordCount} words ‚Ä¢ ~${estimatedDuration} min
                            </div>
                        </div>
                        <div class="chapter-status status-${ch.status}">${ch.status}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalCount').textContent = chapters.length;
        }

        // Toggle chapter
        function toggleChapter(index) {
            chapters[index].selected = !chapters[index].selected;
            renderChapters();
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            const selected = chapters.filter(ch => ch.selected).length;
            document.getElementById('selectedCount').textContent = selected;
        }

        // Select all
        function selectAll() {
            chapters.forEach(ch => ch.selected = true);
            renderChapters();
            updateSelectedCount();
        }

        // Select none
        function selectNone() {
            chapters.forEach(ch => ch.selected = false);
            renderChapters();
            updateSelectedCount();
        }

        // Clear text
        function clearText() {
            document.getElementById('textInput').value = '';
            chapters = [];
            document.getElementById('chaptersSection').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('filesSection').style.display = 'none';
            generatedFiles = [];
        }

        // Select voice
        function selectVoice(element, voice) {
            document.querySelectorAll('.voice-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedVoice = voice;
        }

        // Update speed
        function updateSpeed() {
            document.getElementById('speedValue').textContent = document.getElementById('speed').value + 'x';
        }

        // Update language info
        function updateLanguageInfo() {
            const lang = document.getElementById('audioLanguage').value;
            const alert = document.getElementById('languageAlert');
            
            if (!lang.startsWith('en-')) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }

        // Generate single
        async function generateSingle() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select a chapter');
                return;
            }
            if (selected.length > 1) {
                alert('Please select only one chapter for single generation');
                return;
            }
            
            await generateAudio(selected[0]);
        }

        // Generate all
        async function generateAll() {
            const selected = chapters.filter(ch => ch.selected);
            if (selected.length === 0) {
                alert('Please select at least one chapter');
                return;
            }
            
            for (let chapter of selected) {
                await generateAudio(chapter);
                // Small delay between generations
                if (selected.indexOf(chapter) < selected.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            showMessage(`‚úÖ All ${selected.length} audio files generated!`, 'success');
        }

        // Render files
        function renderFiles() {
            if (generatedFiles.length === 0) return;
            
            document.getElementById('filesSection').style.display = 'block';
            document.getElementById('fileList').innerHTML = generatedFiles.map((file, index) => {
                const storageIcon = file.isCloudinary ? '‚òÅÔ∏è' : 'üíæ';
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div style="font-size: 1.5em;">üéµ</div>
                            <div>
                                <div style="font-weight: 600;">${file.name}</div>
                                <div style="font-size: 0.85em; color: #718096;">
                                    ${file.chapter} ‚Ä¢ ${file.language} ‚Ä¢ ${file.provider} ‚Ä¢ ${storageIcon}
                                    ${file.warning ? ' ‚Ä¢ ‚ö†Ô∏è ' + file.warning : ''}
                                </div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="playAudio('${file.url}')">Play</button>
                            <button class="btn btn-secondary" onclick="downloadAudio('${file.url}', '${file.name}')">Download</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Play audio with toggle
        function playAudio(url) {
            if (currentAudioPlayer && currentAudioPlayer.src === url && !currentAudioPlayer.paused) {
                currentAudioPlayer.pause();
                showMessage('Audio paused', 'info');
                return;
            }
            
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            
            currentAudioPlayer = new Audio(url);
            currentAudioPlayer.play().then(() => {
                showMessage('Playing audio...', 'info');
            }).catch(error => {
                console.error('Play error:', error);
                showMessage('Failed to play audio', 'error');
            });
            
            currentAudioPlayer.addEventListener('ended', () => {
                showMessage('Audio finished', 'info');
                currentAudioPlayer = null;
            });
        }

        // Download audio
        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Load from library
        function loadFromLibrary(id) {
            console.log('Loading guide from library, ID:', id);
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            console.log('Total guides in library:', audioguides.length);
            
            const guide = audioguides.find(g => g.id == id);
            
            if (guide && guide.content) {
                console.log('Found guide:', guide);
                currentGuideId = id;
                currentGuideData = guide;
                
                // Load any previously saved audio files
                const savedAudioFiles = localStorage.getItem(`cloudguide_audio_${id}`);
                if (savedAudioFiles) {
                    try {
                        generatedFiles = JSON.parse(savedAudioFiles);
                        showMessage(`Loaded ${generatedFiles.length} previously generated audio files`, 'info');
                        renderFiles();
                    } catch (e) {
                        console.error('Error loading saved audio:', e);
                        generatedFiles = [];
                    }
                }
                
                switchTab('text');
                document.getElementById('textInput').value = guide.content;
                
                // Set the language if it exists
                if (guide.language) {
                    const langSelect = document.getElementById('audioLanguage');
                    // Try to match language
                    Array.from(langSelect.options).forEach(option => {
                        if (option.text.toLowerCase().includes(guide.language.toLowerCase())) {
                            langSelect.value = option.value;
                        }
                    });
                }
                
                parseChapters();
            } else {
                console.error('Guide not found or has no content, ID:', id);
                showMessage('Could not load audioguide', 'error');
            }
        }

        // Switch tab
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'text') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('textTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('libraryTab').classList.add('active');
                loadLibrary();
            }
        }

        // Load library
        function loadLibrary() {
            console.log('Loading library for audio generation...');
            const audioguides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            console.log('Found', audioguides.length, 'audioguides in library');
            
            const libraryGrid = document.getElementById('libraryList');
            
            if (audioguides.length === 0) {
                libraryGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #a0aec0;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìö</div>
                        <p style="font-size: 1.2em; margin-bottom: 15px;">Your library is empty</p>
                        <p><a href="index.html" style="color: #48bb78; text-decoration: none;">Generate your first audioguide ‚Üí</a></p>
                    </div>
                `;
                return;
            }

            libraryGrid.innerHTML = audioguides.map(guide => {
                // Check if this guide has saved audio files
                const savedAudioFiles = localStorage.getItem(`cloudguide_audio_${guide.id}`);
                let audioCount = 0;
                try {
                    if (savedAudioFiles) {
                        audioCount = JSON.parse(savedAudioFiles).length;
                    }
                } catch (e) {
                    console.error('Error parsing audio files for guide', guide.id);
                }
                
                const audioIndicator = audioCount > 0 
                    ? `<span style="color: #48bb78;">üéµ ${audioCount} audio files</span>`
                    : '<span style="color: #f6ad55;">No audio generated</span>';
                
                // Better handling of title
                const title = guide.title || guide.location || 'Untitled Guide';
                const location = guide.location || guide.title || 'Unknown Location';
                const language = guide.language || 'English';
                const stops = guide.stops || '?';
                
                return `
                    <div style="padding: 20px; background: #f7fafc; border-radius: 6px; margin-bottom: 15px; cursor: pointer;"
                         onclick="loadFromLibrary('${guide.id}')">
                        <div style="font-weight: 600; margin-bottom: 8px;">${title}</div>
                        <div style="font-size: 0.85em; color: #718096;">
                            ${location} ‚Ä¢ ${language} ‚Ä¢ ${stops} stops ‚Ä¢ ${audioIndicator}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Library loaded with', audioguides.length, 'guides');
        }

        // Load sample
        function loadSampleStops() {
            document.getElementById('textInput').value = `STOP 1: INTRODUCTION
------------------------------
Welcome to this remarkable destination. This audioguide will take you on a journey through history, culture, and human achievement. As you explore today, you will discover the many layers of significance that make this place truly special.

STOP 2: HISTORY
------------------------------
The history of this location spans centuries of human civilization. From its earliest foundations to the present day, this site has witnessed the rise and fall of empires, the creation of masterpieces, and the preservation of cultural heritage.

STOP 3: MAIN ATTRACTION
------------------------------
Before you stands the main attraction, a testament to human creativity and ingenuity. Notice the intricate details and the careful craftsmanship that went into creating this remarkable feature.`;
            parseChapters();
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                messageDiv.style.background = '#48bb78';
                messageDiv.style.color = 'white';
            } else if (type === 'error') {
                messageDiv.style.background = '#e53e3e';
                messageDiv.style.color = 'white';
            } else if (type === 'warning') {
                messageDiv.style.background = '#f6ad55';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#3182ce';
                messageDiv.style.color = 'white';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
