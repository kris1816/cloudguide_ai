<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudGuide - AI Audioguide Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo {
            height: 70px;
            margin-bottom: 20px;
        }

        h1 {
            color: #2d2d2d;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2d2d2d;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .location-examples {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .location-examples h4 {
            color: #2d2d2d;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-btn {
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 16px;
        }

        .success-message {
            display: none;
            background: #10b981;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .success-message.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .file-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e8edff;
        }

        .file-info {
            display: none;
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .file-info.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-file-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .remove-file-btn:hover {
            background: #dc2626;
        }

        .funding-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .funding-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .funding-logo {
            height: 60px;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .funding-logos {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" 
                 alt="CloudGuide" class="logo">
            <h1>CloudGuide AI</h1>
            <p class="subtitle">Generate Professional Audioguides for Any Location</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('location')">üìç Location Input</button>
            <button class="tab-btn" onclick="switchTab('file')">üìÑ File Upload</button>
        </div>

        <div class="form-group">
            <label for="aiModel">AI Model</label>
            <select id="aiModel">
                <option value="deepseek">DeepSeek (Default)</option>
                <option value="openai">ChatGPT (OpenAI)</option>
            </select>
        </div>

        <!-- Location Input Tab -->
        <div id="locationTab" class="tab-content active">
            <div class="form-group">
                <label for="location">Location Name *</label>
                <input type="text" id="location" placeholder="Enter any museum, landmark, city, or cultural site...">
                <div class="location-examples">
                    <h4>Quick Examples:</h4>
                    <div class="example-buttons">
                        <button class="example-btn" onclick="setExample('Louvre Museum Paris')">Louvre Museum</button>
                        <button class="example-btn" onclick="setExample('Sagrada Familia Barcelona')">Sagrada Familia</button>
                        <button class="example-btn" onclick="setExample('Vatican Museums')">Vatican Museums</button>
                        <button class="example-btn" onclick="setExample('Alhambra Granada')">Alhambra Granada</button>
                        <button class="example-btn" onclick="setExample('Acropolis Athens')">Acropolis Athens</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Tab -->
        <div id="fileTab" class="tab-content">
            <div class="form-group">
                <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" style="display: none;" onchange="handleFileUpload(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Click to upload or drag and drop</p>
                    <p style="color: #666; font-size: 14px;">PDF, Word, or TXT files (max 10MB)</p>
                </div>
                <div class="file-info" id="fileInfo">
                    <div>
                        <div style="font-weight: 600;" id="fileName">No file</div>
                        <div style="color: #666; font-size: 14px;" id="fileSize">0 KB</div>
                    </div>
                    <button class="remove-file-btn" onclick="removeFile()">Remove</button>
                </div>
            </div>
            <div class="form-group">
                <label for="fileLocation">Location Name (from document) *</label>
                <input type="text" id="fileLocation" placeholder="Enter the location this document is about...">
            </div>
        </div>

        <div class="config-grid">
            <div class="form-group">
                <label for="language">Output Language</label>
                <select id="language">
                    <option value="English">English</option>
                    <option value="Spanish">Espa√±ol</option>
                    <option value="French">Fran√ßais</option>
                    <option value="German">Deutsch</option>
                    <option value="Italian">Italiano</option>
                    <option value="Portuguese">Portugu√™s</option>
                    <option value="Chinese">‰∏≠Êñá</option>
                    <option value="Japanese">Êó•Êú¨Ë™û</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tourType">Tour Type</label>
                <select id="tourType">
                    <option value="comprehensive">Comprehensive Overview</option>
                    <option value="historical">Historical Focus</option>
                    <option value="cultural">Cultural Heritage</option>
                    <option value="family">Family Friendly</option>
                    <option value="artistic">Art & Architecture</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="stops">Number of Stops</label>
            <input type="number" id="stops" min="5" max="15" value="8">
            <small style="color: #666; display: block; margin-top: 5px;">
                Each tour includes: Introduction, History, Local Cuisine, and Practical Tips as mandatory stops
            </small>
        </div>

        <div class="form-group">
            <label for="context">Additional Context (Optional)</label>
            <textarea id="context" placeholder="Any specific focus, target audience, or special requirements..."></textarea>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateGuide()">
            üéôÔ∏è Generate Audioguide
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Creating your audioguide...</div>
        </div>

        <div class="success-message" id="success">
            ‚úÖ Audioguide generated successfully! Check your downloads.
        </div>

        <div class="funding-section">
            <p class="funding-text">
                Financiado por la Uni√≥n Europea ‚Äì Next Generation EU<br>
                a trav√©s del Ministerio de Industria y Turismo
            </p>
            <div class="funding-logos">
                <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                     alt="EU" class="funding-logo">
                <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                     alt="Spain" class="funding-logo">
            </div>
        </div>
    </div>

    <script>
        var currentTab = 'location';
        var uploadedFile = null;
        var uploadedFileContent = null;

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            var tabButtons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            event.target.classList.add('active');
            
            // Update tab content
            if (tab === 'location') {
                document.getElementById('locationTab').classList.add('active');
                document.getElementById('fileTab').classList.remove('active');
            } else {
                document.getElementById('locationTab').classList.remove('active');
                document.getElementById('fileTab').classList.add('active');
            }
        }

        function setExample(location) {
            document.getElementById('location').value = location;
        }

        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                event.target.value = '';
                return;
            }
            
            uploadedFile = file;
            
            // Update UI
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('active');
            
            // Read file content
            var reader = new FileReader();
            reader.onload = function(e) {
                uploadedFileContent = e.target.result;
                // Try to extract location from content
                suggestLocationFromContent(e.target.result);
            };
            reader.readAsText(file);
        }

        function removeFile() {
            uploadedFile = null;
            uploadedFileContent = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function suggestLocationFromContent(content) {
            // Try to extract location from first line or title
            var lines = content.split('\n');
            if (lines[0] && lines[0].length < 100) {
                document.getElementById('fileLocation').value = lines[0].trim();
            }
        }

        // Add drag and drop support
        window.addEventListener('DOMContentLoaded', function() {
            var uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            });
        });

        async function generateGuide() {
            var aiModel = document.getElementById('aiModel').value;
            var language = document.getElementById('language').value;
            var tourType = document.getElementById('tourType').value;
            var stops = parseInt(document.getElementById('stops').value);
            var context = document.getElementById('context').value.trim();
            var location = '';
            var useFile = false;

            // Check which tab is active
            if (currentTab === 'location') {
                location = document.getElementById('location').value.trim();
                if (!location) {
                    alert('Please enter a location');
                    return;
                }
            } else {
                location = document.getElementById('fileLocation').value.trim();
                if (!location) {
                    alert('Please enter the location name from your document');
                    return;
                }
                if (!uploadedFile || !uploadedFileContent) {
                    alert('Please upload a document first');
                    return;
                }
                useFile = true;
                // Add file content to context
                context = 'Document content: ' + uploadedFileContent.substring(0, 3000) + '\n\n' + context;
            }

            if (stops < 5 || stops > 15) {
                alert('Please select between 5 and 15 stops');
                return;
            }

            // Show loading
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('success').classList.remove('active');

            try {
                // Generate the audioguide content
                var audioguideContent = await generateAudioguideContent(location, language, tourType, stops, context, aiModel, useFile);
                
                // Download the file
                downloadAudioguide(audioguideContent, location);
                
                // Show success
                document.getElementById('success').classList.add('active');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate audioguide. Please try again.');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loading').classList.remove('active');
            }
        }

        async function generateAudioguideContent(location, language, tourType, totalStops, context, aiModel, useFile) {
            var content = 'AUDIOGUIDE: ' + location.toUpperCase() + '\n';
            content += '=' + '='.repeat(50) + '\n\n';
            content += 'Language: ' + language + '\n';
            content += 'Tour Type: ' + tourType + '\n';
            content += 'Total Stops: ' + totalStops + '\n';
            content += 'AI Model: ' + (aiModel === 'openai' ? 'ChatGPT' : 'DeepSeek') + '\n';
            content += 'Source: ' + (useFile ? 'Uploaded Document' : 'Direct Input') + '\n\n';
            content += '=' + '='.repeat(50) + '\n\n';

            // Stop 1: Introduction
            content += 'STOP 1: INTRODUCTION\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'introduction', language, tourType, context, aiModel);
            content += '\n\n';

            // Stop 2: History
            content += 'STOP 2: HISTORY\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'history', language, tourType, context, aiModel);
            content += '\n\n';

            // Main stops (totalStops - 4 mandatory ones)
            var mainStops = totalStops - 4;
            for (var i = 0; i < mainStops; i++) {
                content += 'STOP ' + (i + 3) + ': MAIN ATTRACTION ' + (i + 1) + '\n';
                content += '-'.repeat(30) + '\n\n';
                content += await generateStopContent(location, 'attraction', language, tourType, context, aiModel);
                content += '\n\n';
            }

            // Second to last: Local Cuisine
            content += 'STOP ' + (totalStops - 1) + ': LOCAL CUISINE\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'cuisine', language, tourType, context, aiModel);
            content += '\n\n';

            // Last: Practical Tips
            content += 'STOP ' + totalStops + ': PRACTICAL TIPS\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'tips', language, tourType, context, aiModel);
            content += '\n\n';

            content += '=' + '='.repeat(50) + '\n';
            content += 'Generated by CloudGuide AI\n';
            
            return content;
        }

        async function generateStopContent(location, stopType, language, tourType, context, aiModel) {
            var prompt = createPrompt(location, stopType, language, tourType, context);
            
            try {
                var apiUrl = aiModel === 'openai' ? '/api/openai' : '/api/deepseek';
                var requestBody = {
                    prompt: prompt
                };
                
                // Add OpenAI specific parameters
                if (aiModel === 'openai') {
                    requestBody.max_tokens = 800;
                    requestBody.temperature = 0.8;
                }
                
                var response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    var data = await response.json();
                    
                    // Handle different response formats
                    var generatedText = '';
                    if (aiModel === 'openai') {
                        // OpenAI response format
                        if (data.choices && data.choices[0]) {
                            if (data.choices[0].message) {
                                generatedText = data.choices[0].message.content;
                            } else if (data.choices[0].text) {
                                generatedText = data.choices[0].text;
                            }
                        }
                    } else {
                        // DeepSeek response format
                        generatedText = data.content || data.generated_text || '';
                    }
                    
                    return generatedText || getFallbackContent(location, stopType);
                } else {
                    console.error('API response not ok:', response.status);
                    return getFallbackContent(location, stopType);
                }
            } catch (error) {
                console.error('API Error:', error);
                return getFallbackContent(location, stopType);
            }
        }

        function createPrompt(location, stopType, language, tourType, context) {
            var basePrompt = '';
            
            switch(stopType) {
                case 'introduction':
                    basePrompt = 'Create a professional audioguide INTRODUCTION script for ' + location + '.\n\n' +
                        'IMPORTANT: Do NOT start with "Welcome to Introduction to..." Start with a natural, warm greeting.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- 600-800 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type: ' + tourType + '\n';
                    if (context) {
                        basePrompt += '- Context: ' + context + '\n';
                    }
                    basePrompt += '\n' +
                        'Create a compelling introduction that:\n' +
                        '1. WARM GREETING (100 words) - Welcome visitors naturally without redundancy\n' +
                        '2. LOCATION OVERVIEW (150 words) - What makes this place special and unique\n' +
                        '3. SIGNIFICANCE (200 words) - Why this matters culturally and historically\n' +
                        '4. PREVIEW OF HIGHLIGHTS (150 words) - Most spectacular features they will see\n' +
                        '5. VISITOR PREPARATION (100 words) - Set expectations and build excitement\n\n' +
                        'Write in an engaging, professional tone. Make visitors feel privileged to be here.\n\n' +
                        'GENERATE THE COMPLETE INTRODUCTION NOW:';
                    break;
                    
                case 'history':
                    basePrompt = 'Create a professional audioguide HISTORY script for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- 600-800 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type: ' + tourType + '\n';
                    if (context) {
                        basePrompt += '- Context: ' + context + '\n';
                    }
                    basePrompt += '\n' +
                        'Create an engaging historical narrative covering:\n' +
                        '1. ORIGINS (150 words) - When and why this location was established\n' +
                        '2. EARLY DEVELOPMENT (150 words) - How it grew in its first decades/centuries\n' +
                        '3. GOLDEN ERA (200 words) - Peak periods of importance and major events\n' +
                        '4. CHALLENGES & CHANGES (150 words) - How it survived difficulties and evolved\n' +
                        '5. MODERN ERA (150 words) - Recent history and current significance\n\n' +
                        'Use specific dates and names. Make history come alive with vivid storytelling.\n\n' +
                        'GENERATE THE COMPLETE HISTORY NOW:';
                    break;
                    
                case 'cuisine':
                    basePrompt = 'Create a professional audioguide MUST EATS / LOCAL CUISINE script for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- 600-800 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type: ' + tourType + '\n';
                    if (context) {
                        basePrompt += '- Context: ' + context + '\n';
                    }
                    basePrompt += '\n' +
                        'Create a delicious guide to local food covering:\n' +
                        '1. CULINARY HERITAGE (150 words) - Food traditions and cultural significance\n' +
                        '2. SIGNATURE DISHES (200 words) - 3-4 must-try local specialties with descriptions\n' +
                        '3. STREET FOOD & MARKETS (150 words) - Where locals eat, popular snacks\n' +
                        '4. BEVERAGES (100 words) - Traditional drinks, coffee/tea culture\n' +
                        '5. SWEET TREATS (100 words) - Local desserts and pastries\n' +
                        '6. DINING TIPS (100 words) - Etiquette, meal times, where to eat\n\n' +
                        'Focus on authentic local experiences. Help visitors eat like locals.\n\n' +
                        'GENERATE THE COMPLETE CUISINE GUIDE NOW:';
                    break;
                    
                case 'tips':
                    basePrompt = 'Create a professional audioguide PRACTICAL TIPS script for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- 600-800 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type: ' + tourType + '\n';
                    if (context) {
                        basePrompt += '- Context: ' + context + '\n';
                    }
                    basePrompt += '\n' +
                        'Provide comprehensive practical guidance:\n' +
                        '1. BEST TIMES TO VISIT (150 words) - Seasons, weather, crowd levels, special times\n' +
                        '2. GETTING THERE & AROUND (150 words) - Transportation, parking, navigation\n' +
                        '3. TICKETS & ENTRY (100 words) - Prices, booking tips, opening hours\n' +
                        '4. WHAT TO BRING (100 words) - Essential items, dress code, preparation\n' +
                        '5. HIDDEN GEMS (150 words) - Lesser-known spots, photo opportunities, insider tips\n' +
                        '6. NEARBY ATTRACTIONS (100 words) - What else to see in the area\n\n' +
                        'Give specific, actionable advice that enhances the visitor experience.\n\n' +
                        'GENERATE THE COMPLETE TIPS GUIDE NOW:';
                    break;
                    
                case 'attraction':
                default:
                    basePrompt = 'Create a professional audioguide script for a MAIN ATTRACTION at ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- 500-600 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type: ' + tourType + '\n' +
                        '- Theme: ' + (tourType === 'historical' ? 'Historical significance' : 
                                      tourType === 'cultural' ? 'Cultural importance' :
                                      tourType === 'artistic' ? 'Art and architecture' :
                                      tourType === 'family' ? 'Family-friendly discovery' :
                                      'Comprehensive overview') + '\n';
                    if (context) {
                        basePrompt += '- Context: ' + context + '\n';
                    }
                    basePrompt += '\n' +
                        'Structure your script to include:\n' +
                        '1. ARRIVAL & FIRST IMPRESSIONS (100 words) - What visitors see and feel\n' +
                        '2. DETAILED EXPLORATION (200 words) - Key features, architecture, or exhibits\n' +
                        '3. HISTORICAL/CULTURAL CONTEXT (150 words) - Background and significance\n' +
                        '4. INTERACTIVE ELEMENTS (100 words) - What to look for, photo spots, activities\n' +
                        '5. CONNECTION (50 words) - How this relates to the overall visit\n\n' +
                        'Create vivid descriptions that transport visitors. Use sensory details.\n\n' +
                        'GENERATE THE COMPLETE ATTRACTION SCRIPT NOW:';
                    break;
            }
            
            return basePrompt;
        }

        function getFallbackContent(location, stopType) {
            switch(stopType) {
                case 'introduction':
                    return 'Welcome to ' + location + '. This remarkable destination offers visitors an unforgettable journey through history, culture, and human achievement. As you explore today, you will discover the many layers of significance that make this place truly special. From its architectural marvels to its cultural treasures, every corner tells a story worth hearing. Prepare yourself for an enriching experience that will deepen your appreciation for this extraordinary location.';
                
                case 'history':
                    return 'The history of ' + location + ' spans centuries of human civilization. From its earliest foundations to the present day, this site has witnessed the rise and fall of empires, the creation of masterpieces, and the preservation of cultural heritage. Through various periods of prosperity and challenge, it has evolved while maintaining its essential character. Today, it stands as a testament to the endurance of human creativity and the importance of preserving our shared heritage.';
                
                case 'cuisine':
                    return 'The culinary traditions of ' + location + ' reflect centuries of cultural exchange and local innovation. Visitors should not miss the opportunity to sample authentic local dishes that have been perfected over generations. From street food to fine dining, the food culture here offers insights into daily life and celebration. Traditional recipes passed down through families showcase the unique flavors and ingredients that define this region\'s gastronomic identity.';
                
                case 'tips':
                    return 'To make the most of your visit to ' + location + ', consider arriving early to avoid crowds. Purchase tickets in advance when possible, and allow sufficient time to explore thoroughly. Comfortable walking shoes are essential, and bringing water is recommended. Photography may be restricted in certain areas, so check guidelines beforehand. Local guides can provide valuable insights that enhance your understanding of the site\'s significance.';
                
                default:
                    return 'This location at ' + location + ' represents an important aspect of the site\'s overall significance. Take time to observe the details that make this spot unique, from its architectural features to its cultural importance. Notice how this area connects to the broader narrative of the location and contributes to your understanding of its historical and contemporary relevance.';
            }
        }

        function downloadAudioguide(content, location) {
            var blob = new Blob([content], { type: 'text/plain' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Audioguide_' + location.replace(/[^a-z0-9]/gi, '_') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
