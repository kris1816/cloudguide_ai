<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide AI Audioguide Generator" />
    <meta property="og:description" content="Generate professional audioguides for museums and cultural heritage sites with AI" />
    <title>CloudGuide - AI Audioguide Generator</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #48bb78;
        }

        /* Hero Section with Background Image */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Stats Section - REMOVED */

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Nunito Sans', sans-serif;
            transition: all 0.3s;
            background: #f7fafc;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        select.form-element {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            padding-right: 45px;
        }

        textarea.form-element {
            min-height: 120px;
            resize: vertical;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #48bb78;
        }

        .tab-btn.active {
            color: #48bb78;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #48bb78;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Location Examples */
        .location-examples {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin-top: 12px;
            border: 1px solid #e2e8f0;
        }

        .location-examples h4 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .example-btn {
            background: white;
            border: 1px solid #48bb78;
            color: #48bb78;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #48bb78;
            color: white;
            transform: translateY(-1px);
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .file-upload-area:hover {
            border-color: #48bb78;
            background: white;
        }

        .file-upload-area.dragover {
            border-color: #48bb78;
            background: white;
            transform: scale(1.01);
        }

        .file-icon {
            font-size: 35px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .file-info {
            display: none;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 12px;
        }

        .file-info.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Grid Layout */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Buttons */
        .generate-btn {
            width: 100%;
            padding: 14px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .remove-file-btn {
            background: #718096;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s;
        }

        .remove-file-btn:hover {
            background: #4a5568;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #718096;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            font-size: 14px;
        }

        .success-message.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Image Section */
        .image-section {
            margin: 30px 0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .image-section img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        /* Footer Section */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        .funding-text {
            font-size: 12px;
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .funding-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }

        .funding-logo {
            height: 45px;
            opacity: 0.6;
            transition: opacity 0.3s;
            filter: grayscale(20%);
        }

        .funding-logo:hover {
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .funding-logos {
                flex-direction: column;
                gap: 20px;
            }

            .nav-links {
                display: none;
            }

            .hero-title {
                font-size: 2em;
            }

            .main-container {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="https://www.cloudguide.me/login" target="_blank">LOGIN</a></li>
                        <li><a href="https://www.cloudguide.me/signup" target="_blank">SIGNUP</a></li>
                        <li><a href="https://www.cloudguide.me/cities" target="_blank">OUR SITES</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section with Background Image -->
        <section class="hero-section">
            <h1 class="hero-title">AI Audioguide Generator</h1>
            <p class="hero-subtitle">Create Professional Audioguides for Museums and Cultural Heritage Sites</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('location')">Location Input</button>
                    <button class="tab-btn" onclick="switchTab('file')">File Upload</button>
                </div>
            </div>

            <!-- AI Model Selection -->
            <div class="form-group">
                <label for="aiModel">AI Model</label>
                <select id="aiModel" class="form-element">
                    <option value="deepseek">DeepSeek</option>
                    <option value="openai">OpenAI GPT</option>
                </select>
            </div>

            <!-- Location Input Tab -->
            <div id="locationTab" class="tab-content active">
                <div class="form-group">
                    <label for="location">Location Name</label>
                    <input type="text" id="location" class="form-element" placeholder="Enter any museum, landmark, city, or cultural site...">
                    <div class="location-examples">
                        <h4>Quick Examples</h4>
                        <div class="example-buttons">
                            <button class="example-btn" onclick="setExample('Louvre Museum Paris')">Louvre Museum</button>
                            <button class="example-btn" onclick="setExample('Sagrada Familia Barcelona')">Sagrada Familia</button>
                            <button class="example-btn" onclick="setExample('Vatican Museums')">Vatican Museums</button>
                            <button class="example-btn" onclick="setExample('Alhambra Granada')">Alhambra Granada</button>
                            <button class="example-btn" onclick="setExample('Acropolis Athens')">Acropolis Athens</button>
                            <button class="example-btn" onclick="setExample('Colosseum Rome')">Colosseum</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="fileTab" class="tab-content">
                <div class="form-group">
                    <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" style="display: none;" onchange="handleFileUpload(event)">
                        <div class="file-icon">📄</div>
                        <p style="font-weight: 600; margin-bottom: 8px; color: #4a5568;">Drop your file here or click to browse</p>
                        <p style="color: #a0aec0; font-size: 13px;">PDF, Word, or TXT files (max 10MB)</p>
                    </div>
                    <div class="file-info" id="fileInfo">
                        <div>
                            <div style="font-weight: 600; color: #2d3748;" id="fileName">No file</div>
                            <div style="color: #718096; font-size: 13px; margin-top: 5px;" id="fileSize">0 KB</div>
                        </div>
                        <button class="remove-file-btn" onclick="removeFile()">Remove</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="fileLocation">Location Name (from document)</label>
                    <input type="text" id="fileLocation" class="form-element" placeholder="Enter the location this document is about...">
                </div>
            </div>

            <!-- Image Section -->
            <div class="image-section">
                <img src="https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg" alt="Cultural Heritage">
            </div>

            <!-- Configuration Grid -->
            <div class="config-grid">
                <div class="form-group">
                    <label for="language">Output Language</label>
                    <select id="language" class="form-element">
                        <option value="English">English</option>
                        <option value="Spanish">Español</option>
                        <option value="French">Français</option>
                        <option value="German">Deutsch</option>
                        <option value="Italian">Italiano</option>
                        <option value="Portuguese">Português</option>
                        <option value="Chinese">中文</option>
                        <option value="Japanese">日本語</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tourType">Tour Type</label>
                    <select id="tourType" class="form-element">
                        <option value="comprehensive">Comprehensive Overview</option>
                        <option value="historical">Historical Focus</option>
                        <option value="cultural">Cultural Heritage</option>
                        <option value="family">Family Friendly</option>
                        <option value="artistic">Art & Architecture</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="stops">Number of Stops</label>
                <select id="stops" class="form-element">
                    <option value="5">Minimum (5 stops)</option>
                    <option value="8" selected>Standard (8 stops)</option>
                    <option value="10">Extended (10 stops)</option>
                    <option value="12">Comprehensive (12 stops)</option>
                    <option value="15">Maximum (15 stops)</option>
                </select>
                <small style="color: #a0aec0; display: block; margin-top: 10px; font-size: 12px;">
                    Each tour includes: Introduction, History, Local Cuisine, and Practical Tips as core content
                </small>
            </div>

            <div class="form-group">
                <label for="context">Additional Context (Optional)</label>
                <textarea id="context" class="form-element" placeholder="Any specific focus, target audience, or special requirements..."></textarea>
            </div>

            <button class="generate-btn" id="generateBtn" onclick="generateGuide()">
                Generate Audioguide
            </button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Creating your audioguide</div>
            </div>

            <div class="success-message" id="success">
                ✓ Audioguide generated successfully. Check your downloads folder.
            </div>

            <!-- Footer Section -->
            <div class="footer-section">
                <p class="funding-text">
                    Financiado por la Unión Europea – Next Generation EU<br>
                    a través del Ministerio de Industria y Turismo
                </p>
                <div class="funding-logos">
                    <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                         alt="EU" class="funding-logo">
                    <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                         alt="Spain" class="funding-logo">
                </div>
            </div>
        </div>
    </div>

    <script>
        var currentTab = 'location';
        var uploadedFile = null;
        var uploadedFileContent = null;

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            var tabButtons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            event.target.classList.add('active');
            
            // Update tab content
            if (tab === 'location') {
                document.getElementById('locationTab').classList.add('active');
                document.getElementById('fileTab').classList.remove('active');
            } else {
                document.getElementById('locationTab').classList.remove('active');
                document.getElementById('fileTab').classList.add('active');
            }
        }

        function setExample(location) {
            document.getElementById('location').value = location;
        }

        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                event.target.value = '';
                return;
            }
            
            uploadedFile = file;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('active');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                uploadedFileContent = e.target.result;
                suggestLocationFromContent(e.target.result);
            };
            reader.readAsText(file);
        }

        function removeFile() {
            uploadedFile = null;
            uploadedFileContent = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function suggestLocationFromContent(content) {
            var lines = content.split('\n');
            if (lines[0] && lines[0].length < 100) {
                document.getElementById('fileLocation').value = lines[0].trim();
            }
        }

        // Drag and drop support
        window.addEventListener('DOMContentLoaded', function() {
            var uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            });
        });

        async function generateGuide() {
            var aiModel = document.getElementById('aiModel').value;
            var language = document.getElementById('language').value;
            var tourType = document.getElementById('tourType').value;
            var stops = parseInt(document.getElementById('stops').value);
            var context = document.getElementById('context').value.trim();
            var location = '';
            var useFile = false;

            if (currentTab === 'location') {
                location = document.getElementById('location').value.trim();
                if (!location) {
                    alert('Please enter a location');
                    return;
                }
            } else {
                location = document.getElementById('fileLocation').value.trim();
                if (!location) {
                    alert('Please enter the location name from your document');
                    return;
                }
                if (!uploadedFile || !uploadedFileContent) {
                    alert('Please upload a document first');
                    return;
                }
                useFile = true;
                context = 'Document content: ' + uploadedFileContent.substring(0, 3000) + '\n\n' + context;
            }

            // Show loading
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('success').classList.remove('active');

            try {
                var audioguideContent = await generateAudioguideContent(location, language, tourType, stops, context, aiModel, useFile);
                
                downloadAudioguide(audioguideContent, location);
                
                document.getElementById('success').classList.add('active');
                
                setTimeout(function() {
                    document.getElementById('success').classList.remove('active');
                }, 5000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate audioguide. Please try again.');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loading').classList.remove('active');
            }
        }

        async function generateAudioguideContent(location, language, tourType, totalStops, context, aiModel, useFile) {
            var content = 'AUDIOGUIDE: ' + location.toUpperCase() + '\n';
            content += '=' + '='.repeat(50) + '\n\n';
            content += 'Language: ' + language + '\n';
            content += 'Tour Type: ' + tourType + '\n';
            content += 'Total Stops: ' + totalStops + '\n';
            content += 'AI Model: ' + (aiModel === 'openai' ? 'OpenAI GPT' : 'DeepSeek') + '\n';
            content += 'Source: ' + (useFile ? 'Uploaded Document' : 'Direct Input') + '\n\n';
            content += '=' + '='.repeat(50) + '\n\n';

            // Stop 1: Introduction
            content += 'STOP 1: INTRODUCTION\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'introduction', language, tourType, context, aiModel);
            content += '\n\n';

            // Stop 2: History
            content += 'STOP 2: HISTORY\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'history', language, tourType, context, aiModel);
            content += '\n\n';

            // Main stops (totalStops - 4 mandatory ones)
            var mainStops = totalStops - 4;
            for (var i = 0; i < mainStops; i++) {
                content += 'STOP ' + (i + 3) + ': MAIN ATTRACTION ' + (i + 1) + '\n';
                content += '-'.repeat(30) + '\n\n';
                content += await generateStopContent(location, 'attraction', language, tourType, context, aiModel);
                content += '\n\n';
            }

            // Second to last: Local Cuisine
            content += 'STOP ' + (totalStops - 1) + ': LOCAL CUISINE\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'cuisine', language, tourType, context, aiModel);
            content += '\n\n';

            // Last: Practical Tips
            content += 'STOP ' + totalStops + ': PRACTICAL TIPS\n';
            content += '-'.repeat(30) + '\n\n';
            content += await generateStopContent(location, 'tips', language, tourType, context, aiModel);
            content += '\n\n';

            content += '=' + '='.repeat(50) + '\n';
            content += '© CloudGuide - www.cloudguide.me\n';
            
            return content;
        }

        async function generateStopContent(location, stopType, language, tourType, context, aiModel) {
            var prompt = createPrompt(location, stopType, language, tourType, context);
            
            try {
                var apiUrl = aiModel === 'openai' ? '/api/openai' : '/api/deepseek';
                var requestBody = {
                    prompt: prompt
                };
                
                // Add OpenAI specific parameters
                if (aiModel === 'openai') {
                    requestBody.max_tokens = 800;
                    requestBody.temperature = 0.8;
                }
                
                var response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    var data = await response.json();
                    
                    // Handle different response formats
                    var generatedText = '';
                    if (aiModel === 'openai') {
                        // OpenAI response format
                        if (data.choices && data.choices[0]) {
                            if (data.choices[0].message) {
                                generatedText = data.choices[0].message.content;
                            } else if (data.choices[0].text) {
                                generatedText = data.choices[0].text;
                            }
                        }
                    } else {
                        // DeepSeek response format
                        generatedText = data.content || data.generated_text || '';
                    }
                    
                    return generatedText || getFallbackContent(location, stopType);
                } else {
                    console.error('API response not ok:', response.status);
                    return getFallbackContent(location, stopType);
                }
            } catch (error) {
                console.error('API Error:', error);
                return getFallbackContent(location, stopType);
            }
        }

        function createPrompt(location, stopType, language, tourType, context) {
            var basePrompt = '';
            
            switch(stopType) {
                case 'introduction':
                    basePrompt = 'You are a world-class audioguide scriptwriter. Create a captivating introduction for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- Write EXACTLY 900-1100 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type focus: ' + tourType + '\n' +
                        '- Style: Professional audioguide narration\n\n' +
                        'CRITICAL INSTRUCTIONS:\n' +
                        '- Write as a SINGLE FLOWING NARRATIVE with no headers, titles, or numbered sections\n' +
                        '- Start immediately with engaging content\n' +
                        '- Use natural paragraph breaks only\n' +
                        '- Avoid clichés like "Welcome to", "iconic", "must-see", "nestled"\n' +
                        '- Never repeat the same descriptive words\n\n' +
                        'Your introduction should flow naturally through these themes WITHOUT labeling them:\n' +
                        '- Begin with an intriguing opening that captures attention\n' +
                        '- Paint a vivid picture of what makes this place extraordinary\n' +
                        '- Weave in the cultural and historical significance\n' +
                        '- Build anticipation for what visitors will experience\n' +
                        '- Help visitors understand their personal connection to this place\n\n' +
                        'Write a seamless, engaging narrative that flows like a professional audioguide. Begin directly:';
                    break;
                    
                case 'history':
                    basePrompt = 'Create a compelling historical narrative for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- Write EXACTLY 900-1100 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type focus: ' + tourType + '\n' +
                        '- Style: Engaging storytelling, not academic\n\n' +
                        'CRITICAL INSTRUCTIONS:\n' +
                        '- Write as ONE CONTINUOUS STORY with no section headers or numbers\n' +
                        '- Begin immediately with the narrative\n' +
                        '- Use only natural paragraph transitions\n' +
                        '- Avoid starting paragraphs with dates or "In [year]..."\n' +
                        '- Vary your sentence structures\n\n' +
                        'Tell the historical story by naturally covering:\n' +
                        '- The fascinating origins and founding story\n' +
                        '- Key moments that shaped its destiny\n' +
                        '- Periods of glory and achievement\n' +
                        '- Challenges overcome and transformations\n' +
                        '- Its journey to the present day\n\n' +
                        'Begin the historical narrative immediately:';
                    break;
                    
                case 'cuisine':
                    basePrompt = 'Create a mouthwatering culinary guide for ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- Write EXACTLY 900-1100 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type focus: ' + tourType + '\n' +
                        '- Style: Sensory-rich food storytelling\n\n' +
                        'CRITICAL INSTRUCTIONS:\n' +
                        '- Write as a SEAMLESS NARRATIVE with no lists or section headers\n' +
                        '- Start directly with engaging food content\n' +
                        '- Use vivid sensory descriptions (taste, smell, texture, appearance)\n' +
                        '- Avoid generic food words like "delicious", "tasty", "yummy"\n' +
                        '- Be specific about dishes, ingredients, and flavors\n\n' +
                        'Create a rich culinary journey that naturally explores:\n' +
                        '- How food reflects the culture and history\n' +
                        '- Signature dishes with detailed sensory descriptions\n' +
                        '- The vibrant street food and market scenes\n' +
                        '- Traditional beverages and social rituals\n' +
                        '- Sweet traditions and food memories\n\n' +
                        'Begin the culinary narrative immediately:';
                    break;
                    
                case 'tips':
                    basePrompt = 'Create an invaluable practical guide for visiting ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- Write EXACTLY 900-1100 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type focus: ' + tourType + '\n' +
                        '- Style: Conversational expert advice\n\n' +
                        'CRITICAL INSTRUCTIONS:\n' +
                        '- Write as FLOWING PARAGRAPHS with no bullet points or headers\n' +
                        '- Start immediately with useful insights\n' +
                        '- Provide specific, actionable information\n' +
                        '- Include exact times, prices, locations when relevant\n' +
                        '- Avoid obvious advice everyone knows\n\n' +
                        'Share insider knowledge that naturally covers:\n' +
                        '- Strategic timing for the best experience\n' +
                        '- Smart navigation and access tips\n' +
                        '- Hidden gems most visitors miss\n' +
                        '- Cultural insights for respectful visits\n' +
                        '- Local secrets that enhance the experience\n\n' +
                        'Begin sharing practical wisdom immediately:';
                    break;
                    
                case 'attraction':
                default:
                    var themes = [
                        'the magnificent architecture',
                        'the historical significance',
                        'the artistic treasures',
                        'the cultural importance',
                        'the archaeological wonders',
                        'the sacred spaces',
                        'the innovative design',
                        'the natural beauty',
                        'the human stories',
                        'the technological marvels'
                    ];
                    var selectedTheme = themes[Math.floor(Math.random() * themes.length)];
                    
                    basePrompt = 'Create an immersive audioguide script focusing on ' + selectedTheme + ' of ' + location + '.\n\n' +
                        'REQUIREMENTS:\n' +
                        '- Write EXACTLY 900-1100 words\n' +
                        '- Language: ' + language + '\n' +
                        '- Tour type focus: ' + tourType + '\n' +
                        '- Style: Immersive, detailed description\n\n' +
                        'CRITICAL INSTRUCTIONS:\n' +
                        '- Write as a CONTINUOUS NARRATIVE with no sections or headers\n' +
                        '- Begin immediately with vivid description\n' +
                        '- Focus on specific details visitors can observe\n' +
                        '- Use varied vocabulary and sentence structures\n' +
                        '- Create a sense of discovery and wonder\n\n' +
                        'Guide visitors through an exploration that naturally includes:\n' +
                        '- The immediate sensory experience of the space\n' +
                        '- Fascinating details and their meanings\n' +
                        '- Stories and historical moments\n' +
                        '- Cultural significance and symbolism\n' +
                        '- Personal connections and reflections\n\n' +
                        'Begin the immersive description immediately:';
                    break;
            }
            
            if (context) {
                basePrompt += '\n\nAdditional context to incorporate naturally: ' + context;
            }
            
            return basePrompt;
        }

        function getFallbackContent(location, stopType) {
            switch(stopType) {
                case 'introduction':
                    return 'Welcome to ' + location + '. This remarkable destination offers visitors an unforgettable journey through history, culture, and human achievement. As you explore today, you will discover the many layers of significance that make this place truly special.';
                
                case 'history':
                    return 'The history of ' + location + ' spans centuries of human civilization. From its earliest foundations to the present day, this site has witnessed the rise and fall of empires, the creation of masterpieces, and the preservation of cultural heritage.';
                
                case 'cuisine':
                    return 'The culinary traditions of ' + location + ' reflect centuries of cultural exchange and local innovation. Visitors should not miss the opportunity to sample authentic local dishes that have been perfected over generations.';
                
                case 'tips':
                    return 'To make the most of your visit to ' + location + ', consider arriving early to avoid crowds. Purchase tickets in advance when possible, and allow sufficient time to explore thoroughly.';
                
                default:
                    return 'This location at ' + location + ' represents an important aspect of the site\'s overall significance. Take time to observe the details that make this spot unique.';
            }
        }

        function downloadAudioguide(content, location) {
            var blob = new Blob([content], { type: 'text/plain' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'CloudGuide_' + location.replace(/[^a-z0-9]/gi, '_') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
