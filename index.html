<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="CloudGuide AI Audioguide Generator" />
    <meta property="og:description" content="Generate professional audioguides for museums and cultural heritage sites with AI" />
    <title>CloudGuide - AI Audioguide Generator</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .logo img:hover {
            opacity: 0.8;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #48bb78;
        }

        /* Hero Section with Background Image */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Nunito Sans', sans-serif;
            transition: all 0.3s;
            background: #f7fafc;
            color: #2d3748;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        select.form-element {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            padding-right: 45px;
        }

        textarea.form-element {
            min-height: 120px;
            resize: vertical;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #48bb78;
        }

        .tab-btn.active {
            color: #48bb78;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #48bb78;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Location Examples */
        .location-examples {
            background: #f7fafc;
            border-radius: 6px;
            padding: 20px;
            margin-top: 12px;
            border: 1px solid #e2e8f0;
        }

        .location-examples h4 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .example-btn {
            background: white;
            border: 1px solid #48bb78;
            color: #48bb78;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #48bb78;
            color: white;
            transform: translateY(-1px);
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .file-upload-area:hover {
            border-color: #48bb78;
            background: white;
        }

        .file-upload-area.dragover {
            border-color: #48bb78;
            background: white;
            transform: scale(1.01);
        }

        .file-icon {
            font-size: 35px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .file-info {
            display: none;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 12px;
        }

        .file-info.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Grid Layout */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Buttons */
        .generate-btn {
            width: 100%;
            padding: 14px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .remove-file-btn {
            background: #718096;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s;
        }

        .remove-file-btn:hover {
            background: #4a5568;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-top: 20px;
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .progress-container.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .progress-percentage {
            color: #48bb78;
            font-weight: 600;
            font-size: 14px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-status {
            margin-top: 12px;
            font-size: 13px;
            color: #718096;
            font-style: italic;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #718096;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            font-size: 14px;
        }

        .success-message.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Debug Panel */
        .debug-panel {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }

        .debug-panel h4 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .debug-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .debug-btn {
            padding: 8px 16px;
            background: #718096;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .debug-btn:hover {
            background: #4a5568;
        }

        /* Footer Section */
        .footer-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        .funding-text {
            font-size: 12px;
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .funding-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }

        .funding-logo {
            height: 45px;
            opacity: 0.6;
            transition: opacity 0.3s;
            filter: grayscale(20%);
        }

        .funding-logo:hover {
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .funding-logos {
                flex-direction: column;
                gap: 20px;
            }

            .nav-links {
                display: none;
            }

            .hero-title {
                font-size: 2em;
            }

            .main-container {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html" style="color: #48bb78;">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html">AUDIO</a></li>
                        <li><a href="upload.html">UPLOAD</a></li>
                        <li><a href="premium.html">PREMIUM</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                        <li><a href="https://www.cloudguide.me/contact" target="_blank">CONTACT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section with Background Image -->
        <section class="hero-section">
            <h1 class="hero-title">AI Audioguide Generator</h1>
            <p class="hero-subtitle">Create Professional Audioguides for Museums and Cultural Heritage Sites</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('location')">Location Input</button>
                    <button class="tab-btn" onclick="switchTab('file')">File Upload</button>
                </div>
            </div>

            <!-- AI Model Selection -->
            <div class="form-group">
                <label for="aiModel">AI Model</label>
                <select id="aiModel" class="form-element">
                    <option value="sample">Sample Content (No API Required)</option>
                    <option value="openai">OpenAI GPT (API Key Required)</option>
                    <option value="groq">Groq Mixtral (API Key Required)</option>
                    <option value="deepseek">DeepSeek (API Key Required)</option>
                </select>
                <small style="color: #a0aec0; display: block; margin-top: 8px; font-size: 12px;">
                    💡 Use "Sample Content" for testing without API keys
                </small>
            </div>

            <!-- Location Input Tab -->
            <div id="locationTab" class="tab-content active">
                <div class="form-group">
                    <label for="location">Location Name</label>
                    <input type="text" id="location" class="form-element" placeholder="Enter any museum, landmark, city, or cultural site...">
                    <div class="location-examples">
                        <h4>Quick Examples</h4>
                        <div class="example-buttons">
                            <button class="example-btn" onclick="setExample('Louvre Museum Paris')">Louvre Museum</button>
                            <button class="example-btn" onclick="setExample('Sagrada Familia Barcelona')">Sagrada Familia</button>
                            <button class="example-btn" onclick="setExample('Vatican Museums')">Vatican Museums</button>
                            <button class="example-btn" onclick="setExample('Alhambra Granada')">Alhambra Granada</button>
                            <button class="example-btn" onclick="setExample('Acropolis Athens')">Acropolis Athens</button>
                            <button class="example-btn" onclick="setExample('Colosseum Rome')">Colosseum</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="fileTab" class="tab-content">
                <div class="form-group">
                    <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" style="display: none;" onchange="handleFileUpload(event)">
                        <div class="file-icon">📄</div>
                        <p style="font-weight: 600; margin-bottom: 8px; color: #4a5568;">Drop your file here or click to browse</p>
                        <p style="color: #a0aec0; font-size: 13px;">PDF, Word, or TXT files (max 10MB)</p>
                    </div>
                    <div class="file-info" id="fileInfo">
                        <div>
                            <div style="font-weight: 600; color: #2d3748;" id="fileName">No file</div>
                            <div style="color: #718096; font-size: 13px; margin-top: 5px;" id="fileSize">0 KB</div>
                        </div>
                        <button class="remove-file-btn" onclick="removeFile()">Remove</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="fileLocation">Location Name (from document)</label>
                    <input type="text" id="fileLocation" class="form-element" placeholder="Enter the location this document is about...">
                </div>
            </div>

            <!-- Configuration Grid -->
            <div class="config-grid">
                <div class="form-group">
                    <label for="language">Output Language</label>
                    <select id="language" class="form-element">
                        <option value="English">English</option>
                        <option value="Spanish">Español</option>
                        <option value="French">Français</option>
                        <option value="German">Deutsch</option>
                        <option value="Italian">Italiano</option>
                        <option value="Portuguese">Português</option>
                        <option value="Chinese">中文</option>
                        <option value="Japanese">日本語</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tourType">Tour Type</label>
                    <select id="tourType" class="form-element">
                        <option value="comprehensive">Comprehensive Overview</option>
                        <option value="historical">Historical Focus</option>
                        <option value="cultural">Cultural Heritage</option>
                        <option value="family">Family Friendly</option>
                        <option value="artistic">Art & Architecture</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="stops">Number of Stops</label>
                <select id="stops" class="form-element">
                    <option value="3">Quick Tour (3 stops)</option>
                    <option value="5">Short (5 stops)</option>
                    <option value="8" selected>Standard (8 stops)</option>
                    <option value="10">Extended (10 stops)</option>
                    <option value="12">Comprehensive (12 stops)</option>
                    <option value="15">Detailed (15 stops)</option>
                    <option value="20">In-Depth (20 stops)</option>
                    <option value="25">Maximum (25 stops)</option>
                </select>
                <small style="color: #a0aec0; display: block; margin-top: 10px; font-size: 12px;">
                    Each stop contains ~900 words. More stops = longer, more detailed audioguide.
                </small>
            </div>

            <div class="form-group">
                <label for="context">Additional Context (Optional)</label>
                <textarea id="context" class="form-element" placeholder="Any specific focus, target audience, or special requirements..."></textarea>
            </div>

            <button class="generate-btn" id="generateBtn" onclick="generateGuide()">
                Generate Audioguide
            </button>

            <!-- Debug Panel -->
            <div class="debug-panel">
                <h4>🔧 Debug & Test Tools</h4>
                <div class="debug-buttons">
                    <button class="debug-btn" onclick="testGenerateSimple()">Test Save (Simple)</button>
                    <button class="debug-btn" onclick="checkStorage()">Check Storage</button>
                    <button class="debug-btn" onclick="clearStorage()">Clear Storage</button>
                    <button class="debug-btn" onclick="showStorageInfo()">Storage Info</button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <div class="progress-title">Generating Audioguide</div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
                <div class="progress-status" id="progressStatus">Initializing...</div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Creating your audioguide</div>
            </div>

            <div class="success-message" id="success">
                ✓ Audioguide generated successfully and saved to your library!
                <div style="margin-top: 15px;">
                    <a href="library.html" style="color: white; text-decoration: underline;">View in Library</a> | 
                    <a href="audio.html" style="color: white; text-decoration: underline;">Generate Audio</a>
                </div>
            </div>

            <!-- Footer Section -->
            <div class="footer-section">
                <p class="funding-text">
                    Financiado por la Unión Europea – Next Generation EU<br>
                    a través del Ministerio de Industria y Turismo
                </p>
                <div class="funding-logos">
                    <img src="https://s.cloudguide.me/m/files/d3e690c8-b10a-49e3-8cda-ac3335896b69.png" 
                         alt="EU" class="funding-logo">
                    <img src="https://s.cloudguide.me/m/files/f1eabdef-d522-457d-90fe-fa00b513ac3c.png" 
                         alt="Spain" class="funding-logo">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var currentTab = 'location';
        var uploadedFile = null;
        var uploadedFileContent = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            console.log('CloudGuide Generator Initialized');
            checkStorage();
        });

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'location') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('locationTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('fileTab').classList.add('active');
            }
        }

        // Set example location
        function setExample(location) {
            document.getElementById('location').value = location;
        }

        // File upload handling
        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                event.target.value = '';
                return;
            }
            
            uploadedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('active');
            
            // Read file content
            var reader = new FileReader();
            reader.onload = function(e) {
                uploadedFileContent = e.target.result;
                console.log('File uploaded successfully');
            };
            reader.readAsText(file);
        }

        function removeFile() {
            uploadedFile = null;
            uploadedFileContent = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Drag and drop support
        window.addEventListener('DOMContentLoaded', function() {
            var uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            });
        });

        // Update progress
        function updateProgress(percentage, status) {
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
            document.getElementById('progressStatus').textContent = status;
        }

        // Generate sample content
        function generateSampleContent(location, stopType) {
            const templates = {
                introduction: `Welcome to ${location}. This remarkable destination offers visitors an unforgettable journey through history, culture, and human achievement. As you stand here today, you are experiencing centuries of human creativity and ingenuity. The architecture around you tells stories of different eras, each adding its own unique chapter to this magnificent place.`,
                
                history: `The history of ${location} spans many centuries, beginning from its earliest foundations to the vibrant present day. This location has witnessed the rise and fall of empires, served as a center of cultural exchange, and played a pivotal role in shaping the region's identity. Through wars, peace, prosperity, and challenges, it has remained a testament to human resilience.`,
                
                attraction: `This particular area of ${location} showcases some of the most impressive features of the site. Notice the intricate details in the architecture, the careful craftsmanship that went into every element, and the symbolic meanings embedded in the design. These elements combine to create an experience that engages all your senses and leaves a lasting impression.`,
                
                cuisine: `The culinary traditions associated with ${location} reflect the rich cultural tapestry of the region. Local dishes have been perfected over generations, combining influences from various cultures that have passed through this area. From street food to fine dining, the flavors here tell their own story of cultural exchange and innovation.`,
                
                tips: `To make the most of your visit to ${location}, consider these practical tips: Arrive early in the morning or late afternoon to avoid crowds. Wear comfortable walking shoes as you'll be doing considerable walking. Bring water and sun protection. Take time to sit and absorb the atmosphere rather than rushing. The best experiences often come from unexpected discoveries.`
            };
            
            return templates[stopType] || templates.attraction;
        }

        // Save to library function
        function saveToLibrary(location, language, tourType, stops, content) {
            try {
                console.log('=== SAVE TO LIBRARY START ===');
                
                // Validate inputs
                if (!location || !content) {
                    console.error('Missing required data for saving');
                    return null;
                }
                
                // Get existing guides
                let audioguides = [];
                const stored = localStorage.getItem('cloudguide_audioguides');
                if (stored) {
                    try {
                        audioguides = JSON.parse(stored);
                        console.log('Found existing guides:', audioguides.length);
                    } catch (e) {
                        console.error('Error parsing existing guides:', e);
                        audioguides = [];
                    }
                }
                
                // Create new guide
                const newGuide = {
                    id: Date.now().toString(),
                    title: location,
                    location: location,
                    language: language || 'English',
                    tourType: tourType || 'comprehensive',
                    stops: stops || 8,
                    date: new Date().toISOString(),
                    content: content,
                    type: 'generated',
                    wordCount: content.split(/\s+/).filter(w => w.length > 0).length
                };
                
                console.log('New guide created:', {
                    id: newGuide.id,
                    title: newGuide.title,
                    contentLength: newGuide.content.length
                });
                
                // Add to array
                audioguides.unshift(newGuide);
                
                // Limit to 50 guides
                if (audioguides.length > 50) {
                    audioguides = audioguides.slice(0, 50);
                }
                
                // Save to localStorage
                const jsonString = JSON.stringify(audioguides);
                localStorage.setItem('cloudguide_audioguides', jsonString);
                console.log('Saved to localStorage, total size:', jsonString.length);
                
                // Verify save
                const verification = localStorage.getItem('cloudguide_audioguides');
                if (verification) {
                    const parsed = JSON.parse(verification);
                    const found = parsed.find(g => g.id === newGuide.id);
                    if (found) {
                        console.log('✅ SAVE VERIFIED - Guide found in storage');
                    } else {
                        console.error('❌ SAVE FAILED - Guide not found after save');
                        return null;
                    }
                }
                
                console.log('=== SAVE TO LIBRARY END ===');
                return newGuide;
                
            } catch (error) {
                console.error('CRITICAL ERROR in saveToLibrary:', error);
                alert('Error saving audioguide: ' + error.message);
                return null;
            }
        }

        // Main generate function
        async function generateGuide() {
            const aiModel = document.getElementById('aiModel').value;
            const language = document.getElementById('language').value;
            const tourType = document.getElementById('tourType').value;
            const stops = parseInt(document.getElementById('stops').value);
            const context = document.getElementById('context').value.trim();
            
            let location = '';
            
            if (currentTab === 'location') {
                location = document.getElementById('location').value.trim();
                if (!location) {
                    alert('Please enter a location');
                    return;
                }
            } else {
                location = document.getElementById('fileLocation').value.trim();
                if (!location) {
                    alert('Please enter the location name');
                    return;
                }
            }

            console.log('Generating guide for:', location);

            // Disable button and show loading
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('success').classList.remove('active');

            try {
                let content = '';
                
                // Generate content based on model
                if (aiModel === 'sample') {
                    // Generate sample content without API
                    content = await generateSampleAudioguide(location, language, tourType, stops);
                } else if (aiModel === 'openai') {
                    // Try OpenAI API
                    content = await generateWithOpenAI(location, language, tourType, stops, context);
                } else if (aiModel === 'groq') {
                    // Try Groq API
                    content = await generateWithGroq(location, language, tourType, stops, context);
                } else {
                    // Fallback to sample
                    content = await generateSampleAudioguide(location, language, tourType, stops);
                }
                
                if (!content) {
                    throw new Error('No content generated');
                }
                
                // Save to library
                const savedGuide = saveToLibrary(location, language, tourType, stops, content);
                
                if (savedGuide) {
                    console.log('Guide saved successfully:', savedGuide.id);
                    
                    // Download file
                    downloadAudioguide(content, location);
                    
                    // Show success message
                    document.getElementById('success').innerHTML = `
                        ✓ Audioguide generated successfully and saved to your library!
                        <div style="margin-top: 15px;">
                            <a href="library.html" style="color: white; text-decoration: underline;">View in Library</a> | 
                            <a href="audio.html?id=${savedGuide.id}" style="color: white; text-decoration: underline;">Generate Audio</a>
                        </div>
                    `;
                    document.getElementById('success').classList.add('active');
                    
                    setTimeout(() => {
                        document.getElementById('success').classList.remove('active');
                    }, 10000);
                } else {
                    throw new Error('Failed to save guide to library');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loading').classList.remove('active');
                document.getElementById('progressContainer').classList.remove('active');
            }
        }

        // Generate sample audioguide (no API needed)
        async function generateSampleAudioguide(location, language, tourType, stops) {
            console.log('Generating sample content...');
            
            let content = `AUDIOGUIDE: ${location.toUpperCase()}\n`;
            content += '='.repeat(60) + '\n\n';
            content += `Language: ${language}\n`;
            content += `Tour Type: ${tourType}\n`;
            content += `Total Stops: ${stops}\n`;
            content += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            content += '='.repeat(60) + '\n\n';
            
            updateProgress(10, 'Creating introduction...');
            
            // Generate stops
            content += 'STOP 1: INTRODUCTION\n';
            content += '-'.repeat(30) + '\n\n';
            content += generateSampleContent(location, 'introduction');
            content += '\n\n';
            
            updateProgress(30, 'Adding history...');
            
            content += 'STOP 2: HISTORY\n';
            content += '-'.repeat(30) + '\n\n';
            content += generateSampleContent(location, 'history');
            content += '\n\n';
            
            updateProgress(50, 'Creating attraction stops...');
            
            for (let i = 3; i <= stops - 2; i++) {
                content += `STOP ${i}: MAIN ATTRACTION ${i - 2}\n`;
                content += '-'.repeat(30) + '\n\n';
                content += generateSampleContent(location, 'attraction');
                content += '\n\n';
            }
            
            updateProgress(70, 'Adding cuisine section...');
            
            content += `STOP ${stops - 1}: LOCAL CUISINE\n`;
            content += '-'.repeat(30) + '\n\n';
            content += generateSampleContent(location, 'cuisine');
            content += '\n\n';
            
            updateProgress(90, 'Final touches...');
            
            content += `STOP ${stops}: PRACTICAL TIPS\n`;
            content += '-'.repeat(30) + '\n\n';
            content += generateSampleContent(location, 'tips');
            content += '\n\n';
            
            content += '='.repeat(60) + '\n';
            content += '© CloudGuide - www.cloudguide.me\n';
            
            updateProgress(100, 'Complete!');
            
            return content;
        }

        // OpenAI API call
        async function generateWithOpenAI(location, language, tourType, stops, context) {
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Create an audioguide for ${location} with ${stops} stops in ${language}`,
                        max_tokens: 4000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API failed');
                }
                
                const data = await response.json();
                return data.content || generateSampleAudioguide(location, language, tourType, stops);
                
            } catch (error) {
                console.error('OpenAI error:', error);
                // Fallback to sample content
                return generateSampleAudioguide(location, language, tourType, stops);
            }
        }

        // Groq API call
        async function generateWithGroq(location, language, tourType, stops, context) {
            try {
                const response = await fetch('/api/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destination: location,
                        stops: stops,
                        tourType: tourType,
                        language: language
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Groq API failed');
                }
                
                const data = await response.json();
                return data.content || generateSampleAudioguide(location, language, tourType, stops);
                
            } catch (error) {
                console.error('Groq error:', error);
                // Fallback to sample content
                return generateSampleAudioguide(location, language, tourType, stops);
            }
        }

        // Download audioguide
        function downloadAudioguide(content, location) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CloudGuide_${location.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Debug functions
        function testGenerateSimple() {
            console.log('Testing simple save...');
            const testLocation = 'Test Museum ' + Date.now();
            const testContent = 'This is a test audioguide content.\nIt has multiple lines.\nAnd some stops.';
            
            const saved = saveToLibrary(testLocation, 'English', 'test', 3, testContent);
            
            if (saved) {
                alert('Test guide saved! ID: ' + saved.id + '\nCheck the Library page.');
            } else {
                alert('Test save failed! Check console for errors.');
            }
        }

        function checkStorage() {
            console.log('=== STORAGE CHECK ===');
            const guides = localStorage.getItem('cloudguide_audioguides');
            if (guides) {
                try {
                    const parsed = JSON.parse(guides);
                    console.log('Guides in storage:', parsed.length);
                    console.log('First guide:', parsed[0]);
                    alert(`Found ${parsed.length} guides in storage`);
                } catch (e) {
                    console.error('Error parsing guides:', e);
                    alert('Storage corrupted! Use Clear Storage to fix.');
                }
            } else {
                console.log('No guides in storage');
                alert('No guides found in storage');
            }
        }

        function clearStorage() {
            if (confirm('This will delete all saved audioguides. Continue?')) {
                localStorage.removeItem('cloudguide_audioguides');
                alert('Storage cleared');
                console.log('Storage cleared');
            }
        }

        function showStorageInfo() {
            const used = new Blob(Object.values(localStorage)).size;
            const limit = 5 * 1024 * 1024; // 5MB typical limit
            const percent = (used / limit * 100).toFixed(2);
            alert(`Storage used: ${(used/1024).toFixed(2)} KB (${percent}% of typical 5MB limit)`);
        }
    </script>
</body>
</html>
