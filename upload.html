<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudGuide - Upload to CMS</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("ymvZgpxy0bqrS-p3c");
        })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #4a5568;
            line-height: 1.6;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .header-inner {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 35px;
            transition: opacity 0.3s;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-links a {
            color: #718096;
            text-decoration: none;
            font-weight: 400;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #48bb78;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(45, 55, 72, 0.85), rgba(45, 55, 72, 0.85)), 
                        url('https://s.cloudguide.me/m/files/e966ce00-be17-4370-ae0a-c0d90e3cce18.jpg') center/cover;
            color: white;
            padding: 50px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .hero-subtitle {
            font-size: 0.95em;
            font-weight: 300;
            opacity: 0.9;
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 35px;
        }

        /* Selection Grid */
        .selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .selection-panel {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            background: #f7fafc;
        }

        .selection-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guide-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .guide-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .guide-item:hover {
            background: #f0fff4;
        }

        .guide-item.selected {
            background: #d1fae5;
            border-left: 3px solid #48bb78;
        }

        .guide-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .guide-item-meta {
            font-size: 13px;
            color: #718096;
        }

        .no-items {
            padding: 40px;
            text-align: center;
            color: #a0aec0;
        }

        /* Form Section */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .required {
            color: #e53e3e;
        }

        .form-element {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #f7fafc;
            transition: all 0.3s;
        }

        .form-element:focus {
            outline: none;
            border-color: #48bb78;
            background: white;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.15);
        }

        select.form-element {
            cursor: pointer;
        }

        textarea.form-element {
            min-height: 120px;
            resize: vertical;
        }

        /* Content Status */
        .content-status {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .content-status.ready {
            background: #f0fff4;
            border-color: #48bb78;
        }

        .content-status.partial {
            background: #fffaf0;
            border-color: #f6ad55;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            font-size: 20px;
        }

        .status-text {
            flex: 1;
        }

        .status-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
        }

        .status-value {
            font-size: 12px;
            color: #718096;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-link {
            background: transparent;
            color: #667eea;
            text-decoration: underline;
            padding: 0;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
        }

        /* Progress */
        .progress-container {
            display: none;
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.5s;
        }

        /* Messages */
        .message {
            display: none;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .message.success {
            background: #f0fff4;
            border: 1px solid #48bb78;
            color: #22543d;
        }

        .message.error {
            background: #fff5f5;
            border: 1px solid #e53e3e;
            color: #742a2a;
        }

        .message.active {
            display: block;
        }

        @media (max-width: 768px) {
            .selection-grid {
                grid-template-columns: 1fr;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .status-grid {
                grid-template-columns: 1fr;
            }
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <a href="https://www.cloudguide.me" target="_blank">
                        <img src="https://s.cloudguide.me/m/files/f9111279-27c8-4c3f-b586-dc705899f1ee.png" alt="CloudGuide logo">
                    </a>
                </div>
                <nav>
                    <ul class="nav-links">
                        <li><a href="index.html">GENERATOR</a></li>
                        <li><a href="library.html">LIBRARY</a></li>
                        <li><a href="audio.html">AUDIO</a></li>
                        <li><a href="upload.html" class="active">UPLOAD</a></li>
                        <li><a href="about.html">ABOUT</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Upload to CloudGuide CMS</h1>
            <p class="hero-subtitle">Submit your audioguides for professional upload to your CMS account</p>
        </section>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Selection Grid -->
            <div class="selection-grid">
                <!-- Script Selection -->
                <div class="selection-panel">
                    <h3 class="selection-title">📝 Select Script</h3>
                    <div class="guide-list" id="scriptList">
                        <div class="no-items">Loading scripts...</div>
                    </div>
                </div>

                <!-- Audio Selection -->
                <div class="selection-panel">
                    <h3 class="selection-title">🎵 Select Audio Files</h3>
                    <div class="guide-list" id="audioList">
                        <div class="no-items">Select a script first</div>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button class="btn btn-secondary" id="generateAudioBtn" style="display: none;" onclick="goToAudioPage()">
                            Generate Audio Files
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Status -->
            <div class="content-status" id="contentStatus">
                <h3 style="margin-bottom: 15px;">📁 Content Status</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-icon" id="scriptIcon">⚪</span>
                        <div class="status-text">
                            <div class="status-label">Script</div>
                            <div class="status-value" id="scriptStatus">No script selected</div>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-icon" id="audioIcon">⚪</span>
                        <div class="status-text">
                            <div class="status-label">Audio</div>
                            <div class="status-value" id="audioStatus">No audio selected</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-grid">
                <!-- Left Column -->
                <div>
                    <div class="form-group">
                        <label>CMS Account Email <span class="required">*</span></label>
                        <input type="email" id="cmsEmail" class="form-element" 
                               placeholder="your-account@cloudguide.me" required>
                        <small style="color: #718096; font-size: 12px;">
                            Enter the email associated with your CloudGuide CMS account
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Institution Name <span class="required">*</span></label>
                        <input type="text" id="institutionName" class="form-element" 
                               placeholder="e.g., National Art Museum" required>
                    </div>

                    <div class="form-group">
                        <label>Exhibition Name <span class="required">*</span></label>
                        <input type="text" id="exhibitionName" class="form-element" 
                               placeholder="e.g., Permanent Collection" required>
                    </div>

                    <div class="form-group">
                        <label>Guide Name <span class="required">*</span></label>
                        <input type="text" id="guideName" class="form-element" 
                               placeholder="e.g., Complete Audio Tour" required>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <div class="form-group">
                        <label>Language</label>
                        <select id="guideLanguage" class="form-element">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Italian">Italian</option>
                            <option value="Portuguese">Portuguese</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Japanese">Japanese</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Contact Phone (Optional)</label>
                        <input type="tel" id="contactPhone" class="form-element" 
                               placeholder="+1 234 567 8900">
                    </div>

                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="additionalNotes" class="form-element" 
                                  placeholder="Any special instructions or requirements..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-primary submit-btn" id="submitBtn" onclick="submitToCloudGuide()">
                📤 Submit for Upload to CMS
            </button>

            <!-- Progress -->
            <div class="progress-container" id="progressContainer">
                <div style="text-align: center; font-weight: 600;">Processing your submission...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div style="text-align: center; font-size: 13px; color: #718096;" id="progressStatus">
                    Preparing...
                </div>
            </div>

            <!-- Success Message -->
            <div class="message success" id="successMessage">
                <h3 style="margin-bottom: 15px;">✅ Upload Request Submitted Successfully!</h3>
                <p style="margin-bottom: 15px;">
                    Your content has been sent to CloudGuide. Please allow up to 24 hours for it to appear in your account.
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>Next Steps:</strong>
                </p>
                <ol style="margin-left: 20px;">
                    <li>Check your email for confirmation</li>
                    <li>Log in to your CloudGuide CMS account</li>
                    <li>Navigate to the PUBLISH section</li>
                    <li>Upload images for the best visitor experience</li>
                    <li>Review and publish your audioguide</li>
                </ol>
                <p style="margin-top: 15px; font-size: 13px; color: #718096;">
                    A confirmation email has been sent to the address provided.
                </p>
            </div>

            <!-- Error Message -->
            <div class="message error" id="errorMessage">
                <h3 style="margin-bottom: 15px;">❌ Submission Error</h3>
                <p id="errorText">There was an error submitting your content. Please try again.</p>
            </div>
        </div>
    </div>

    <script>
        let selectedScript = null;
        let selectedAudio = [];
        let allGuides = [];
        let currentGuideId = null;
        let fullGuideContent = '';
        let vercelAudioUrls = [];

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Upload page initialized');
            loadLibrary();
            
            // Check if returning from audio page
            const savedFormData = localStorage.getItem('uploadFormData');
            if (savedFormData) {
                const data = JSON.parse(savedFormData);
                document.getElementById('cmsEmail').value = data.cmsEmail || '';
                document.getElementById('institutionName').value = data.institutionName || '';
                document.getElementById('exhibitionName').value = data.exhibitionName || '';
                document.getElementById('guideName').value = data.guideName || '';
                localStorage.removeItem('uploadFormData');
            }
        });

        // Load audioguides from library
        function loadLibrary() {
            console.log('Loading library...');
            
            allGuides = JSON.parse(localStorage.getItem('cloudguide_audioguides') || '[]');
            console.log('Found', allGuides.length, 'guides in library');
            
            const scriptList = document.getElementById('scriptList');
            
            if (allGuides.length === 0) {
                scriptList.innerHTML = `
                    <div class="no-items">
                        <div style="font-size: 2em; margin-bottom: 10px;">📚</div>
                        <p>No audioguides in library</p>
                        <a href="index.html" style="color: #48bb78;">Generate your first audioguide →</a>
                    </div>
                `;
                return;
            }
            
            // Display all guides as scripts
            scriptList.innerHTML = allGuides.map(guide => {
                const title = guide.title || guide.location || 'Untitled';
                const stops = guide.stops || '?';
                const lang = guide.language || 'English';
                const wordCount = guide.content ? guide.content.split(/\s+/).length : 0;
                
                return `
                    <div class="guide-item" onclick="selectScript('${guide.id}')">
                        <div class="guide-item-title">${title}</div>
                        <div class="guide-item-meta">
                            ${lang} • ${stops} stops • ${wordCount.toLocaleString()} words
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select a script
        async function selectScript(guideId) {
            console.log('Selecting script:', guideId);
            
            // Clear previous selections
            document.querySelectorAll('#scriptList .guide-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Find and select the clicked item
            const items = document.querySelectorAll('#scriptList .guide-item');
            items.forEach((item, index) => {
                if (allGuides[index].id === guideId) {
                    item.classList.add('selected');
                }
            });
            
            // Set selected script
            selectedScript = allGuides.find(g => g.id === guideId);
            currentGuideId = guideId;
            fullGuideContent = selectedScript.content || '';
            
            // Update status
            updateContentStatus();
            
            // Pre-fill guide name if empty
            if (!document.getElementById('guideName').value && selectedScript) {
                document.getElementById('guideName').value = selectedScript.title || selectedScript.location || 'Audio Tour';
            }
            
            // Set language
            if (selectedScript.language) {
                document.getElementById('guideLanguage').value = selectedScript.language;
            }
            
            // Load audio files for this guide
            await loadAudioFiles(guideId);
        }

        // Load audio files for selected guide
        async function loadAudioFiles(guideId) {
            console.log('Loading audio files for guide:', guideId);
            
            selectedAudio = [];
            vercelAudioUrls = [];
            
            const audioListDiv = document.getElementById('audioList');
            
            // Check localStorage for audio metadata
            const audioMeta = localStorage.getItem(`audio_meta_${guideId}`);
            
            if (audioMeta) {
                try {
                    const parsedMeta = JSON.parse(audioMeta);
                    console.log('Found', parsedMeta.length, 'audio files in metadata');
                    
                    // Display audio files
                    if (parsedMeta.length > 0) {
                        audioListDiv.innerHTML = parsedMeta.map((file, index) => {
                            // Check if it's a cloud URL
                            const isCloudUrl = file.url && file.url.startsWith('http');
                            if (isCloudUrl) {
                                selectedAudio.push(file);
                                vercelAudioUrls.push(file.url);
                            }
                            
                            return `
                                <div class="guide-item ${isCloudUrl ? 'selected' : ''}" 
                                     onclick="toggleAudioFile(${index})"
                                     data-index="${index}">
                                    <div class="guide-item-title">
                                        ${file.name || file.chapter || `Stop ${index + 1}`}
                                    </div>
                                    <div class="guide-item-meta">
                                        ${file.language || 'Audio'} • 
                                        ${isCloudUrl ? '☁️ Cloud Storage' : '💾 Local Only'}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        // Update button visibility
                        document.getElementById('generateAudioBtn').style.display = 'none';
                    } else {
                        showNoAudioMessage();
                    }
                    
                } catch (e) {
                    console.error('Error parsing audio metadata:', e);
                    showNoAudioMessage();
                }
            } else {
                // Try to fetch from Vercel Blob
                try {
                    const response = await fetch(`/api/upload-audio?guideId=${guideId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.files && data.files.length > 0) {
                            console.log('Found', data.files.length, 'files in Vercel Blob');
                            
                            audioListDiv.innerHTML = data.files.map((file, index) => {
                                selectedAudio.push(file);
                                vercelAudioUrls.push(file.url);
                                
                                return `
                                    <div class="guide-item selected" 
                                         onclick="toggleAudioFile(${index})"
                                         data-index="${index}">
                                        <div class="guide-item-title">
                                            ${file.pathname || `Audio ${index + 1}`}
                                        </div>
                                        <div class="guide-item-meta">
                                            ☁️ Vercel Blob Storage
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            document.getElementById('generateAudioBtn').style.display = 'none';
                        } else {
                            showNoAudioMessage();
                        }
                    } else {
                        showNoAudioMessage();
                    }
                } catch (error) {
                    console.log('Could not fetch from Vercel:', error);
                    showNoAudioMessage();
                }
            }
            
            updateContentStatus();
        }

        // Show no audio message
        function showNoAudioMessage() {
            document.getElementById('audioList').innerHTML = `
                <div class="no-items">
                    <div style="font-size: 2em; margin-bottom: 10px;">🎵</div>
                    <p>No audio files generated yet</p>
                </div>
            `;
            document.getElementById('generateAudioBtn').style.display = 'inline-block';
        }

        // Toggle audio file selection
        function toggleAudioFile(index) {
            // This is just for UI feedback - all cloud files are auto-selected
            console.log('Audio file clicked:', index);
        }

        // Update content status display
        function updateContentStatus() {
            const statusDiv = document.getElementById('contentStatus');
            
            // Update script status
            const scriptIcon = document.getElementById('scriptIcon');
            const scriptStatus = document.getElementById('scriptStatus');
            
            if (selectedScript) {
                scriptIcon.textContent = '✅';
                const wordCount = fullGuideContent.split(/\s+/).filter(w => w.length > 0).length;
                scriptStatus.textContent = `${selectedScript.title || 'Selected'} (${wordCount.toLocaleString()} words)`;
            } else {
                scriptIcon.textContent = '⚪';
                scriptStatus.textContent = 'No script selected';
            }
            
            // Update audio status
            const audioIcon = document.getElementById('audioIcon');
            const audioStatus = document.getElementById('audioStatus');
            
            if (vercelAudioUrls.length > 0) {
                audioIcon.textContent = '✅';
                audioStatus.textContent = `${vercelAudioUrls.length} files in cloud storage`;
                statusDiv.className = 'content-status ready';
            } else if (selectedAudio.length > 0) {
                audioIcon.textContent = '⚠️';
                audioStatus.textContent = `${selectedAudio.length} local files (need cloud upload)`;
                statusDiv.className = 'content-status partial';
            } else {
                audioIcon.textContent = '⚪';
                audioStatus.textContent = 'No audio files';
                statusDiv.className = 'content-status partial';
            }
        }

        // Go to audio page
        function goToAudioPage() {
            if (currentGuideId) {
                // Save form data
                localStorage.setItem('uploadFormData', JSON.stringify({
                    cmsEmail: document.getElementById('cmsEmail').value,
                    institutionName: document.getElementById('institutionName').value,
                    exhibitionName: document.getElementById('exhibitionName').value,
                    guideName: document.getElementById('guideName').value
                }));
                
                window.location.href = `audio.html?id=${currentGuideId}`;
            }
        }

        // Submit to CloudGuide
        async function submitToCloudGuide() {
            console.log('Starting submission...');
            
            // Hide previous messages
            document.getElementById('successMessage').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');
            
            // Validate required fields
            const cmsEmail = document.getElementById('cmsEmail').value.trim();
            const institutionName = document.getElementById('institutionName').value.trim();
            const exhibitionName = document.getElementById('exhibitionName').value.trim();
            const guideName = document.getElementById('guideName').value.trim();
            const additionalNotes = document.getElementById('additionalNotes').value.trim();
            const contactPhone = document.getElementById('contactPhone').value.trim();
            
            if (!cmsEmail || !institutionName || !exhibitionName || !guideName) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!selectedScript || !fullGuideContent) {
                alert('Please select a script from your library');
                return;
            }
            
            // Check for audio
            if (vercelAudioUrls.length === 0) {
                const proceed = confirm(
                    'No audio files in cloud storage.\n\n' +
                    'Do you want to:\n' +
                    '• OK - Submit script only\n' +
                    '• Cancel - Generate audio first'
                );
                
                if (!proceed) {
                    goToAudioPage();
                    return;
                }
            }
            
            // Disable submit button
            document.getElementById('submitBtn').disabled = true;
            
            // Show progress
            document.getElementById('progressContainer').classList.add('active');
            updateProgress(10, 'Preparing submission...');
            
            try {
                updateProgress(30, 'Processing content...');
                
                const guideTitle = selectedScript.title || selectedScript.location || 'Untitled Guide';
                const wordCount = fullGuideContent.split(/\s+/).filter(w => w.length > 0).length;
                
                // Format audio links as HTML for EmailJS template
                let audioLinksHtml = '';
                let audioLinksText = '';
                
                if (vercelAudioUrls.length > 0) {
                    console.log('Formatting audio URLs for email:', vercelAudioUrls);
                    
                    // HTML format for the template
                    audioLinksHtml = '<h3>Audio Files (Vercel Cloud Storage)</h3><ol>';
                    vercelAudioUrls.forEach((url, index) => {
                        const fileName = selectedAudio[index]?.name || 
                                       selectedAudio[index]?.pathname || 
                                       `Stop ${index + 1}`;
                        audioLinksHtml += `<li><strong>${fileName}</strong><br>`;
                        audioLinksHtml += `<a href="${url}" target="_blank">${url}</a></li><br>`;
                    });
                    audioLinksHtml += '</ol>';
                    audioLinksHtml += `<p><strong>Total Audio Files:</strong> ${vercelAudioUrls.length}</p>`;
                    audioLinksHtml += '<p><strong>Storage:</strong> Vercel Blob (Permanent URLs)</p>';
                    
                    // Plain text version as backup
                    audioLinksText = vercelAudioUrls.map((url, index) => 
                        `Stop ${index + 1}: ${url}`
                    ).join('\n');
                } else {
                    audioLinksHtml = '<p>No audio files generated yet</p>';
                    audioLinksText = 'No audio files';
                }
                
                updateProgress(50, 'Formatting content...');
                
                // Prepare email parameters
                const emailParams = {
                    to_email: 'content@cloudguide.me',
                    from_email: cmsEmail,
                    institution_name: institutionName,
                    exhibition_name: exhibitionName,
                    guide_name: guideName,
                    language: document.getElementById('guideLanguage').value,
                    contact_phone: contactPhone || 'Not provided',
                    guide_title: guideTitle,
                    guide_location: selectedScript.location || 'Unknown',
                    guide_stops: selectedScript.stops || 'Unknown',
                    word_count: wordCount,
                    audio_count: vercelAudioUrls.length,
                    audio_links: audioLinksText,  // Plain text version
                    audio_links_html: audioLinksHtml,  // HTML version for template
                    guide_content: fullGuideContent,
                    additional_notes: additionalNotes || 'None',
                    submission_date: new Date().toLocaleString(),
                    guide_id: currentGuideId,
                    storage_type: vercelAudioUrls.length > 0 ? 'Vercel Blob Storage' : 'Script Only'
                };
                
                updateProgress(70, 'Sending to CloudGuide...');
                console.log('Sending email with audio links HTML:', audioLinksHtml);
                
                // Send email using EmailJS
                await emailjs.send('service_sqyvtda', 'template_90y0ndk', emailParams);
                
                updateProgress(100, 'Submission complete!');
                console.log('Email sent successfully!');
                
                // Show success message
                document.getElementById('successMessage').classList.add('active');
                document.getElementById('successMessage').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Reset form after delay
                setTimeout(() => {
                    resetForm();
                }, 5000);
                
            } catch (error) {
                console.error('Submission error:', error);
                
                document.getElementById('errorMessage').classList.add('active');
                document.getElementById('errorText').textContent = 
                    'There was an error submitting your content: ' + error.message;
                
                document.getElementById('progressContainer').classList.remove('active');
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Update progress bar
        function updateProgress(percentage, status) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressStatus').textContent = status;
        }

        // Reset form
        function resetForm() {
            document.getElementById('cmsEmail').value = '';
            document.getElementById('institutionName').value = '';
            document.getElementById('exhibitionName').value = '';
            document.getElementById('guideName').value = '';
            document.getElementById('additionalNotes').value = '';
            document.getElementById('contactPhone').value = '';
            
            selectedScript = null;
            selectedAudio = [];
            currentGuideId = null;
            fullGuideContent = '';
            vercelAudioUrls = [];
            
            loadLibrary();
            updateContentStatus();
            
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('submitBtn').disabled = false;
        }
    </script>
</body>
</html>
